<?php\n/**\n * SUT寰俊灏忕▼搴忕鐞嗙被\n *\n * 澶勭悊鎻掍欢鐨勫悗鍙扮鐞嗗姛鑳斤紝鍖呮嫭璁剧疆椤甸潰銆佽彍鍗曠瓑\n *\n * @package SUT_WeChat_Mini\n */\n\nif ( ! defined( 'ABSPATH' ) ) {\n    exit;\n}\n\n/**\n * SUT_WeChat_Mini_Admin 绫?
 */\nclass SUT_WeChat_Mini_Admin {\n    \n    /**\n     * 绠＄悊绫诲疄渚?
     *\n     * @var SUT_WeChat_Mini_Admin\n     */\n    private static $instance = null;\n    \n    /**\n     * 鎻掍欢璁剧疆閫夐」鍚嶇О\n     *\n     * @var string\n     */\n    private $option_name = 'sut_wechat_mini_settings';\n    \n    /**\n     * 鏋勯€犲嚱鏁?
     */\n    public function __construct() {\n        $this->init();\n    }\n    \n    /**\n     * 鑾峰彇鍗曚緥瀹炰緥\n     *\n     * @return SUT_WeChat_Mini_Admin\n     */\n    public static function get_instance() {\n        if ( null === self::$instance ) {\n            self::$instance = new self();\n        }\n        return self::$instance;\n    }\n    \n\n    \n    /**\n     * 娓叉煋璁剧疆椤甸潰\n     */\n    public function render_settings_page() {\n        // 妫€鏌ョ敤鎴锋潈闄?
        if ( ! current_user_can( 'manage_options' ) ) {\n            wp_die( __( '鎮ㄦ病鏈夎冻澶熺殑鏉冮檺璁块棶姝ら〉闈€?, 'sut-wechat-mini' ) );\n        }\n        \n        // 鑾峰彇褰撳墠璁剧疆鍊?
        $settings = get_option( 'sut_wechat_mini_settings', array() );\n        \n        // 杈撳嚭椤甸潰鏍囬鍜岃鏄?
        ?>\n        <div class="wrap">\n            <h1 class="wp-heading-inline"><?php _e( '寰俊灏忕▼搴忚缃?, 'sut-wechat-mini' ); ?></h1>\n            <p class="description"><?php _e( '閰嶇疆鎮ㄧ殑寰俊灏忕▼搴忕浉鍏宠缃€?, 'sut-wechat-mini' ); ?></p>\n            \n            <?php if ( isset( $_GET['settings-updated'] ) ) : ?>\n                <div class="notice notice-success is-dismissible">\n                    <p><?php _e( '璁剧疆宸蹭繚瀛樸€?, 'sut-wechat-mini' ); ?></p>\n                </div>\n            <?php endif; ?>\n            \n            <div class="sut-wechat-mini-content">\n                <form method="post" action="options.php">\n                    <?php settings_fields( 'sut_wechat_mini_settings_group' ); ?>\n                    <?php $this->render_settings_form( $settings ); ?>\n                    <?php submit_button(); ?>\n                </form>\n            </div>\n        </div>\n        <?php\n    }\n    \n    /**\n     * 娓叉煋鐢ㄦ埛椤甸潰\n     */\n    public function render_users_page() {\n        // 妫€鏌ョ敤鎴锋潈闄?
        if ( ! current_user_can( 'manage_options' ) ) {\n            wp_die( __( '鎮ㄦ病鏈夎冻澶熺殑鏉冮檺璁块棶姝ら〉闈€?, 'sut-wechat-mini' ) );\n        }\n        \n        // 杈撳嚭椤甸潰鏍囬鍜岃鏄?
        ?>\n        <div class="wrap">\n            <h1 class="wp-heading-inline"><?php _e( '鐢ㄦ埛绠＄悊', 'sut-wechat-mini' ); ?></h1>\n            <p class="description"><?php _e( '绠＄悊寰俊灏忕▼搴忕殑鐢ㄦ埛銆?, 'sut-wechat-mini' ); ?></p>\n            \n            <div class="sut-wechat-mini-content">\n                <?php $this->render_users_table(); ?>\n            </div>\n        </div>\n        <?php\n    }\n    \n    /**\n     * 娓叉煋璁㈠崟椤甸潰\n     */\n    public function render_orders_page() {\n        // 妫€鏌ョ敤鎴锋潈闄?
        if ( ! current_user_can( 'manage_options' ) ) {\n            wp_die( __( '鎮ㄦ病鏈夎冻澶熺殑鏉冮檺璁块棶姝ら〉闈€?, 'sut-wechat-mini' ) );\n        }\n        \n        // 杈撳嚭椤甸潰鏍囬鍜岃鏄?
        ?>\n        <div class="wrap">\n            <h1 class="wp-heading-inline"><?php _e( '璁㈠崟绠＄悊', 'sut-wechat-mini' ); ?></h1>\n            <p class="description"><?php _e( '绠＄悊寰俊灏忕▼搴忕殑璁㈠崟銆?, 'sut-wechat-mini' ); ?></p>\n            \n            <div class="sut-wechat-mini-content">\n                <?php $this->render_orders_table(); ?>\n            </div>\n        </div>\n        <?php\n    }\n    \n    /**\n     * 娓叉煋璁剧疆琛ㄥ崟\n     *\n     * @param array $settings 褰撳墠璁剧疆鍊?
     */\n    private function render_settings_form( $settings ) {\n        $all_settings = $this->get_all_settings();\n        \n        // 妫€鏌ユ槸鍚︽湁楂樹紭鍏堢骇鐨勫繀濉瓧娈?
        $has_high_priority_fields = false;\n        foreach ( $all_settings as $section ) {\n            foreach ( $section['fields'] as $field ) {\n                if ( isset( $field['priority'] ) && $field['priority'] === 'high' ) {\n                    $has_high_priority_fields = true;\n                    break 2;\n                }\n            }\n        }\n        \n        // 杈撳嚭璁剧疆琛ㄥ崟\n        foreach ( $all_settings as $section_id => $section ) {\n            ?>\n            <div class="sut-wechat-mini-section">\n                <h2 class="sut-wechat-mini-section-title"><span class="dashicons <?php echo esc_attr( $section['icon'] ); ?>"></span> <?php echo esc_html( $section['title'] ); ?></h2>\n                <p class="sut-wechat-mini-section-desc"><?php echo esc_html( $section['desc'] ); ?></p>\n                \n                <table class="form-table">\n                    <?php foreach ( $section['fields'] as $field ) : ?>\n                        <tr<?php echo isset( $field['priority'] ) && $field['priority'] === 'high' ? ' class="sut-wechat-mini-field-high-priority"' : ''; ?>>\n                            <th scope="row">\n                                <label for="<?php echo esc_attr( $field['id'] ); ?>"><?php echo esc_html( $field['title'] ); ?></label>\n                                <?php if ( isset( $field['required'] ) && $field['required'] ) : ?>\n                                    <span class="description required">*</span>\n                                <?php endif; ?>\n                            </th>\n                            <td>\n                                <?php $this->render_field( $field, isset( $settings[$field['id']] ) ? $settings[$field['id']] : ( isset( $field['default'] ) ? $field['default'] : '' ) ); ?>\n                                <?php if ( isset( $field['desc'] ) ) : ?>\n                                    <p class="description"><?php echo esc_html( $field['desc'] ); ?></p>\n                                <?php endif; ?>\n                            </td>\n                        </tr>\n                    <?php endforeach; ?>\n                </table>\n            </div>\n            <?php\n        }\n        \n        // 鏄剧ず蹇呭～瀛楁璇存槑\n        if ( $has_high_priority_fields ) {\n            ?>\n            <p class="sut-wechat-mini-required-note">\n                <span class="description required">*</span> <?php _e( '琛ㄧず蹇呭～瀛楁', 'sut-wechat-mini' ); ?>\n            </p>\n            <?php\n        }\n    }\n    \n    /**\n     * 鏍规嵁瀛楁绫诲瀷娓叉煋鐩稿簲鐨勫瓧娈?
     *\n     * @param array $field 瀛楁閰嶇疆\n     * @param mixed $value 瀛楁鍊?
     */\n    private function render_field( $field, $value ) {\n        switch ( $field['type'] ) {\n            case 'text':\n                $this->render_input_field( $field, $value );\n                break;\n            case 'textarea':\n                $this->render_textarea_field( $field, $value );\n                break;\n            case 'checkbox':\n                $this->render_checkbox_field( $field, $value );\n                break;\n            case 'select':\n                $this->render_select_field( $field, $value );\n                break;\n            case 'radio':\n                $this->render_radio_field( $field, $value );\n                break;\n            case 'image':\n                $this->render_image_field( $field, $value );\n                break;\n            case 'color':\n                $this->render_color_field( $field, $value );\n                break;\n            case 'editor':\n                 $this->render_editor_field( $field, $value );\n                 break;\n             default:\n                 $this->render_input_field( $field, $value );\n         }\n     }\n    \n    /**\n     * 鍒濆鍖栫鐞嗗姛鑳?
     */\n    private function init() {\n        // 娣诲姞鑿滃崟椤?
        add_action( 'admin_menu', array( $this, 'add_admin_menu' ) );\n        \n        // 娉ㄥ唽璁剧疆\n        add_action( 'admin_init', array( $this, 'register_settings' ) );\n        \n        // 娣诲姞鎻掍欢璁剧疆閾炬帴\n        add_filter( 'plugin_action_links_' . SUT_WECHAT_MINI_PLUGIN_BASENAME, array( $this, 'add_plugin_links' ) );\n        \n        // 鍔犺浇绠＄悊鑴氭湰鍜屾牱寮?
        add_action( 'admin_enqueue_scripts', array( $this, 'enqueue_admin_scripts' ) );\n    }\n    \n    /**\n     * 鍦ㄦ彃浠跺垪琛ㄩ〉闈㈡坊鍔犻澶栫殑閾炬帴\n     *\n     * @param array $links 鐜版湁閾炬帴鏁扮粍\n     * @return array 淇敼鍚庣殑閾炬帴鏁扮粍\n     */\n    public function add_plugin_links( $links ) {\n        // 娣诲姞璁剧疆閾炬帴\n        $settings_link = '<a href="admin.php?page=sut-wechat-mini">' . __( '璁剧疆', 'sut-wechat-mini' ) . '</a>';\n        array_unshift( $links, $settings_link );\n        \n        return $links;\n    }\n    \n    /**\n     * 娣诲姞绠＄悊鑿滃崟椤?
     */\n    public function add_admin_menu() {\n        // 娣诲姞涓昏彍鍗曢」\n        add_menu_page(\n            __( 'SUT寰俊灏忕▼搴?, 'sut-wechat-mini' ),\n            __( '寰俊灏忕▼搴?, 'sut-wechat-mini' ),\n            'manage_options',\n            'sut-wechat-mini',\n            array( $this, 'render_settings_page' ),\n            'dashicons-smartphone',\n            80\n        );\n        \n        // 娣诲姞瀛愯彍鍗曢」\n        add_submenu_page(\n            'sut-wechat-mini',\n            __( '鍩虹璁剧疆', 'sut-wechat-mini' ),\n            __( '鍩虹璁剧疆', 'sut-wechat-mini' ),\n            'manage_options',\n            'sut-wechat-mini',\n            array( $this, 'render_settings_page' )\n        );\n        \n        add_submenu_page(\n            'sut-wechat-mini',\n            __( '鐢ㄦ埛绠＄悊', 'sut-wechat-mini' ),\n            __( '鐢ㄦ埛绠＄悊', 'sut-wechat-mini' ),\n            'manage_options',\n            'sut-wechat-mini-users',\n            array( $this, 'render_users_page' )\n        );\n        \n        add_submenu_page(\n            'sut-wechat-mini',\n            __( '璁㈠崟绠＄悊', 'sut-wechat-mini' ),\n            __( '璁㈠崟绠＄悊', 'sut-wechat-mini' ),\n            'manage_options',\n            'sut-wechat-mini-orders',\n            array( $this, 'render_orders_page' )\n        );\n        \n        add_submenu_page(\n            'sut-wechat-mini',\n            __( '鏁版嵁缁熻', 'sut-wechat-mini' ),\n            __( '鏁版嵁缁熻', 'sut-wechat-mini' ),\n            'manage_options',\n            'sut-wechat-mini-stats',\n            array( $this, 'render_stats_page' )\n        );\n    }\n    \n    /**\n     * 娓叉煋杈撳叆妗嗗瓧娈?
     *\n     * @param array $field 瀛楁閰嶇疆\n     * @param mixed $value 瀛楁鍊?
     */\n    private function render_input_field( $field, $value ) {\n        // 鍒濆鍖栧睘鎬ф暟缁勶紝璁剧疆榛樿鍊?
        $attrs = array(\n            'type' => $field['type'],\n            'class' => 'regular-text',\n        );\n        \n        // 濡傛灉瀛樺湪鑷畾涔夊睘鎬ф暟缁勶紝鍚堝苟瀹冧滑\n        if ( isset( $field['attrs'] ) && is_array( $field['attrs'] ) ) {\n            $attrs = array_merge( $attrs, $field['attrs'] );\n        }\n        \n        // 澶勭悊鐗瑰畾灞炴€?
        if ( isset( $field['placeholder'] ) ) {\n            $attrs['placeholder'] = $field['placeholder'];\n        }\n        \n        if ( isset( $field['readonly'] ) && $field['readonly'] ) {\n            $attrs['readonly'] = 'readonly';\n        }\n        \n        if ( isset( $field['disabled'] ) && $field['disabled'] ) {\n            $attrs['disabled'] = 'disabled';\n        }\n        \n        if ( isset( $field['min'] ) ) {\n            $attrs['min'] = $field['min'];\n        }\n        \n        if ( isset( $field['max'] ) ) {\n            $attrs['max'] = $field['max'];\n        }\n        \n        if ( isset( $field['step'] ) ) {\n            $attrs['step'] = $field['step'];\n        }\n        \n        // 鏋勫缓灞炴€у瓧绗︿覆\n        $attr_str = '';\n        foreach ( $attrs as $attr_name => $attr_value ) {\n            $attr_str .= sprintf( ' %s="%s"', esc_attr( $attr_name ), esc_attr( $attr_value ) );\n        }\n        \n        // 杈撳嚭杈撳叆妗?
        printf(\n            '<input id="sut_wechat_mini_field_%s" name="%s[%s]" value="%s"%s />',\n            esc_attr( $field['id'] ),\n            esc_attr( $this->option_name ),\n            esc_attr( $field['id'] ),\n            esc_attr( $value ),\n            $attr_str\n        );\n    }\n    \n    /**\n     * 娓叉煋鏂囨湰鍩熷瓧娈?
     *\n     * @param array $field 瀛楁閰嶇疆\n     * @param mixed $value 瀛楁鍊?
     */\n    private function render_textarea_field( $field, $value ) {\n        // 鍒濆鍖栧睘鎬ф暟缁勶紝璁剧疆榛樿鍊?
        $attrs = array(\n            'class' => 'large-text',\n        );\n        \n        // 濡傛灉瀛樺湪鑷畾涔夊睘鎬ф暟缁勶紝鍚堝苟瀹冧滑\n        if ( isset( $field['attrs'] ) && is_array( $field['attrs'] ) ) {\n            $attrs = array_merge( $attrs, $field['attrs'] );\n        }\n        \n        // 澶勭悊鐗瑰畾灞炴€?
        if ( isset( $field['placeholder'] ) ) {\n            $attrs['placeholder'] = $field['placeholder'];\n        }\n        \n        if ( isset( $field['readonly'] ) && $field['readonly'] ) {\n            $attrs['readonly'] = 'readonly';\n        }\n        \n        if ( isset( $field['disabled'] ) && $field['disabled'] ) {\n            $attrs['disabled'] = 'disabled';\n        }\n        \n        // 澶勭悊琛屾暟鍜屽垪鏁?
        $rows = isset( $attrs['rows'] ) ? $attrs['rows'] : ( isset( $field['rows'] ) ? $field['rows'] : 5 );\n        $cols = isset( $attrs['cols'] ) ? $attrs['cols'] : 50;\n        unset( $attrs['rows'], $attrs['cols'] );\n        \n        // 鏋勫缓灞炴€у瓧绗︿覆\n        $attr_str = '';\n        foreach ( $attrs as $attr_name => $attr_value ) {\n            $attr_str .= sprintf( ' %s="%s"', esc_attr( $attr_name ), esc_attr( $attr_value ) );\n        }\n        \n        // 杈撳嚭鏂囨湰鍩?
        printf(\n            '<textarea id="sut_wechat_mini_field_%s" name="%s[%s]" rows="%s" cols="%s"%s>%s</textarea>',\n            esc_attr( $field['id'] ),\n            esc_attr( $this->option_name ),\n            esc_attr( $field['id'] ),\n            esc_attr( $rows ),\n            esc_attr( $cols ),\n            $attr_str,\n            esc_textarea( $value )\n        );\n    }\n    \n    /**\n     * 娓叉煋澶嶉€夋瀛楁\n     *\n     * @param array $field 瀛楁閰嶇疆\n     * @param mixed $value 瀛楁鍊?
     */\n    private function render_checkbox_field( $field, $value ) {\n        // 鑾峰彇鍩虹灞炴€?
        $id = $field['id'];\n        $checked = checked( $value, 1, false );\n        \n        // 鏋勫缓灞炴€ф暟缁?
        $attrs = array();\n        \n        // 妫€鏌ユ槸鍚︽湁鑷畾涔夊睘鎬ф暟缁?
        if ( isset( $field['attrs'] ) && is_array( $field['attrs'] ) ) {\n            $attrs = $field['attrs'];\n        }\n        \n        // 澶勭悊绂佺敤灞炴€?
        if ( isset( $field['disabled'] ) && $field['disabled'] ) {\n            $attrs['disabled'] = 'disabled';\n        }\n        \n        // 鏋勫缓灞炴€у瓧绗︿覆\n        $attr_str = '';\n        foreach ( $attrs as $attr_name => $attr_value ) {\n            $attr_str .= sprintf( ' %s="%s"', esc_attr( $attr_name ), esc_attr( $attr_value ) );\n        }\n        \n        // 杈撳嚭澶嶉€夋\n        printf(\n            '<input type="checkbox" id="sut_wechat_mini_field_%s" name="%s[%s]" value="1" %s%s />',\n            esc_attr( $id ),\n            esc_attr( $this->option_name ),\n            esc_attr( $id ),\n            $checked,\n            $attr_str\n        );\n    }\n    \n    /**\n     * 娓叉煋涓嬫媺閫夋嫨瀛楁\n     *\n     * @param array $field 瀛楁閰嶇疆\n     * @param mixed $value 瀛楁鍊?
     */\n    private function render_select_field( $field, $value ) {\n        // 楠岃瘉閫夐」鏁扮粍鏄惁瀛樺湪\n        if ( ! isset( $field['options'] ) || ! is_array( $field['options'] ) ) {\n            return;\n        }\n        \n        // 鑾峰彇鍩虹灞炴€?
        $id = $field['id'];\n        $options = $field['options'];\n        \n        // 鍒濆鍖栧睘鎬ф暟缁勶紝璁剧疆榛樿鍊?
        $attrs = array(\n            'class' => 'regular-text',\n        );\n        \n        // 濡傛灉瀛樺湪鑷畾涔夊睘鎬ф暟缁勶紝鍚堝苟瀹冧滑\n        if ( isset( $field['attrs'] ) && is_array( $field['attrs'] ) ) {\n            $attrs = array_merge( $attrs, $field['attrs'] );\n        }\n        \n        // 澶勭悊澶氶€夊睘鎬?
        $multiple = false;\n        if ( ( isset( $attrs['multiple'] ) && $attrs['multiple'] ) || \n             ( isset( $field['multiple'] ) && $field['multiple'] ) ) {\n            $multiple = true;\n            $attrs['multiple'] = 'multiple';\n        }\n        \n        // 澶勭悊绂佺敤灞炴€?
        if ( isset( $field['disabled'] ) && $field['disabled'] ) {\n            $attrs['disabled'] = 'disabled';\n        }\n        \n        // 鏋勫缓灞炴€у瓧绗︿覆\n        $attr_str = '';\n        foreach ( $attrs as $attr_name => $attr_value ) {\n            $attr_str .= sprintf( ' %s="%s"', esc_attr( $attr_name ), esc_attr( $attr_value ) );\n        }\n        \n        // 杈撳嚭閫夋嫨妗嗗紑濮嬫爣绛?
        printf(\n            '<select id="sut_wechat_mini_field_%s" name="%s[%s]%s" %s>',\n            esc_attr( $id ),\n            esc_attr( $this->option_name ),\n            esc_attr( $id ),\n            $multiple ? '[]' : '',\n            $attr_str\n        );\n        \n        // 杈撳嚭閫夐」\n        foreach ( $options as $option_value => $option_label ) {\n            if ( is_array( $value ) ) {\n                $selected = selected( in_array( $option_value, $value ), true, false );\n            } else {\n                $selected = selected( $value, $option_value, false );\n            }\n            \n            printf(\n                '<option value="%s" %s>%s</option>',\n                esc_attr( $option_value ),\n                $selected,\n                esc_html( $option_label )\n            );\n        }\n        \n        echo '</select>';\n    }\n    \n    /**\n     * 娓叉煋鍗曢€夋瀛楁\n     *\n     * @param array $field 瀛楁閰嶇疆\n     * @param mixed $value 瀛楁鍊?
     */\n    private function render_radio_field( $field, $value ) {\n        // 楠岃瘉閫夐」鏁扮粍鏄惁瀛樺湪\n        if ( ! isset( $field['options'] ) || ! is_array( $field['options'] ) ) {\n            return;\n        }\n        \n        $id = $field['id'];\n        $options = $field['options'];\n        $i = 0;\n        \n        foreach ( $options as $option_value => $option_label ) {\n            // 鐢熸垚鍞竴鐨勯€夐」ID\n            $option_id = sprintf( '%s_%s', $id, $i );\n            $checked = checked( $value, $option_value, false );\n            \n            // 鏋勫缓灞炴€ф暟缁?
            $atts = array(\n                'type' => 'radio',\n                'id' => 'sut_wechat_mini_field_' . $option_id,\n                'name' => $this->option_name . '[' . $id . ']',\n                'value' => $option_value,\n                'checked' => $checked,\n            );\n            \n            // 澶勭悊绂佺敤灞炴€?
            if ( isset( $field['disabled'] ) && $field['disabled'] ) {\n                $atts['disabled'] = 'disabled';\n            }\n            \n            // 浣跨敤printf鏍煎紡鍖栬緭鍑哄崟閫夋\n            printf(\n                '<label><input type="radio" id="%s" name="%s" value="%s" %s%s /> %s</label><br/>',\n                esc_attr( $atts['id'] ),\n                esc_attr( $atts['name'] ),\n                esc_attr( $atts['value'] ),\n                $atts['checked'],\n                isset( $atts['disabled'] ) ? ' disabled="disabled"' : '',\n                esc_html( $option_label )\n            );\n            \n            $i++;\n        }\n    }\n    \n    /**\n     * 娓叉煋鍥剧墖涓婁紶瀛楁\n     *\n     * @param array $field 瀛楁閰嶇疆\n     * @param mixed $value 瀛楁鍊?
     */\n    private function render_image_field( $field, $value ) {\n        $image_url = '';\n        if ( $value ) {\n            $image_url = wp_get_attachment_url( $value );\n        }\n        \n        $html = '<div class="sut-wechat-mini-image-upload">';\n        $html .= '<input type="hidden" id="sut_wechat_mini_field_' . $field['id'] . '" name="' . $this->option_name . '[' . $field['id'] . ']" value="' . esc_attr( $value ) . '" />';\n        $html .= '<div class="image-preview">';\n        if ( $image_url ) {\n            $html .= '<img src="' . esc_url( $image_url ) . '" style="max-width: 200px; max-height: 200px;" />';\n        }\n        $html .= '</div>';\n        $html .= '<button type="button" class="button sut-wechat-mini-upload-image">' . __( '涓婁紶鍥剧墖', 'sut-wechat-mini' ) . '</button>';\n        $html .= '<button type="button" class="button sut-wechat-mini-remove-image" ' . ( $value ? '' : 'style="display: none;"' ) . '>' . __( '绉婚櫎鍥剧墖', 'sut-wechat-mini' ) . '</button>';\n        $html .= '</div>';\n        \n        echo $html;\n    }\n    \n    /**\n     * 娓叉煋棰滆壊閫夋嫨瀛楁\n     *\n     * @param array $field 瀛楁閰嶇疆\n     * @param mixed $value 瀛楁鍊?
     */\n    private function render_color_field( $field, $value ) {\n        // 纭繚鍔犺浇棰滆壊閫夋嫨鍣?
        wp_enqueue_style( 'wp-color-picker' );\n        wp_enqueue_script( 'wp-color-picker' );\n        \n        $atts = array(\n            'type' => 'text',\n            'id' => 'sut_wechat_mini_field_' . $field['id'],\n            'name' => $this->option_name . '[' . $field['id'] . ']',\n            'value' => esc_attr( $value ),\n            'class' => 'sut-wechat-mini-color-picker',\n            'data-default-color' => isset( $field['default'] ) ? $field['default'] : '',\n        );\n        \n        $html = '<input ';\n        foreach ( $atts as $key => $val ) {\n            $html .= $key . '="' . $val . '" ';\n        }\n        $html .= '/>';\n        \n        echo $html;\n    }\n    \n    /**\n     * 娓叉煋缂栬緫鍣ㄥ瓧娈?
     *\n     * @param array $field 瀛楁閰嶇疆\n     * @param mixed $value 瀛楁鍊?
     */\n    private function render_editor_field( $field, $value ) {\n        $editor_args = array(\n            'textarea_name' => $this->option_name . '[' . $field['id'] . ']',\n            'textarea_rows' => isset( $field['rows'] ) ? $field['rows'] : 10,\n            'media_buttons' => isset( $field['media_buttons'] ) ? $field['media_buttons'] : true,\n            'tinymce' => isset( $field['tinymce'] ) ? $field['tinymce'] : true,\n            'quicktags' => isset( $field['quicktags'] ) ? $field['quicktags'] : true,\n        );\n        \n        wp_editor( $value, 'sut_wechat_mini_field_' . $field['id'], $editor_args );\n    }\n    \n    /**\n     * 娓叉煋鐢ㄦ埛琛ㄦ牸\n     */\n    private function render_users_table() {\n        global $wpdb;\n        \n        $table_name = $wpdb->prefix . 'sut_wechat_mini_users';\n        \n        // 鑾峰彇鐢ㄦ埛鍒楄〃\n        $users = $wpdb->get_results( "SELECT * FROM $table_name ORDER BY create_time DESC" );\n        \n        if ( empty( $users ) ) {\n            echo '<div class="notice notice-info"><p>' . __( '鏆傛棤寰俊灏忕▼搴忕敤鎴?, 'sut-wechat-mini' ) . '</p></div>';\n            return;\n        }\n        \n        ?>\n        <table class="widefat fixed striped">\n            <thead>\n                <tr>\n                    <th scope="col" class="manage-column column-primary"><?php _e( '寰俊鏄电О', 'sut-wechat-mini' ); ?></th>\n                    <th scope="col" class="manage-column"><?php _e( '寰俊澶村儚', 'sut-wechat-mini' ); ?></th>\n                    <th scope="col" class="manage-column"><?php _e( 'OpenID', 'sut-wechat-mini' ); ?></th>\n                    <th scope="col" class="manage-column"><?php _e( 'UnionID', 'sut-wechat-mini' ); ?></th>\n                    <th scope="col" class="manage-column"><?php _e( '鍏宠仈鐢ㄦ埛', 'sut-wechat-mini' ); ?></th>\n                    <th scope="col" class="manage-column"><?php _e( '鍒涘缓鏃堕棿', 'sut-wechat-mini' ); ?></th>\n                    <th scope="col" class="manage-column"><?php _e( '鎿嶄綔', 'sut-wechat-mini' ); ?></th>\n                </tr>\n            </thead>\n            <tbody>\n                <?php foreach ( $users as $user ) : ?>\n                    <tr>\n                        <td class="column-primary">\n                            <?php echo esc_html( $user->nickname ); ?>\n                            <button type="button" class="toggle-row"><span class="screen-reader-text"><?php _e( '鏄剧ず鏇村璇︽儏', 'sut-wechat-mini' ); ?></span></button>\n                        </td>\n                        <td>\n                            <?php if ( $user->avatar_url ) : ?>\n                                <img src="<?php echo esc_url( $user->avatar_url ); ?>" style="width: 40px; height: 40px; border-radius: 50%;" />\n                            <?php endif; ?>\n                        </td>\n                        <td>\n                            <?php echo esc_html( $user->openid ); ?>\n                        </td>\n                        <td>\n                            <?php echo esc_html( $user->unionid ? $user->unionid : '-' ); ?>\n                        </td>\n                        <td>\n                            <?php if ( $user->wp_user_id ) : ?>\n                                <?php $wp_user = get_user_by( 'id', $user->wp_user_id ); ?>\n                                <?php if ( $wp_user ) : ?>\n                                    <a href="user-edit.php?user_id=<?php echo $user->wp_user_id; ?>"><?php echo esc_html( $wp_user->user_login ); ?></a>\n                                <?php endif; ?>\n                            <?php else : ?>\n                                -\n                            <?php endif; ?>\n                        </td>\n                        <td>\n                            <?php echo esc_html( $user->create_time ); ?>\n                        </td>\n                        <td>\n                            <a href="#" class="sut-wechat-mini-delete-user" data-id="<?php echo $user->id; ?>"><?php _e( '鍒犻櫎', 'sut-wechat-mini' ); ?></a>\n                        </td>\n                    </tr>\n                <?php endforeach; ?>\n            </tbody>\n        </table>\n        <?php\n    }\n    \n    /**\n     * 娓叉煋璁㈠崟琛ㄦ牸\n     */\n    private function render_orders_table() {\n        if ( ! class_exists( 'WooCommerce' ) ) {\n            echo '<div class="notice notice-error"><p>' . __( 'WooCommerce鏈縺娲伙紝鏃犳硶鏌ョ湅璁㈠崟', 'sut-wechat-mini' ) . '</p></div>';\n            return;\n        }\n        \n        // 鑾峰彇璁㈠崟鍒楄〃\n        $args = array(\n            'post_type' => 'shop_order',\n            'post_status' => array_keys( wc_get_order_statuses() ),\n            'posts_per_page' => -1,\n            'orderby' => 'date',\n            'order' => 'DESC',\n        );\n        \n        $orders_query = new WP_Query( $args );\n        \n        if ( ! $orders_query->have_posts() ) {\n            echo '<div class="notice notice-info"><p>' . __( '鏆傛棤璁㈠崟', 'sut-wechat-mini' ) . '</p></div>';\n            return;\n        }\n        \n        ?>\n        <table class="widefat fixed striped">\n            <thead>\n                <tr>\n                    <th scope="col" class="manage-column column-primary"><?php _e( '璁㈠崟缂栧彿', 'sut-wechat-mini' ); ?></th>\n                    <th scope="col" class="manage-column"><?php _e( '璁㈠崟鎬婚', 'sut-wechat-mini' ); ?></th>\n                    <th scope="col" class="manage-column"><?php _e( '璁㈠崟鐘舵€?, 'sut-wechat-mini' ); ?></th>\n                    <th scope="col" class="manage-column"><?php _e( '瀹㈡埛淇℃伅', 'sut-wechat-mini' ); ?></th>\n                    <th scope="col" class="manage-column"><?php _e( '鍒涘缓鏃堕棿', 'sut-wechat-mini' ); ?></th>\n                    <th scope="col" class="manage-column"><?php _e( '鎿嶄綔', 'sut-wechat-mini' ); ?></th>\n                </tr>\n            </thead>\n            <tbody>\n                <?php while ( $orders_query->have_posts() ) : $orders_query->the_post(); ?>\n                    <?php $order = wc_get_order( get_the_ID() ); ?>\n                    <tr>\n                        <td class="column-primary">\n                            <a href="post.php?post=<?php echo get_the_ID(); ?>&action=edit"><?php echo esc_html( $order->get_order_number() ); ?></a>\n                            <button type="button" class="toggle-row"><span class="screen-reader-text"><?php _e( '鏄剧ず鏇村璇︽儏', 'sut-wechat-mini' ); ?></span></button>\n                        </td>\n                        <td>\n                            <?php echo esc_html( $order->get_formatted_order_total() ); ?>\n                        </td>\n                        <td>\n                            <mark class="order-status status-<?php echo sanitize_title( $order->get_status() ); ?>"><span><?php echo esc_html( wc_get_order_status_name( $order->get_status() ) ); ?></span></mark>\n                        </td>\n                        <td>\n                            <?php if ( $order->get_billing_first_name() || $order->get_billing_last_name() ) : ?>\n                                <?php echo esc_html( $order->get_billing_first_name() . ' ' . $order->get_billing_last_name() ); ?><br/>\n                            <?php endif; ?>\n                            <?php if ( $order->get_billing_phone() ) : ?>\n                                <?php echo esc_html( $order->get_billing_phone() ); ?><br/>\n                            <?php endif; ?>\n                            <?php if ( $order->get_billing_email() ) : ?>\n                                <?php echo esc_html( $order->get_billing_email() ); ?><br/>\n                            <?php endif; ?>\n                        </td>\n                        <td>\n                            <?php echo esc_html( $order->get_date_created()->format( 'Y-m-d H:i:s' ) ); ?>\n                        </td>\n                        <td>\n                            <a href="post.php?post=<?php echo get_the_ID(); ?>&action=edit" class="button button-small"><?php _e( '缂栬緫', 'sut-wechat-mini' ); ?></a>\n                        </td>\n                    </tr>\n                <?php endwhile; ?>\n            </tbody>\n        </table>\n        <?php\n        \n        wp_reset_postdata();\n    }\n    \n    /**\n     * 娓叉煋鏁版嵁缁熻椤甸潰\n     */\n    public function render_stats_page() {\n        // 妫€鏌ョ敤鎴锋潈闄?
        if ( ! current_user_can( 'manage_options' ) ) {\n            wp_die( __( '鎮ㄦ病鏈夎冻澶熺殑鏉冮檺璁块棶姝ら〉闈€?, 'sut-wechat-mini' ) );\n        }\n        \n        // 杈撳嚭椤甸潰鏍囬鍜岃鏄?
        ?>\n        <div class="wrap">\n            <h1 class="wp-heading-inline"><?php _e( '鏁版嵁缁熻', 'sut-wechat-mini' ); ?></h1>\n            <p class="description"><?php _e( '鏌ョ湅鎮ㄧ殑寰俊灏忕▼搴忎娇鐢ㄧ粺璁℃暟鎹€?, 'sut-wechat-mini' ); ?></p>\n            \n            <div class="sut-wechat-mini-content">\n                <?php $this->render_stats_dashboard(); ?>\n            </div>\n        </div>\n        <?php\n    }\n    \n    /**\n     * 娓叉煋鏁版嵁缁熻浠〃鐩?
     */\n    private function render_stats_dashboard() {\n        global $wpdb;\n        \n        // 鑾峰彇缁熻鏁版嵁\n        $table_name = $wpdb->prefix . 'sut_wechat_mini_users';\n        $total_users = $wpdb->get_var( "SELECT COUNT(*) FROM $table_name" );\n        \n        $total_orders = 0;\n        $total_sales = 0;\n        if ( class_exists( 'WooCommerce' ) ) {\n            $total_orders = wc_get_orders( array(\n                'status' => array_keys( wc_get_order_statuses() ),\n                'return' => 'ids',\n            ) );\n            $total_orders = count( $total_orders );\n            \n            $total_sales = $wpdb->get_var( "\n                SELECT SUM(meta_value)\n                FROM $wpdb->postmeta\n                WHERE meta_key = '_order_total'\n                AND post_id IN (\n                    SELECT ID\n                    FROM $wpdb->posts\n                    WHERE post_type = 'shop_order'\n                    AND post_status IN ('wc-processing', 'wc-completed')\n                )\n            " );\n        }\n        \n        $total_views = get_option( 'sut_wechat_mini_total_views', 0 );\n        \n        ?>\n        <div class="sut-wechat-mini-stats-cards">\n            <div class="stat-card">\n                <div class="stat-value"><?php echo number_format( $total_users ); ?></div>\n                <div class="stat-label"><?php _e( '灏忕▼搴忕敤鎴?, 'sut-wechat-mini' ); ?></div>\n            </div>\n            \n            <?php if ( class_exists( 'WooCommerce' ) ) : ?>\n                <div class="stat-card">\n                    <div class="stat-value"><?php echo number_format( $total_orders ); ?></div>\n                    <div class="stat-label"><?php _e( '璁㈠崟鎬绘暟', 'sut-wechat-mini' ); ?></div>\n                </div>\n                \n                <div class="stat-card">\n                    <div class="stat-value"><?php echo wc_price( $total_sales ); ?></div>\n                    <div class="stat-label"><?php _e( '閿€鍞€婚', 'sut-wechat-mini' ); ?></div>\n                </div>\n            <?php endif; ?>\n            \n            <div class="stat-card">\n                <div class="stat-value"><?php echo number_format( $total_views ); ?></div>\n                <div class="stat-label"><?php _e( '椤甸潰娴忚閲?, 'sut-wechat-mini' ); ?></div>\n            </div>\n        </div>\n        \n        <div class="sut-wechat-mini-stats-charts">\n            <div class="chart-container">\n                <h3><?php _e( '鐢ㄦ埛澧為暱瓒嬪娍', 'sut-wechat-mini' ); ?></h3>\n                <div id="users-chart" style="height: 300px;"></div>\n            </div>\n            \n            <?php if ( class_exists( 'WooCommerce' ) ) : ?>\n                <div class="chart-container">\n                    <h3><?php _e( '閿€鍞瓒嬪娍', 'sut-wechat-mini' ); ?></h3>\n                    <div id="sales-chart" style="height: 300px;"></div>\n                </div>\n            <?php endif; ?>\n        </div>\n        <?php\n    }\n    \n    /**\n     * 鑾峰彇鎵€鏈夎缃粨鏋?
     *\n     * @return array 璁剧疆缁撴瀯鏁扮粍\n     */\n    private function get_all_settings() {\n        return array(\n            'basic' => array(\n                'title' => '鍩虹璁剧疆',\n                'desc'  => '寰俊灏忕▼搴忕殑鍩烘湰閰嶇疆淇℃伅',\n                'icon'  => 'dashicons-admin-generic',\n                'fields' => array(\n                    array(\n                        'id'      => 'appid',\n                        'title'   => '灏忕▼搴廇ppID',\n                        'type'    => 'text',\n                        'desc'    => '寰俊灏忕▼搴忕殑AppID锛岀敤浜庤韩浠介獙璇?,\n                        'default' => '',\n                        'attrs'   => array(\n                            'placeholder' => '璇疯緭鍏ュ皬绋嬪簭AppID',\n                            'class'       => 'regular-text sut-wechat-mini-input-primary'\n                        ),\n                        'required' => true,\n                        'priority' => 'high'\n                    ),\n                    array(\n                        'id'      => 'appsecret',\n                        'title'   => '灏忕▼搴廇ppSecret',\n                        'type'    => 'text',\n                        'desc'    => '寰俊灏忕▼搴忕殑AppSecret锛岀敤浜嶢PI璋冪敤',\n                        'default' => '',\n                        'attrs'   => array(\n                            'placeholder' => '璇疯緭鍏ュ皬绋嬪簭AppSecret',\n                            'class'       => 'regular-text'\n                        ),\n                        'required' => true,\n                        'priority' => 'high'\n                    ),\n                    array(\n                        'id'      => 'status',\n                        'title'   => '鍚敤鐘舵€?,\n                        'type'    => 'checkbox',\n                        'desc'    => '鏄惁鍚敤灏忕▼搴忓姛鑳?,\n                        'default' => 1,\n                        'priority' => 'high'\n                    ),\n                    array(\n                        'id'      => 'qrcode',\n                        'title'   => '灏忕▼搴忎簩缁寸爜',\n                        'type'    => 'image',\n                        'desc'    => '灏忕▼搴忎簩缁寸爜鍥剧墖锛岀敤浜庡湪鍓嶅彴鏄剧ず',\n                        'default' => '',\n                        'attrs'   => array(\n                            'button_text' => '涓婁紶浜岀淮鐮?\n                        )\n                    )\n                )\n            ),\n            'payment' => array(\n                'title' => '鏀粯璁剧疆',\n                'desc'  => '寰俊鏀粯鐩稿叧閰嶇疆',\n                'icon'  => 'dashicons-cart',\n                'fields' => array(\n                    array(\n                        'id'      => 'mch_id',\n                        'title'   => '寰俊鏀粯鍟嗘埛鍙?,\n                        'type'    => 'text',\n                        'desc'    => '寰俊鏀粯鍟嗘埛鍙凤紝鐢ㄤ簬寰俊鏀粯鍔熻兘',\n                        'default' => '',\n                        'attrs'   => array(\n                            'placeholder' => '璇疯緭鍏ュ井淇℃敮浠樺晢鎴峰彿',\n                            'class'       => 'regular-text'\n                        )\n                    ),\n                    array(\n                        'id'      => 'api_key',\n                        'title'   => '寰俊鏀粯API瀵嗛挜',\n                        'type'    => 'text',\n                        'desc'    => '寰俊鏀粯API瀵嗛挜锛岀敤浜庣鍚嶉獙璇?,\n                        'default' => '',\n                        'attrs'   => array(\n                            'placeholder' => '璇疯緭鍏ュ井淇℃敮浠楢PI瀵嗛挜',\n                            'class'       => 'regular-text'\n                        )\n                    ),\n                    array(\n                        'id'      => 'payment_status',\n                        'title'   => '鍚敤鏀粯鍔熻兘',\n                        'type'    => 'checkbox',\n                        'desc'    => '鏄惁鍚敤寰俊鏀粯鍔熻兘',\n                        'default' => 1\n                    )\n                )\n            ),\n            'message' => array(\n                'title' => '娑堟伅閫氱煡',\n                'desc'  => '寰俊灏忕▼搴忔秷鎭€氱煡閰嶇疆',\n                'icon'  => 'dashicons-email',\n                'fields' => array(\n                    array(\n                        'id'      => 'template_id',\n                        'title'   => '娑堟伅閫氱煡妯℃澘ID',\n                        'type'    => 'text',\n                        'desc'    => '鐢ㄤ簬璁㈠崟閫氱煡绛夋秷鎭殑妯℃澘ID',\n                        'default' => '',\n                        'attrs'   => array(\n                            'placeholder' => '璇疯緭鍏ユā鏉縄D',\n                            'class'       => 'regular-text'\n                        )\n                    ),\n                    array(\n                        'id'      => 'message_status',\n                        'title'   => '鍚敤娑堟伅閫氱煡',\n                        'type'    => 'checkbox',\n                        'desc'    => '鏄惁鍚敤娑堟伅閫氱煡鍔熻兘',\n                        'default' => 1\n                    )\n                )\n            ),\n            'display' => array(\n                'title' => '鏄剧ず璁剧疆',\n                'desc'  => '灏忕▼搴忓唴瀹规樉绀虹浉鍏抽厤缃?,\n                'icon'  => 'dashicons-format-image',\n                'fields' => array(\n                    array(\n                        'id'      => 'display_items_per_page',\n                        'title'   => '姣忛〉鏄剧ず鏁伴噺',\n                        'type'    => 'number',\n                        'desc'    => '灏忕▼搴忎腑姣忛〉鏄剧ず鐨勫唴瀹规暟閲?,\n                        'default' => 10,\n                        'attrs'   => array(\n                            'min'   => 1,\n                            'max'   => 100,\n                            'step'  => 1,\n                            'class' => 'small-text'\n                        )\n                    ),\n                    array(\n                        'id'      => 'display_cover_image',\n                        'title'   => '鏄剧ず灏侀潰鍥?,\n                        'type'    => 'checkbox',\n                        'desc'    => '鏄惁鍦ㄥ垪琛ㄤ腑鏄剧ず鍐呭灏侀潰鍥?,\n                        'default' => 1\n                    ),\n                    array(\n                        'id'      => 'theme_color',\n                        'title'   => '涓婚棰滆壊',\n                        'type'    => 'color',\n                        'desc'    => '灏忕▼搴忕殑涓婚棰滆壊',\n                        'default' => '#1DA57A'\n                    ),\n                    array(\n                        'id'      => 'custom_css',\n                        'title'   => '鑷畾涔塁SS',\n                        'type'    => 'textarea',\n                        'desc'    => '娣诲姞鑷畾涔塁SS鏍峰紡鏉ヨ嚜瀹氫箟灏忕▼搴忓瑙?,\n                        'default' => '',\n                        'attrs'   => array(\n                            'rows'  => 5,\n                            'cols'  => 50,\n                            'placeholder' => '渚嬪锛歜ody { color: #333; }',\n                            'class' => 'code'\n                        )\n                    )\n                )\n            ),\n            'user_management' => array(\n                'title' => '鐢ㄦ埛绠＄悊',\n                'desc'  => '寰俊灏忕▼搴忕敤鎴风鐞嗙浉鍏抽厤缃?,\n                'icon'  => 'dashicons-users',\n                'fields' => array(\n                    array(\n                        'id'      => 'user_sync_status',\n                        'title'   => '鍚敤鐢ㄦ埛鍚屾',\n                        'type'    => 'checkbox',\n                        'desc'    => '鏄惁鍚敤寰俊鐢ㄦ埛涓嶹ordPress鐢ㄦ埛鐨勫悓姝ュ姛鑳?,\n                        'default' => 1\n                    ),\n                    array(\n                        'id'      => 'auto_register_users',\n                        'title'   => '鑷姩娉ㄥ唽鐢ㄦ埛',\n                        'type'    => 'checkbox',\n                        'desc'    => '鏂扮殑寰俊鐢ㄦ埛棣栨鐧诲綍鏃舵槸鍚﹁嚜鍔ㄦ敞鍐屼负WordPress鐢ㄦ埛',\n                        'default' => 1\n                    ),\n                    array(\n                        'id'      => 'default_user_role',\n                        'title'   => '榛樿鐢ㄦ埛瑙掕壊',\n                        'type'    => 'select',\n                        'desc'    => '鑷姩娉ㄥ唽鐨勭敤鎴烽粯璁よ鑹?,\n                        'default' => 'subscriber',\n                        'options' => $this->get_user_roles_options(),\n                        'attrs'   => array(\n                            'class' => 'regular-text'\n                        )\n                    ),\n                    array(\n                        'id'      => 'display_user_avatar',\n                        'title'   => '鏄剧ず鐢ㄦ埛澶村儚',\n                        'type'    => 'checkbox',\n                        'desc'    => '鏄惁鍦ㄧ敤鎴峰垪琛ㄤ腑鏄剧ず寰俊澶村儚',\n                        'default' => 1\n                    ),\n                    array(\n                        'id'      => 'user_data_retention',\n                        'title'   => '鐢ㄦ埛鏁版嵁淇濈暀鏈熼檺',\n                        'type'    => 'number',\n                        'desc'    => '鏈椿璺冪敤鎴锋暟鎹繚鐣欑殑澶╂暟锛?琛ㄧず姘镐箙淇濈暀锛?,\n                        'default' => 0,\n                        'attrs'   => array(\n                            'min'   => 0,\n                            'step'  => 1,\n                            'class' => 'small-text'\n                        )\n                    )\n                )\n            ),\n            'order_management' => array(\n                'title' => '璁㈠崟绠＄悊',\n                'desc'  => '寰俊灏忕▼搴忚鍗曠鐞嗙浉鍏抽厤缃?,\n                'icon'  => 'dashicons-list-alt',\n                'fields' => array(\n                    array(\n                        'id'      => 'order_sync_status',\n                        'title'   => '鍚敤璁㈠崟鍚屾',\n                        'type'    => 'checkbox',\n                        'desc'    => '鏄惁鍚敤灏忕▼搴忚鍗曚笌WordPress/WooCommerce璁㈠崟鐨勫悓姝?,\n                        'default' => 1\n                    ),\n                    array(\n                        'id'      => 'auto_update_order_status',\n                        'title'   => '鑷姩鏇存柊璁㈠崟鐘舵€?,\n                        'type'    => 'checkbox',\n                        'desc'    => '鏀粯鎴愬姛鍚庢槸鍚﹁嚜鍔ㄦ洿鏂拌鍗曠姸鎬佷负宸插畬鎴?,\n                        'default' => 1\n                    ),\n                    array(\n                        'id'      => 'order_notification_admin',\n                        'title'   => '绠＄悊鍛樿鍗曢€氱煡',\n                        'type'    => 'checkbox',\n                        'desc'    => '鏂拌鍗曞垱寤烘椂鏄惁閫氱煡绠＄悊鍛?,\n                        'default' => 1\n                    ),\n                    array(\n                        'id'      => 'order_notification_user',\n                        'title'   => '鐢ㄦ埛璁㈠崟閫氱煡',\n                        'type'    => 'checkbox',\n                        'desc'    => '璁㈠崟鐘舵€佹洿鏂版椂鏄惁閫氱煡鐢ㄦ埛',\n                        'default' => 1\n                    ),\n                    array(\n                        'id'      => 'order_cancellation_period',\n                        'title'   => '璁㈠崟鍙栨秷鏈熼檺',\n                        'type'    => 'number',\n                        'desc'    => '鏈敮浠樿鍗曡嚜鍔ㄥ彇娑堢殑灏忔椂鏁帮紙0琛ㄧず涓嶈嚜鍔ㄥ彇娑堬級',\n                        'default' => 24,\n                        'attrs'   => array(\n                            'min'   => 0,\n                            'step'  => 1,\n                            'class' => 'small-text'\n                        )\n                    ),\n                    array(\n                        'id'      => 'order_export_format',\n                        'title'   => '璁㈠崟瀵煎嚭鏍煎紡',\n                        'type'    => 'select',\n                        'desc'    => '璁㈠崟鏁版嵁瀵煎嚭鐨勯粯璁ゆ牸寮?,\n                        'default' => 'csv',\n                        'options' => array(\n                            'csv' => 'CSV鏍煎紡',\n                            'excel' => 'Excel鏍煎紡',\n                            'pdf' => 'PDF鏍煎紡'\n                        ),\n                        'attrs'   => array(\n                            'class' => 'regular-text'\n                        )\n                    )\n                )\n            )\n        );\n    }\n    \n    /**\n     * 鑾峰彇鐢ㄦ埛瑙掕壊閫夐」\n     *\n     * @return array 鐢ㄦ埛瑙掕壊閫夐」\n     */\n    private function get_user_roles_options() {\n        global $wp_roles;\n        \n        if ( ! isset( $wp_roles ) ) {\n            $wp_roles = new WP_Roles();\n        }\n        \n        $roles = $wp_roles->get_names();\n        \n        return $roles;\n    }\n    \n    /**\n     * 鑾峰彇鏂囩珷绫诲瀷閫夐」\n     *\n     * @return array 鏂囩珷绫诲瀷閫夐」\n     */\n    private function get_post_types_options() {\n        $post_types = get_post_types( array( 'public' => true ), 'objects' );\n        $options = array();\n        \n        foreach ( $post_types as $post_type ) {\n            $options[$post_type->name] = $post_type->labels->name;\n        }\n        \n        return $options;\n    }\n    \n    /**\n     * 楠岃瘉鍜屾竻鐞嗚缃暟鎹?
     *\n     * @param array $input 杈撳叆鏁版嵁\n     * @return array 娓呯悊鍚庣殑鏁版嵁\n     */\n    public function sanitize_settings( $input ) {\n        $output = array();\n        \n        // 鑾峰彇鎵€鏈夎缃€夐」\n        $settings = $this->get_all_settings();\n        \n        // 楠岃瘉姣忎釜璁剧疆瀛楁\n        foreach ( $settings as $section_id => $section ) {\n            foreach ( $section['fields'] as $field ) {\n                $field_id = $field['id'];\n                \n                // 妫€鏌ュ瓧娈垫槸鍚﹀瓨鍦ㄤ簬杈撳叆涓?
                if ( isset( $input[$field_id] ) ) {\n                    // 鏍规嵁瀛楁绫诲瀷杩涜楠岃瘉\n                    switch ( $field['type'] ) {\n                        case 'text':\n                        case 'password':\n                        case 'email':\n                        case 'url':\n                            $output[$field_id] = sanitize_text_field( $input[$field_id] );\n                            break;\n                        case 'textarea':\n                            $output[$field_id] = sanitize_textarea_field( $input[$field_id] );\n                            break;\n                        case 'number':\n                            $output[$field_id] = intval( $input[$field_id] );\n                            break;\n                        case 'checkbox':\n                            $output[$field_id] = boolval( $input[$field_id] );\n                            break;\n                        case 'select':\n                        case 'radio':\n                            if ( isset( $field['options'] ) && is_array( $field['options'] ) ) {\n                                if ( isset( $field['multiple'] ) && $field['multiple'] ) {\n                                    $output[$field_id] = array();\n                                    if ( is_array( $input[$field_id] ) ) {\n                                        foreach ( $input[$field_id] as $value ) {\n                                            if ( array_key_exists( $value, $field['options'] ) ) {\n                                                $output[$field_id][] = $value;\n                                            }\n                                        }\n                                    }\n                                } else {\n                                    if ( array_key_exists( $input[$field_id], $field['options'] ) ) {\n                                        $output[$field_id] = $input[$field_id];\n                                    }\n                                }\n                            }\n                            break;\n                        case 'editor':\n                            $output[$field_id] = wp_kses_post( $input[$field_id] );\n                            break;\n                        case 'image':\n                            $output[$field_id] = intval( $input[$field_id] );\n                            break;\n                        default:\n                            $output[$field_id] = sanitize_text_field( $input[$field_id] );\n                    }\n                }\n            }\n        }\n        \n        return $output;\n    }\n    \n    /**\n     * 娉ㄥ唽璁剧疆閫夐」\n     */\n    public function register_settings() {\n        // 娉ㄥ唽璁剧疆缁勫拰瀛楁\n        register_setting(\n            'sut_wechat_mini_settings_group',\n            'sut_wechat_mini_settings',\n            array(\n                'type' => 'array',\n                'sanitize_callback' => array( $this, 'sanitize_settings' ),\n                'default' => array()\n            )\n        );\n    }\n    \n    /**\n     * 鍔犺浇绠＄悊鍛樿剼鏈拰鏍峰紡\n     */\n    public function enqueue_admin_scripts() {\n        // 鍙湪鎻掍欢椤甸潰鍔犺浇鑴氭湰\n        $screen = get_current_screen();\n        if ( $screen && $screen->id === 'toplevel_page_sut-wechat-mini' ) {\n            // 鍔犺浇鎻掍欢鏍峰紡\n            wp_enqueue_style(\n                'sut-wechat-mini-admin',\n                SUT_WECHAT_MINI_PLUGIN_URL . 'includes/admin/assets/css/admin.css',\n                array(),\n                SUT_WECHAT_MINI_VERSION\n            );\n            \n            // 鍔犺浇鎻掍欢鑴氭湰\n            wp_enqueue_script(\n                'sut-wechat-mini-admin',\n                SUT_WECHAT_MINI_PLUGIN_URL . 'includes/admin/assets/js/admin.js',\n                array( 'jquery' ),\n                SUT_WECHAT_MINI_VERSION,\n                true\n            );\n            \n            // 浼犻€掑繀瑕佺殑鏁版嵁鍒癑avaScript\n            wp_localize_script(\n                'sut-wechat-mini-admin',\n                'sutWechatMiniAdmin',\n                array(\n                    'ajax_url' => admin_url( 'admin-ajax.php' ),\n                    'nonce' => wp_create_nonce( 'sut-wechat-mini-nonce' ),\n                    'i18n' => array(\n                        'confirm_delete' => __( '纭畾瑕佸垹闄ゅ悧锛?, 'sut-wechat-mini' ),\n                        'delete_success' => __( '鍒犻櫎鎴愬姛', 'sut-wechat-mini' ),\n                        'delete_failed' => __( '鍒犻櫎澶辫触', 'sut-wechat-mini' )\n                    )\n                )\n            );\n        }\n    }\n}\n\n/**\n * 鍒濆鍖栫鐞嗗姛鑳?
 */\nfunction sut_wechat_mini_admin_init() {\n    SUT_WeChat_Mini_Admin::get_instance();\n}\n\nadd_action( 'admin_init', 'sut_wechat_mini_admin_init' );\n