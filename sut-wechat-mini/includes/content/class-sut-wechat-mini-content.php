<?php\n/**\n * SUT寰俊灏忕▼搴忓唴瀹圭鐞嗙被\n *\n * 澶勭悊WordPress鍐呭鐨勮幏鍙栧拰鏍煎紡鍖栵紝涓哄井淇″皬绋嬪簭鎻愪緵鏂囩珷銆佸垎绫汇€佹爣绛剧瓑鍐呭鏀寔\n *\n * @package SUT_WeChat_Mini\n */\n\nif ( ! defined( 'ABSPATH' ) ) {\n    exit;\n}\n\n/**\n * SUT_WeChat_Mini_Content 绫?
 */\nclass SUT_WeChat_Mini_Content {\n    \n    /**\n     * 鍐呭绠＄悊瀹炰緥\n     *\n     * @var SUT_WeChat_Mini_Content\n     */\n    private static $instance = null;\n    \n    /**\n     * 榛樿姣忛〉鏄剧ず鏁伴噺\n     *\n     * @var int\n     */\n    private $default_per_page = 10;\n    \n    /**\n     * 鏋勯€犲嚱鏁?
     */\n    public function __construct() {\n        $this->init();\n    }\n    \n    /**\n     * 鑾峰彇鍗曚緥瀹炰緥\n     *\n     * @return SUT_WeChat_Mini_Content\n     */\n    public static function get_instance() {\n        if ( null === self::$instance ) {\n            self::$instance = new self();\n        }\n        \n        return self::$instance;\n    }\n    \n    /**\n     * 鍒濆鍖栧唴瀹圭鐞?
     */\n    private function init() {\n        // 娉ㄥ唽鍐呭鐩稿叧鐨勯挬瀛?
        add_filter( 'sut_wechat_mini_api_routes', array( $this, 'add_content_routes' ) );\n    }\n    \n    /**\n     * 娣诲姞鍐呭鐩稿叧鐨凙PI璺敱\n     *\n     * @param array $routes 鐜版湁璺敱\n     * @return array 淇敼鍚庣殑璺敱\n     */\n    public function add_content_routes( $routes ) {\n        $routes['posts/search'] = array( 'callback' => array( $this, 'api_search_posts' ) );\n        $routes['posts/hot'] = array( 'callback' => array( $this, 'api_get_hot_posts' ) );\n        $routes['posts/latest'] = array( 'callback' => array( $this, 'api_get_latest_posts' ) );\n        $routes['posts/related/([0-9]+)'] = array( 'callback' => array( $this, 'api_get_related_posts' ) );\n        $routes['categories/([0-9]+)/posts'] = array( 'callback' => array( $this, 'api_get_posts_by_category' ) );\n        $routes['tags/([0-9]+)/posts'] = array( 'callback' => array( $this, 'api_get_posts_by_tag' ) );\n        $routes['pages'] = array( 'callback' => array( $this, 'api_get_pages' ) );\n        $routes['pages/([0-9]+)'] = array( 'callback' => array( $this, 'api_get_page' ) );\n        \n        return $routes;\n    }\n    \n    /**\n     * 鑾峰彇鏂囩珷鍒楄〃\n     *\n     * @param array $data 璇锋眰鏁版嵁\n     * @return array 鏂囩珷鍒楄〃\n     */\n    public function get_posts( $data ) {\n        // 鑾峰彇鍒嗛〉鍙傛暟\n        $page = isset( $data['page'] ) ? intval( $data['page'] ) : 1;\n        $per_page = isset( $data['per_page'] ) ? intval( $data['per_page'] ) : $this->default_per_page;\n        $offset = ( $page - 1 ) * $per_page;\n        \n        // 鏋勫缓鏌ヨ鍙傛暟\n        $args = array(\n            'post_type'      => 'post',\n            'post_status'    => 'publish',\n            'posts_per_page' => $per_page,\n            'offset'         => $offset,\n            'orderby'        => 'date',\n            'order'          => 'DESC',\n        );\n        \n        // 搴旂敤棰濆鐨勬煡璇㈡潯浠?
        $args = $this->apply_post_query_filters( $args, $data );\n        \n        // 鎵ц鏌ヨ\n        $query = new WP_Query( $args );\n        \n        // 鏍煎紡鍖栨枃绔犳暟鎹?
        $posts = array();\n        foreach ( $query->posts as $post ) {\n            $posts[] = $this->format_post( $post );\n        }\n        \n        // 鏋勫缓杩斿洖鏁版嵁\n        $result = array(\n            'code' => 0,\n            'message' => __( '鎴愬姛', 'sut-wechat-mini' ),\n            'data' => array(\n                'list' => $posts,\n                'total' => $query->found_posts,\n                'page' => $page,\n                'per_page' => $per_page,\n                'total_pages' => ceil( $query->found_posts / $per_page )\n            )\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 鑾峰彇鍗曠瘒鏂囩珷\n     *\n     * @param int $post_id 鏂囩珷ID\n     * @return array 鏂囩珷璇︽儏\n     */\n    public function get_post( $post_id ) {\n        // 鑾峰彇鏂囩珷\n        $post = get_post( $post_id );\n        \n        if ( ! $post || 'publish' !== $post->post_status ) {\n            return array(\n                'code' => 104,\n                'message' => __( '鏂囩珷涓嶅瓨鍦ㄦ垨鏈彂甯?, 'sut-wechat-mini' ),\n                'data' => array()\n            );\n        }\n        \n        // 澧炲姞鏂囩珷娴忚閲?
        $this->increase_post_views( $post_id );\n        \n        // 鏍煎紡鍖栨枃绔犳暟鎹?
        $formatted_post = $this->format_post( $post, true );\n        \n        // 鏋勫缓杩斿洖鏁版嵁\n        $result = array(\n            'code' => 0,\n            'message' => __( '鎴愬姛', 'sut-wechat-mini' ),\n            'data' => $formatted_post\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 鑾峰彇鍒嗙被鍒楄〃\n     *\n     * @param array $data 璇锋眰鏁版嵁\n     * @return array 鍒嗙被鍒楄〃\n     */\n    public function get_categories( $data ) {\n        // 鑾峰彇鍙傛暟\n        $parent = isset( $data['parent'] ) ? intval( $data['parent'] ) : 0;\n        $hide_empty = isset( $data['hide_empty'] ) ? boolval( $data['hide_empty'] ) : true;\n        \n        // 鏋勫缓鏌ヨ鍙傛暟\n        $args = array(\n            'taxonomy'   => 'category',\n            'parent'     => $parent,\n            'hide_empty' => $hide_empty,\n            'orderby'    => 'count',\n            'order'      => 'DESC',\n        );\n        \n        // 鑾峰彇鍒嗙被\n        $categories = get_categories( $args );\n        \n        // 鏍煎紡鍖栧垎绫绘暟鎹?
        $formatted_categories = array();\n        foreach ( $categories as $category ) {\n            $formatted_categories[] = array(\n                'id' => $category->term_id,\n                'name' => $category->name,\n                'slug' => $category->slug,\n                'description' => $category->description,\n                'parent' => $category->parent,\n                'count' => $category->count,\n            );\n        }\n        \n        // 鏋勫缓杩斿洖鏁版嵁\n        $result = array(\n            'code' => 0,\n            'message' => __( '鎴愬姛', 'sut-wechat-mini' ),\n            'data' => $formatted_categories\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 鑾峰彇鏍囩鍒楄〃\n     *\n     * @param array $data 璇锋眰鏁版嵁\n     * @return array 鏍囩鍒楄〃\n     */\n    public function get_tags( $data ) {\n        // 鑾峰彇鍙傛暟\n        $number = isset( $data['number'] ) ? intval( $data['number'] ) : 100;\n        $orderby = isset( $data['orderby'] ) ? $data['orderby'] : 'count';\n        $order = isset( $data['order'] ) ? $data['order'] : 'DESC';\n        \n        // 鏋勫缓鏌ヨ鍙傛暟\n        $args = array(\n            'taxonomy' => 'post_tag',\n            'number'   => $number,\n            'orderby'  => $orderby,\n            'order'    => $order,\n        );\n        \n        // 鑾峰彇鏍囩\n        $tags = get_tags( $args );\n        \n        // 鏍煎紡鍖栨爣绛炬暟鎹?
        $formatted_tags = array();\n        foreach ( $tags as $tag ) {\n            $formatted_tags[] = array(\n                'id' => $tag->term_id,\n                'name' => $tag->name,\n                'slug' => $tag->slug,\n                'description' => $tag->description,\n                'count' => $tag->count,\n            );\n        }\n        \n        // 鏋勫缓杩斿洖鏁版嵁\n        $result = array(\n            'code' => 0,\n            'message' => __( '鎴愬姛', 'sut-wechat-mini' ),\n            'data' => $formatted_tags\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 鎼滅储鏂囩珷\n     *\n     * @param array $data 璇锋眰鏁版嵁\n     * @param array $matches 璺敱鍖归厤缁撴灉\n     * @return array 鎼滅储缁撴灉\n     */\n    public function api_search_posts( $data, $matches ) {\n        // 妫€鏌ユ悳绱㈠叧閿瘝\n        if ( ! isset( $data['keyword'] ) || empty( $data['keyword'] ) ) {\n            return array(\n                'code' => 100,\n                'message' => __( '缂哄皯鎼滅储鍏抽敭璇?, 'sut-wechat-mini' ),\n                'data' => array()\n            );\n        }\n        \n        // 鑾峰彇鍒嗛〉鍙傛暟\n        $page = isset( $data['page'] ) ? intval( $data['page'] ) : 1;\n        $per_page = isset( $data['per_page'] ) ? intval( $data['per_page'] ) : $this->default_per_page;\n        $offset = ( $page - 1 ) * $per_page;\n        \n        // 鏋勫缓鎼滅储鍙傛暟\n        $args = array(\n            's'              => $data['keyword'],\n            'post_type'      => 'post',\n            'post_status'    => 'publish',\n            'posts_per_page' => $per_page,\n            'offset'         => $offset,\n            'orderby'        => 'relevance',\n            'order'          => 'DESC',\n        );\n        \n        // 鎵ц鎼滅储\n        $query = new WP_Query( $args );\n        \n        // 鏍煎紡鍖栨枃绔犳暟鎹?
        $posts = array();\n        foreach ( $query->posts as $post ) {\n            $posts[] = $this->format_post( $post );\n        }\n        \n        // 鏋勫缓杩斿洖鏁版嵁\n        $result = array(\n            'code' => 0,\n            'message' => __( '鎴愬姛', 'sut-wechat-mini' ),\n            'data' => array(\n                'list' => $posts,\n                'total' => $query->found_posts,\n                'page' => $page,\n                'per_page' => $per_page,\n                'total_pages' => ceil( $query->found_posts / $per_page )\n            )\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 鑾峰彇鐑棬鏂囩珷\n     *\n     * @param array $data 璇锋眰鏁版嵁\n     * @param array $matches 璺敱鍖归厤缁撴灉\n     * @return array 鐑棬鏂囩珷鍒楄〃\n     */\n    public function api_get_hot_posts( $data, $matches ) {\n        // 鑾峰彇鍙傛暟\n        $number = isset( $data['number'] ) ? intval( $data['number'] ) : 10;\n        \n        // 鏋勫缓鏌ヨ鍙傛暟\n        $args = array(\n            'post_type'      => 'post',\n            'post_status'    => 'publish',\n            'posts_per_page' => $number,\n            'meta_key'       => 'post_views_count',\n            'orderby'        => 'meta_value_num',\n            'order'          => 'DESC',\n        );\n        \n        // 鎵ц鏌ヨ\n        $query = new WP_Query( $args );\n        \n        // 鏍煎紡鍖栨枃绔犳暟鎹?
        $posts = array();\n        foreach ( $query->posts as $post ) {\n            $posts[] = $this->format_post( $post );\n        }\n        \n        // 鏋勫缓杩斿洖鏁版嵁\n        $result = array(\n            'code' => 0,\n            'message' => __( '鎴愬姛', 'sut-wechat-mini' ),\n            'data' => $posts\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 鑾峰彇鏈€鏂版枃绔?
     *\n     * @param array $data 璇锋眰鏁版嵁\n     * @param array $matches 璺敱鍖归厤缁撴灉\n     * @return array 鏈€鏂版枃绔犲垪琛?
     */\n    public function api_get_latest_posts( $data, $matches ) {\n        // 鑾峰彇鍒嗛〉鍙傛暟\n        $page = isset( $data['page'] ) ? intval( $data['page'] ) : 1;\n        $per_page = isset( $data['per_page'] ) ? intval( $data['per_page'] ) : $this->default_per_page;\n        $offset = ( $page - 1 ) * $per_page;\n        \n        // 鏋勫缓鏌ヨ鍙傛暟\n        $args = array(\n            'post_type'      => 'post',\n            'post_status'    => 'publish',\n            'posts_per_page' => $per_page,\n            'offset'         => $offset,\n            'orderby'        => 'date',\n            'order'          => 'DESC',\n        );\n        \n        // 鎵ц鏌ヨ\n        $query = new WP_Query( $args );\n        \n        // 鏍煎紡鍖栨枃绔犳暟鎹?
        $posts = array();\n        foreach ( $query->posts as $post ) {\n            $posts[] = $this->format_post( $post );\n        }\n        \n        // 鏋勫缓杩斿洖鏁版嵁\n        $result = array(\n            'code' => 0,\n            'message' => __( '鎴愬姛', 'sut-wechat-mini' ),\n            'data' => array(\n                'list' => $posts,\n                'total' => $query->found_posts,\n                'page' => $page,\n                'per_page' => $per_page,\n                'total_pages' => ceil( $query->found_posts / $per_page )\n            )\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 鑾峰彇鐩稿叧鏂囩珷\n     *\n     * @param array $data 璇锋眰鏁版嵁\n     * @param array $matches 璺敱鍖归厤缁撴灉\n     * @return array 鐩稿叧鏂囩珷鍒楄〃\n     */\n    public function api_get_related_posts( $data, $matches ) {\n        $post_id = $matches[1];\n        $number = isset( $data['number'] ) ? intval( $data['number'] ) : 5;\n        \n        // 鑾峰彇褰撳墠鏂囩珷鐨勫垎绫诲拰鏍囩\n        $categories = wp_get_post_categories( $post_id );\n        $tags = wp_get_post_tags( $post_id, array( 'fields' => 'ids' ) );\n        \n        // 鏋勫缓鏌ヨ鍙傛暟\n        $args = array(\n            'post_type'      => 'post',\n            'post_status'    => 'publish',\n            'posts_per_page' => $number,\n            'post__not_in'   => array( $post_id ),\n            'orderby'        => 'rand',\n        );\n        \n        // 濡傛灉鏈夊垎绫绘垨鏍囩锛屼娇鐢ㄥ畠浠潵鏌ユ壘鐩稿叧鏂囩珷\n        if ( ! empty( $categories ) || ! empty( $tags ) ) {\n            $tax_query = array( 'relation' => 'OR' );\n            \n            if ( ! empty( $categories ) ) {\n                $tax_query[] = array(\n                    'taxonomy' => 'category',\n                    'field'    => 'id',\n                    'terms'    => $categories,\n                );\n            }\n            \n            if ( ! empty( $tags ) ) {\n                $tax_query[] = array(\n                    'taxonomy' => 'post_tag',\n                    'field'    => 'id',\n                    'terms'    => $tags,\n                );\n            }\n            \n            $args['tax_query'] = $tax_query;\n        }\n        \n        // 鎵ц鏌ヨ\n        $query = new WP_Query( $args );\n        \n        // 鏍煎紡鍖栨枃绔犳暟鎹?
        $posts = array();\n        foreach ( $query->posts as $post ) {\n            $posts[] = $this->format_post( $post );\n        }\n        \n        // 鏋勫缓杩斿洖鏁版嵁\n        $result = array(\n            'code' => 0,\n            'message' => __( '鎴愬姛', 'sut-wechat-mini' ),\n            'data' => $posts\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 鏍规嵁鍒嗙被鑾峰彇鏂囩珷\n     *\n     * @param array $data 璇锋眰鏁版嵁\n     * @param array $matches 璺敱鍖归厤缁撴灉\n     * @return array 鏂囩珷鍒楄〃\n     */\n    public function api_get_posts_by_category( $data, $matches ) {\n        $category_id = $matches[1];\n        \n        // 妫€鏌ュ垎绫绘槸鍚﹀瓨鍦?
        $category = get_category( $category_id );\n        if ( ! $category || is_wp_error( $category ) ) {\n            return array(\n                'code' => 104,\n                'message' => __( '鍒嗙被涓嶅瓨鍦?, 'sut-wechat-mini' ),\n                'data' => array()\n            );\n        }\n        \n        // 鑾峰彇鍒嗛〉鍙傛暟\n        $page = isset( $data['page'] ) ? intval( $data['page'] ) : 1;\n        $per_page = isset( $data['per_page'] ) ? intval( $data['per_page'] ) : $this->default_per_page;\n        $offset = ( $page - 1 ) * $per_page;\n        \n        // 鏋勫缓鏌ヨ鍙傛暟\n        $args = array(\n            'post_type'      => 'post',\n            'post_status'    => 'publish',\n            'posts_per_page' => $per_page,\n            'offset'         => $offset,\n            'category__in'   => array( $category_id ),\n            'orderby'        => 'date',\n            'order'          => 'DESC',\n        );\n        \n        // 鎵ц鏌ヨ\n        $query = new WP_Query( $args );\n        \n        // 鏍煎紡鍖栨枃绔犳暟鎹?
        $posts = array();\n        foreach ( $query->posts as $post ) {\n            $posts[] = $this->format_post( $post );\n        }\n        \n        // 鏋勫缓杩斿洖鏁版嵁\n        $result = array(\n            'code' => 0,\n            'message' => __( '鎴愬姛', 'sut-wechat-mini' ),\n            'data' => array(\n                'list' => $posts,\n                'total' => $query->found_posts,\n                'page' => $page,\n                'per_page' => $per_page,\n                'total_pages' => ceil( $query->found_posts / $per_page )\n            )\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 鏍规嵁鏍囩鑾峰彇鏂囩珷\n     *\n     * @param array $data 璇锋眰鏁版嵁\n     * @param array $matches 璺敱鍖归厤缁撴灉\n     * @return array 鏂囩珷鍒楄〃\n     */\n    public function api_get_posts_by_tag( $data, $matches ) {\n        $tag_id = $matches[1];\n        \n        // 妫€鏌ユ爣绛炬槸鍚﹀瓨鍦?
        $tag = get_tag( $tag_id );\n        if ( ! $tag || is_wp_error( $tag ) ) {\n            return array(\n                'code' => 104,\n                'message' => __( '鏍囩涓嶅瓨鍦?, 'sut-wechat-mini' ),\n                'data' => array()\n            );\n        }\n        \n        // 鑾峰彇鍒嗛〉鍙傛暟\n        $page = isset( $data['page'] ) ? intval( $data['page'] ) : 1;\n        $per_page = isset( $data['per_page'] ) ? intval( $data['per_page'] ) : $this->default_per_page;\n        $offset = ( $page - 1 ) * $per_page;\n        \n        // 鏋勫缓鏌ヨ鍙傛暟\n        $args = array(\n            'post_type'      => 'post',\n            'post_status'    => 'publish',\n            'posts_per_page' => $per_page,\n            'offset'         => $offset,\n            'tag__in'        => array( $tag_id ),\n            'orderby'        => 'date',\n            'order'          => 'DESC',\n        );\n        \n        // 鎵ц鏌ヨ\n        $query = new WP_Query( $args );\n        \n        // 鏍煎紡鍖栨枃绔犳暟鎹?
        $posts = array();\n        foreach ( $query->posts as $post ) {\n            $posts[] = $this->format_post( $post );\n        }\n        \n        // 鏋勫缓杩斿洖鏁版嵁\n        $result = array(\n            'code' => 0,\n            'message' => __( '鎴愬姛', 'sut-wechat-mini' ),\n            'data' => array(\n                'list' => $posts,\n                'total' => $query->found_posts,\n                'page' => $page,\n                'per_page' => $per_page,\n                'total_pages' => ceil( $query->found_posts / $per_page )\n            )\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 鑾峰彇椤甸潰鍒楄〃\n     *\n     * @param array $data 璇锋眰鏁版嵁\n     * @param array $matches 璺敱鍖归厤缁撴灉\n     * @return array 椤甸潰鍒楄〃\n     */\n    public function api_get_pages( $data, $matches ) {\n        // 鑾峰彇鍒嗛〉鍙傛暟\n        $page = isset( $data['page'] ) ? intval( $data['page'] ) : 1;\n        $per_page = isset( $data['per_page'] ) ? intval( $data['per_page'] ) : $this->default_per_page;\n        $offset = ( $page - 1 ) * $per_page;\n        \n        // 鏋勫缓鏌ヨ鍙傛暟\n        $args = array(\n            'post_type'      => 'page',\n            'post_status'    => 'publish',\n            'posts_per_page' => $per_page,\n            'offset'         => $offset,\n            'orderby'        => 'menu_order',\n            'order'          => 'ASC',\n        );\n        \n        // 鎵ц鏌ヨ\n        $query = new WP_Query( $args );\n        \n        // 鏍煎紡鍖栭〉闈㈡暟鎹?
        $pages = array();\n        foreach ( $query->posts as $page ) {\n            $pages[] = $this->format_page( $page );\n        }\n        \n        // 鏋勫缓杩斿洖鏁版嵁\n        $result = array(\n            'code' => 0,\n            'message' => __( '鎴愬姛', 'sut-wechat-mini' ),\n            'data' => array(\n                'list' => $pages,\n                'total' => $query->found_posts,\n                'page' => $page,\n                'per_page' => $per_page,\n                'total_pages' => ceil( $query->found_posts / $per_page )\n            )\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 鑾峰彇鍗曚釜椤甸潰\n     *\n     * @param array $data 璇锋眰鏁版嵁\n     * @param array $matches 璺敱鍖归厤缁撴灉\n     * @return array 椤甸潰璇︽儏\n     */\n    public function api_get_page( $data, $matches ) {\n        $page_id = $matches[1];\n        \n        // 鑾峰彇椤甸潰\n        $page = get_post( $page_id );\n        \n        if ( ! $page || 'page' !== $page->post_type || 'publish' !== $page->post_status ) {\n            return array(\n                'code' => 104,\n                'message' => __( '椤甸潰涓嶅瓨鍦ㄦ垨鏈彂甯?, 'sut-wechat-mini' ),\n                'data' => array()\n            );\n        }\n        \n        // 鏍煎紡鍖栭〉闈㈡暟鎹?
        $formatted_page = $this->format_page( $page, true );\n        \n        // 鏋勫缓杩斿洖鏁版嵁\n        $result = array(\n            'code' => 0,\n            'message' => __( '鎴愬姛', 'sut-wechat-mini' ),\n            'data' => $formatted_page\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 鏍煎紡鍖栨枃绔犳暟鎹?
     *\n     * @param WP_Post $post 鏂囩珷瀵硅薄\n     * @param bool $is_detail 鏄惁涓鸿鎯呴〉\n     * @return array 鏍煎紡鍖栧悗鐨勬枃绔犳暟鎹?
     */\n    private function format_post( $post, $is_detail = false ) {\n        // 鑾峰彇鐗硅壊鍥剧墖\n        $thumbnail_id = get_post_thumbnail_id( $post->ID );\n        $thumbnail_url = $thumbnail_id ? wp_get_attachment_url( $thumbnail_id ) : '';\n        \n        // 鑾峰彇鍒嗙被\n        $categories = wp_get_post_categories( $post->ID );\n        $formatted_categories = array();\n        foreach ( $categories as $category_id ) {\n            $category = get_category( $category_id );\n            if ( $category ) {\n                $formatted_categories[] = array(\n                    'id' => $category->term_id,\n                    'name' => $category->name,\n                    'slug' => $category->slug,\n                );\n            }\n        }\n        \n        // 鑾峰彇鏍囩\n        $tags = wp_get_post_tags( $post->ID );\n        $formatted_tags = array();\n        foreach ( $tags as $tag ) {\n            $formatted_tags[] = array(\n                'id' => $tag->term_id,\n                'name' => $tag->name,\n                'slug' => $tag->slug,\n            );\n        }\n        \n        // 鑾峰彇浣滆€呬俊鎭?
        $author = get_user_by( 'id', $post->post_author );\n        $author_info = array(\n            'id' => $post->post_author,\n            'name' => $author ? $author->display_name : '',\n            'avatar' => $author ? get_avatar_url( $author->ID ) : '',\n        );\n        \n        // 鏋勫缓鏂囩珷鏁版嵁\n        $post_data = array(\n            'id' => $post->ID,\n            'title' => $post->post_title,\n            'slug' => $post->post_name,\n            'excerpt' => wp_strip_all_tags( $post->post_excerpt ? $post->post_excerpt : wp_trim_words( $post->post_content, 100 ) ),\n            'thumbnail' => $thumbnail_url,\n            'categories' => $formatted_categories,\n            'tags' => $formatted_tags,\n            'author' => $author_info,\n            'views' => $this->get_post_views( $post->ID ),\n            'comment_count' => $post->comment_count,\n            'date' => $post->post_date,\n            'modified' => $post->post_modified,\n        );\n        \n        // 濡傛灉鏄鎯呴〉锛屾坊鍔犳洿澶氬唴瀹?
        if ( $is_detail ) {\n            $content = apply_filters( 'the_content', $post->post_content );\n            \n            // 澶勭悊HTML鍐呭锛岃浆涓洪€傚悎灏忕▼搴忔樉绀虹殑鏍煎紡\n            $content = $this->process_content_for_mini_program( $content );\n            \n            $post_data['content'] = $content;\n            $post_data['url'] = get_permalink( $post->ID );\n        }\n        \n        return $post_data;\n    }\n    \n    /**\n     * 鏍煎紡鍖栭〉闈㈡暟鎹?
     *\n     * @param WP_Post $page 椤甸潰瀵硅薄\n     * @param bool $is_detail 鏄惁涓鸿鎯呴〉\n     * @return array 鏍煎紡鍖栧悗鐨勯〉闈㈡暟鎹?
     */\n    private function format_page( $page, $is_detail = false ) {\n        // 鑾峰彇鐗硅壊鍥剧墖\n        $thumbnail_id = get_post_thumbnail_id( $page->ID );\n        $thumbnail_url = $thumbnail_id ? wp_get_attachment_url( $thumbnail_id ) : '';\n        \n        // 鏋勫缓椤甸潰鏁版嵁\n        $page_data = array(\n            'id' => $page->ID,\n            'title' => $page->post_title,\n            'slug' => $page->post_name,\n            'thumbnail' => $thumbnail_url,\n            'date' => $page->post_date,\n            'modified' => $page->post_modified,\n        );\n        \n        // 濡傛灉鏄鎯呴〉锛屾坊鍔犲唴瀹?
        if ( $is_detail ) {\n            $content = apply_filters( 'the_content', $page->post_content );\n            \n            // 澶勭悊HTML鍐呭锛岃浆涓洪€傚悎灏忕▼搴忔樉绀虹殑鏍煎紡\n            $content = $this->process_content_for_mini_program( $content );\n            \n            $page_data['content'] = $content;\n            $page_data['url'] = get_permalink( $page->ID );\n        }\n        \n        return $page_data;\n    }\n    \n    /**\n     * 澶勭悊鍐呭涓哄皬绋嬪簭閫傚悎鐨勬牸寮?
     *\n     * @param string $content HTML鍐呭\n     * @return string 澶勭悊鍚庣殑鍐呭\n     */\n    private function process_content_for_mini_program( $content ) {\n        // 鏇挎崲鐗规畩瀛楃\n        $content = str_replace( array( '<', '>', '&' ), array( '&lt;', '&gt;', '&amp;' ), $content );\n        \n        // 澶勭悊鍥剧墖\n        $content = preg_replace_callback( '/<img[^>]+src=["\']([^"\']+)["\'][^>]*>/i', function( $matches ) {\n            $src = $matches[1];\n            // 纭繚鍥剧墖URL鏄粷瀵硅矾寰?
            if ( 0 !== strpos( $src, 'http' ) ) {\n                $src = site_url() . $src;\n            }\n            return '<img src="' . $src . '" mode="aspectFit" />';\n        }, $content );\n        \n        // 澶勭悊閾炬帴\n        $content = preg_replace_callback( '/<a[^>]+href=["\']([^"\']+)["\'][^>]*>(.*?)<\/a>/i', function( $matches ) {\n            $href = $matches[1];\n            $text = $matches[2];\n            return '<text class="link" data-href="' . $href . '">' . $text . '</text>';\n        }, $content );\n        \n        // 澶勭悊瑙嗛\n        $content = preg_replace_callback( '/<video[^>]+src=["\']([^"\']+)["\'][^>]*>/i', function( $matches ) {\n            $src = $matches[1];\n            // 纭繚瑙嗛URL鏄粷瀵硅矾寰?
            if ( 0 !== strpos( $src, 'http' ) ) {\n                $src = site_url() . $src;\n            }\n            return '<video src="' . $src . '" controls></video>';\n        }, $content );\n        \n        // 澶勭悊闊抽\n        $content = preg_replace_callback( '/<audio[^>]+src=["\']([^"\']+)["\'][^>]*>/i', function( $matches ) {\n            $src = $matches[1];\n            // 纭繚闊抽URL鏄粷瀵硅矾寰?
            if ( 0 !== strpos( $src, 'http' ) ) {\n                $src = site_url() . $src;\n            }\n            return '<audio src="' . $src . '" controls></audio>';\n        }, $content );\n        \n        // 澶勭悊浠ｇ爜鍧?
        $content = preg_replace( '/<pre[^>]*><code[^>]*>(.*?)<\/code><\/pre>/is', '<view class="code-block"><text>$1</text></view>', $content );\n        \n        // 澶勭悊琛ㄦ牸\n        $content = preg_replace( '/<table[^>]*>(.*?)<\/table>/is', '<view class="table-container">$1</view>', $content );\n        \n        return $content;\n    }\n    \n    /**\n     * 搴旂敤鏂囩珷鏌ヨ杩囨护鏉′欢\n     *\n     * @param array $args 鏌ヨ鍙傛暟\n     * @param array $data 璇锋眰鏁版嵁\n     * @return array 淇敼鍚庣殑鏌ヨ鍙傛暟\n     */\n    private function apply_post_query_filters( $args, $data ) {\n        // 鏍规嵁鍒嗙被杩囨护\n        if ( isset( $data['category'] ) && ! empty( $data['category'] ) ) {\n            $args['category__in'] = array_map( 'intval', explode( ',', $data['category'] ) );\n        }\n        \n        // 鏍规嵁鏍囩杩囨护\n        if ( isset( $data['tag'] ) && ! empty( $data['tag'] ) ) {\n            $args['tag__in'] = array_map( 'intval', explode( ',', $data['tag'] ) );\n        }\n        \n        // 鏍规嵁浣滆€呰繃婊?
        if ( isset( $data['author'] ) && ! empty( $data['author'] ) ) {\n            $args['author'] = $data['author'];\n        }\n        \n        // 鏍规嵁鍙戝竷鏃ユ湡杩囨护\n        if ( isset( $data['start_date'] ) && ! empty( $data['start_date'] ) ) {\n            $args['date_query'][0]['after'] = $data['start_date'];\n        }\n        \n        if ( isset( $data['end_date'] ) && ! empty( $data['end_date'] ) ) {\n            $args['date_query'][0]['before'] = $data['end_date'];\n        }\n        \n        // 鏍规嵁鑷畾涔夊瓧娈佃繃婊?
        if ( isset( $data['meta_key'] ) && isset( $data['meta_value'] ) ) {\n            $args['meta_key'] = $data['meta_key'];\n            $args['meta_value'] = $data['meta_value'];\n            \n            if ( isset( $data['meta_compare'] ) ) {\n                $args['meta_compare'] = $data['meta_compare'];\n            }\n        }\n        \n        // 鏍规嵁鎺掑簭鏂瑰紡杩囨护\n        if ( isset( $data['orderby'] ) && ! empty( $data['orderby'] ) ) {\n            $args['orderby'] = $data['orderby'];\n            \n            if ( isset( $data['order'] ) && ! empty( $data['order'] ) ) {\n                $args['order'] = $data['order'];\n            }\n        }\n        \n        return $args;\n    }\n    \n    /**\n     * 鑾峰彇鏂囩珷娴忚閲?
     *\n     * @param int $post_id 鏂囩珷ID\n     * @return int 娴忚閲?
     */\n    private function get_post_views( $post_id ) {\n        $views = get_post_meta( $post_id, 'post_views_count', true );\n        return $views ? intval( $views ) : 0;\n    }\n    \n    /**\n     * 澧炲姞鏂囩珷娴忚閲?
     *\n     * @param int $post_id 鏂囩珷ID\n     */\n    private function increase_post_views( $post_id ) {\n        $views = $this->get_post_views( $post_id );\n        update_post_meta( $post_id, 'post_views_count', $views + 1 );\n    }\n}\n