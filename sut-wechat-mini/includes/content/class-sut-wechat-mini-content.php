锘??php\n/**\n * SUT瀵邦喕淇婄亸蹇曗柤鎼村繐鍞寸€瑰湱顓搁悶鍡欒\n *\n * 婢跺嫮鎮奧ordPress閸愬懎顔愰惃鍕箯閸欐牕鎷伴弽鐓庣础閸栨牭绱濇稉鍝勪簳娣団€崇毈缁嬪绨幓鎰返閺傚洨鐝烽妴浣稿瀻缁眹鈧焦鐖ｇ粵鍓х搼閸愬懎顔愰弨顖涘瘮\n *\n * @package SUT_WeChat_Mini\n */\n\nif ( ! defined( 'ABSPATH' ) ) {\n    exit;\n}\n\n/**\n * SUT_WeChat_Mini_Content 缁?
 */\nclass SUT_WeChat_Mini_Content {\n    \n    /**\n     * 閸愬懎顔愮粻锛勬倞鐎圭偘绶n     *\n     * @var SUT_WeChat_Mini_Content\n     */\n    private static $instance = null;\n    \n    /**\n     * 姒涙顓诲В蹇涖€夐弰鍓с仛閺佷即鍣篭n     *\n     * @var int\n     */\n    private $default_per_page = 10;\n    \n    /**\n     * 閺嬪嫰鈧姴鍤遍弫?
     */\n    public function __construct() {\n        $this->init();\n    }\n    \n    /**\n     * 閼惧嘲褰囬崡鏇氱伐鐎圭偘绶n     *\n     * @return SUT_WeChat_Mini_Content\n     */\n    public static function get_instance() {\n        if ( null === self::$instance ) {\n            self::$instance = new self();\n        }\n        \n        return self::$instance;\n    }\n    \n    /**\n     * 閸掓繂顫愰崠鏍у敶鐎瑰湱顓搁悶?
     */\n    private function init() {\n        // 濞夈劌鍞介崘鍛啇閻╃鍙ч惃鍕尙鐎?
        add_filter( 'sut_wechat_mini_api_routes', array( $this, 'add_content_routes' ) );\n    }\n    \n    /**\n     * 濞ｈ濮為崘鍛啇閻╃鍙ч惃鍑橮I鐠侯垳鏁盶n     *\n     * @param array $routes 閻滅増婀佺捄顖滄暠\n     * @return array 娣囶喗鏁奸崥搴ｆ畱鐠侯垳鏁盶n     */\n    public function add_content_routes( $routes ) {\n        $routes['posts/search'] = array( 'callback' => array( $this, 'api_search_posts' ) );\n        $routes['posts/hot'] = array( 'callback' => array( $this, 'api_get_hot_posts' ) );\n        $routes['posts/latest'] = array( 'callback' => array( $this, 'api_get_latest_posts' ) );\n        $routes['posts/related/([0-9]+)'] = array( 'callback' => array( $this, 'api_get_related_posts' ) );\n        $routes['categories/([0-9]+)/posts'] = array( 'callback' => array( $this, 'api_get_posts_by_category' ) );\n        $routes['tags/([0-9]+)/posts'] = array( 'callback' => array( $this, 'api_get_posts_by_tag' ) );\n        $routes['pages'] = array( 'callback' => array( $this, 'api_get_pages' ) );\n        $routes['pages/([0-9]+)'] = array( 'callback' => array( $this, 'api_get_page' ) );\n        \n        return $routes;\n    }\n    \n    /**\n     * 閼惧嘲褰囬弬鍥╃彿閸掓銆僜n     *\n     * @param array $data 鐠囬攱鐪伴弫鐗堝祦\n     * @return array 閺傚洨鐝烽崚妤勩€僜n     */\n    public function get_posts( $data ) {\n        // 閼惧嘲褰囬崚鍡涖€夐崣鍌涙殶\n        $page = isset( $data['page'] ) ? intval( $data['page'] ) : 1;\n        $per_page = isset( $data['per_page'] ) ? intval( $data['per_page'] ) : $this->default_per_page;\n        $offset = ( $page - 1 ) * $per_page;\n        \n        // 閺嬪嫬缂撻弻銉嚄閸欏倹鏆焅n        $args = array(\n            'post_type'      => 'post',\n            'post_status'    => 'publish',\n            'posts_per_page' => $per_page,\n            'offset'         => $offset,\n            'orderby'        => 'date',\n            'order'          => 'DESC',\n        );\n        \n        // 鎼存梻鏁ゆ０婵嗩樆閻ㄥ嫭鐓＄拠銏℃蒋娴?
        $args = $this->apply_post_query_filters( $args, $data );\n        \n        // 閹笛嗩攽閺屻儴顕梊n        $query = new WP_Query( $args );\n        \n        // 閺嶇厧绱￠崠鏍ㄦ瀮缁旂姵鏆熼幑?
        $posts = array();\n        foreach ( $query->posts as $post ) {\n            $posts[] = $this->format_post( $post );\n        }\n        \n        // 閺嬪嫬缂撴潻鏂挎礀閺佺増宓乗n        $result = array(\n            'code' => 0,\n            'message' => __( '閹存劕濮?, 'sut-wechat-mini' ),\n            'data' => array(\n                'list' => $posts,\n                'total' => $query->found_posts,\n                'page' => $page,\n                'per_page' => $per_page,\n                'total_pages' => ceil( $query->found_posts / $per_page )\n            )\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 閼惧嘲褰囬崡鏇犵槖閺傚洨鐝穃n     *\n     * @param int $post_id 閺傚洨鐝稩D\n     * @return array 閺傚洨鐝风拠锔藉剰\n     */\n    public function get_post( $post_id ) {\n        // 閼惧嘲褰囬弬鍥╃彿\n        $post = get_post( $post_id );\n        \n        if ( ! $post || 'publish' !== $post->post_status ) {\n            return array(\n                'code' => 104,\n                'message' => __( '閺傚洨鐝锋稉宥呯摠閸︺劍鍨ㄩ張顏勫絺鐢?, 'sut-wechat-mini' ),\n                'data' => array()\n            );\n        }\n        \n        // 婢х偛濮為弬鍥╃彿濞村繗顫嶉柌?
        $this->increase_post_views( $post_id );\n        \n        // 閺嶇厧绱￠崠鏍ㄦ瀮缁旂姵鏆熼幑?
        $formatted_post = $this->format_post( $post, true );\n        \n        // 閺嬪嫬缂撴潻鏂挎礀閺佺増宓乗n        $result = array(\n            'code' => 0,\n            'message' => __( '閹存劕濮?, 'sut-wechat-mini' ),\n            'data' => $formatted_post\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 閼惧嘲褰囬崚鍡欒閸掓銆僜n     *\n     * @param array $data 鐠囬攱鐪伴弫鐗堝祦\n     * @return array 閸掑棛琚崚妤勩€僜n     */\n    public function get_categories( $data ) {\n        // 閼惧嘲褰囬崣鍌涙殶\n        $parent = isset( $data['parent'] ) ? intval( $data['parent'] ) : 0;\n        $hide_empty = isset( $data['hide_empty'] ) ? boolval( $data['hide_empty'] ) : true;\n        \n        // 閺嬪嫬缂撻弻銉嚄閸欏倹鏆焅n        $args = array(\n            'taxonomy'   => 'category',\n            'parent'     => $parent,\n            'hide_empty' => $hide_empty,\n            'orderby'    => 'count',\n            'order'      => 'DESC',\n        );\n        \n        // 閼惧嘲褰囬崚鍡欒\n        $categories = get_categories( $args );\n        \n        // 閺嶇厧绱￠崠鏍у瀻缁粯鏆熼幑?
        $formatted_categories = array();\n        foreach ( $categories as $category ) {\n            $formatted_categories[] = array(\n                'id' => $category->term_id,\n                'name' => $category->name,\n                'slug' => $category->slug,\n                'description' => $category->description,\n                'parent' => $category->parent,\n                'count' => $category->count,\n            );\n        }\n        \n        // 閺嬪嫬缂撴潻鏂挎礀閺佺増宓乗n        $result = array(\n            'code' => 0,\n            'message' => __( '閹存劕濮?, 'sut-wechat-mini' ),\n            'data' => $formatted_categories\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 閼惧嘲褰囬弽鍥╊劮閸掓銆僜n     *\n     * @param array $data 鐠囬攱鐪伴弫鐗堝祦\n     * @return array 閺嶅洨顒烽崚妤勩€僜n     */\n    public function get_tags( $data ) {\n        // 閼惧嘲褰囬崣鍌涙殶\n        $number = isset( $data['number'] ) ? intval( $data['number'] ) : 100;\n        $orderby = isset( $data['orderby'] ) ? $data['orderby'] : 'count';\n        $order = isset( $data['order'] ) ? $data['order'] : 'DESC';\n        \n        // 閺嬪嫬缂撻弻銉嚄閸欏倹鏆焅n        $args = array(\n            'taxonomy' => 'post_tag',\n            'number'   => $number,\n            'orderby'  => $orderby,\n            'order'    => $order,\n        );\n        \n        // 閼惧嘲褰囬弽鍥╊劮\n        $tags = get_tags( $args );\n        \n        // 閺嶇厧绱￠崠鏍ㄧ垼缁涚偓鏆熼幑?
        $formatted_tags = array();\n        foreach ( $tags as $tag ) {\n            $formatted_tags[] = array(\n                'id' => $tag->term_id,\n                'name' => $tag->name,\n                'slug' => $tag->slug,\n                'description' => $tag->description,\n                'count' => $tag->count,\n            );\n        }\n        \n        // 閺嬪嫬缂撴潻鏂挎礀閺佺増宓乗n        $result = array(\n            'code' => 0,\n            'message' => __( '閹存劕濮?, 'sut-wechat-mini' ),\n            'data' => $formatted_tags\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 閹兼粎鍌ㄩ弬鍥╃彿\n     *\n     * @param array $data 鐠囬攱鐪伴弫鐗堝祦\n     * @param array $matches 鐠侯垳鏁遍崠褰掑帳缂佹挻鐏塡n     * @return array 閹兼粎鍌ㄧ紒鎾寸亯\n     */\n    public function api_search_posts( $data, $matches ) {\n        // 濡偓閺屻儲鎮崇槐銏犲彠闁款喛鐦漒n        if ( ! isset( $data['keyword'] ) || empty( $data['keyword'] ) ) {\n            return array(\n                'code' => 100,\n                'message' => __( '缂傚搫鐨幖婊呭偍閸忔娊鏁拠?, 'sut-wechat-mini' ),\n                'data' => array()\n            );\n        }\n        \n        // 閼惧嘲褰囬崚鍡涖€夐崣鍌涙殶\n        $page = isset( $data['page'] ) ? intval( $data['page'] ) : 1;\n        $per_page = isset( $data['per_page'] ) ? intval( $data['per_page'] ) : $this->default_per_page;\n        $offset = ( $page - 1 ) * $per_page;\n        \n        // 閺嬪嫬缂撻幖婊呭偍閸欏倹鏆焅n        $args = array(\n            's'              => $data['keyword'],\n            'post_type'      => 'post',\n            'post_status'    => 'publish',\n            'posts_per_page' => $per_page,\n            'offset'         => $offset,\n            'orderby'        => 'relevance',\n            'order'          => 'DESC',\n        );\n        \n        // 閹笛嗩攽閹兼粎鍌╘n        $query = new WP_Query( $args );\n        \n        // 閺嶇厧绱￠崠鏍ㄦ瀮缁旂姵鏆熼幑?
        $posts = array();\n        foreach ( $query->posts as $post ) {\n            $posts[] = $this->format_post( $post );\n        }\n        \n        // 閺嬪嫬缂撴潻鏂挎礀閺佺増宓乗n        $result = array(\n            'code' => 0,\n            'message' => __( '閹存劕濮?, 'sut-wechat-mini' ),\n            'data' => array(\n                'list' => $posts,\n                'total' => $query->found_posts,\n                'page' => $page,\n                'per_page' => $per_page,\n                'total_pages' => ceil( $query->found_posts / $per_page )\n            )\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 閼惧嘲褰囬悜顓㈡，閺傚洨鐝穃n     *\n     * @param array $data 鐠囬攱鐪伴弫鐗堝祦\n     * @param array $matches 鐠侯垳鏁遍崠褰掑帳缂佹挻鐏塡n     * @return array 閻戭參妫弬鍥╃彿閸掓銆僜n     */\n    public function api_get_hot_posts( $data, $matches ) {\n        // 閼惧嘲褰囬崣鍌涙殶\n        $number = isset( $data['number'] ) ? intval( $data['number'] ) : 10;\n        \n        // 閺嬪嫬缂撻弻銉嚄閸欏倹鏆焅n        $args = array(\n            'post_type'      => 'post',\n            'post_status'    => 'publish',\n            'posts_per_page' => $number,\n            'meta_key'       => 'post_views_count',\n            'orderby'        => 'meta_value_num',\n            'order'          => 'DESC',\n        );\n        \n        // 閹笛嗩攽閺屻儴顕梊n        $query = new WP_Query( $args );\n        \n        // 閺嶇厧绱￠崠鏍ㄦ瀮缁旂姵鏆熼幑?
        $posts = array();\n        foreach ( $query->posts as $post ) {\n            $posts[] = $this->format_post( $post );\n        }\n        \n        // 閺嬪嫬缂撴潻鏂挎礀閺佺増宓乗n        $result = array(\n            'code' => 0,\n            'message' => __( '閹存劕濮?, 'sut-wechat-mini' ),\n            'data' => $posts\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 閼惧嘲褰囬張鈧弬鐗堟瀮缁?
     *\n     * @param array $data 鐠囬攱鐪伴弫鐗堝祦\n     * @param array $matches 鐠侯垳鏁遍崠褰掑帳缂佹挻鐏塡n     * @return array 閺堚偓閺傜増鏋冪粩鐘插灙鐞?
     */\n    public function api_get_latest_posts( $data, $matches ) {\n        // 閼惧嘲褰囬崚鍡涖€夐崣鍌涙殶\n        $page = isset( $data['page'] ) ? intval( $data['page'] ) : 1;\n        $per_page = isset( $data['per_page'] ) ? intval( $data['per_page'] ) : $this->default_per_page;\n        $offset = ( $page - 1 ) * $per_page;\n        \n        // 閺嬪嫬缂撻弻銉嚄閸欏倹鏆焅n        $args = array(\n            'post_type'      => 'post',\n            'post_status'    => 'publish',\n            'posts_per_page' => $per_page,\n            'offset'         => $offset,\n            'orderby'        => 'date',\n            'order'          => 'DESC',\n        );\n        \n        // 閹笛嗩攽閺屻儴顕梊n        $query = new WP_Query( $args );\n        \n        // 閺嶇厧绱￠崠鏍ㄦ瀮缁旂姵鏆熼幑?
        $posts = array();\n        foreach ( $query->posts as $post ) {\n            $posts[] = $this->format_post( $post );\n        }\n        \n        // 閺嬪嫬缂撴潻鏂挎礀閺佺増宓乗n        $result = array(\n            'code' => 0,\n            'message' => __( '閹存劕濮?, 'sut-wechat-mini' ),\n            'data' => array(\n                'list' => $posts,\n                'total' => $query->found_posts,\n                'page' => $page,\n                'per_page' => $per_page,\n                'total_pages' => ceil( $query->found_posts / $per_page )\n            )\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 閼惧嘲褰囬惄绋垮彠閺傚洨鐝穃n     *\n     * @param array $data 鐠囬攱鐪伴弫鐗堝祦\n     * @param array $matches 鐠侯垳鏁遍崠褰掑帳缂佹挻鐏塡n     * @return array 閻╃鍙ч弬鍥╃彿閸掓銆僜n     */\n    public function api_get_related_posts( $data, $matches ) {\n        $post_id = $matches[1];\n        $number = isset( $data['number'] ) ? intval( $data['number'] ) : 5;\n        \n        // 閼惧嘲褰囪ぐ鎾冲閺傚洨鐝烽惃鍕瀻缁鎷伴弽鍥╊劮\n        $categories = wp_get_post_categories( $post_id );\n        $tags = wp_get_post_tags( $post_id, array( 'fields' => 'ids' ) );\n        \n        // 閺嬪嫬缂撻弻銉嚄閸欏倹鏆焅n        $args = array(\n            'post_type'      => 'post',\n            'post_status'    => 'publish',\n            'posts_per_page' => $number,\n            'post__not_in'   => array( $post_id ),\n            'orderby'        => 'rand',\n        );\n        \n        // 婵″倹鐏夐張澶婂瀻缁粯鍨ㄩ弽鍥╊劮閿涘奔濞囬悽銊ョ暊娴狀剚娼甸弻銉﹀閻╃鍙ч弬鍥╃彿\n        if ( ! empty( $categories ) || ! empty( $tags ) ) {\n            $tax_query = array( 'relation' => 'OR' );\n            \n            if ( ! empty( $categories ) ) {\n                $tax_query[] = array(\n                    'taxonomy' => 'category',\n                    'field'    => 'id',\n                    'terms'    => $categories,\n                );\n            }\n            \n            if ( ! empty( $tags ) ) {\n                $tax_query[] = array(\n                    'taxonomy' => 'post_tag',\n                    'field'    => 'id',\n                    'terms'    => $tags,\n                );\n            }\n            \n            $args['tax_query'] = $tax_query;\n        }\n        \n        // 閹笛嗩攽閺屻儴顕梊n        $query = new WP_Query( $args );\n        \n        // 閺嶇厧绱￠崠鏍ㄦ瀮缁旂姵鏆熼幑?
        $posts = array();\n        foreach ( $query->posts as $post ) {\n            $posts[] = $this->format_post( $post );\n        }\n        \n        // 閺嬪嫬缂撴潻鏂挎礀閺佺増宓乗n        $result = array(\n            'code' => 0,\n            'message' => __( '閹存劕濮?, 'sut-wechat-mini' ),\n            'data' => $posts\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 閺嶈宓侀崚鍡欒閼惧嘲褰囬弬鍥╃彿\n     *\n     * @param array $data 鐠囬攱鐪伴弫鐗堝祦\n     * @param array $matches 鐠侯垳鏁遍崠褰掑帳缂佹挻鐏塡n     * @return array 閺傚洨鐝烽崚妤勩€僜n     */\n    public function api_get_posts_by_category( $data, $matches ) {\n        $category_id = $matches[1];\n        \n        // 濡偓閺屻儱鍨庣猾缁樻Ц閸氾箑鐡ㄩ崷?
        $category = get_category( $category_id );\n        if ( ! $category || is_wp_error( $category ) ) {\n            return array(\n                'code' => 104,\n                'message' => __( '閸掑棛琚稉宥呯摠閸?, 'sut-wechat-mini' ),\n                'data' => array()\n            );\n        }\n        \n        // 閼惧嘲褰囬崚鍡涖€夐崣鍌涙殶\n        $page = isset( $data['page'] ) ? intval( $data['page'] ) : 1;\n        $per_page = isset( $data['per_page'] ) ? intval( $data['per_page'] ) : $this->default_per_page;\n        $offset = ( $page - 1 ) * $per_page;\n        \n        // 閺嬪嫬缂撻弻銉嚄閸欏倹鏆焅n        $args = array(\n            'post_type'      => 'post',\n            'post_status'    => 'publish',\n            'posts_per_page' => $per_page,\n            'offset'         => $offset,\n            'category__in'   => array( $category_id ),\n            'orderby'        => 'date',\n            'order'          => 'DESC',\n        );\n        \n        // 閹笛嗩攽閺屻儴顕梊n        $query = new WP_Query( $args );\n        \n        // 閺嶇厧绱￠崠鏍ㄦ瀮缁旂姵鏆熼幑?
        $posts = array();\n        foreach ( $query->posts as $post ) {\n            $posts[] = $this->format_post( $post );\n        }\n        \n        // 閺嬪嫬缂撴潻鏂挎礀閺佺増宓乗n        $result = array(\n            'code' => 0,\n            'message' => __( '閹存劕濮?, 'sut-wechat-mini' ),\n            'data' => array(\n                'list' => $posts,\n                'total' => $query->found_posts,\n                'page' => $page,\n                'per_page' => $per_page,\n                'total_pages' => ceil( $query->found_posts / $per_page )\n            )\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 閺嶈宓侀弽鍥╊劮閼惧嘲褰囬弬鍥╃彿\n     *\n     * @param array $data 鐠囬攱鐪伴弫鐗堝祦\n     * @param array $matches 鐠侯垳鏁遍崠褰掑帳缂佹挻鐏塡n     * @return array 閺傚洨鐝烽崚妤勩€僜n     */\n    public function api_get_posts_by_tag( $data, $matches ) {\n        $tag_id = $matches[1];\n        \n        // 濡偓閺屻儲鐖ｇ粵鐐Ц閸氾箑鐡ㄩ崷?
        $tag = get_tag( $tag_id );\n        if ( ! $tag || is_wp_error( $tag ) ) {\n            return array(\n                'code' => 104,\n                'message' => __( '閺嶅洨顒锋稉宥呯摠閸?, 'sut-wechat-mini' ),\n                'data' => array()\n            );\n        }\n        \n        // 閼惧嘲褰囬崚鍡涖€夐崣鍌涙殶\n        $page = isset( $data['page'] ) ? intval( $data['page'] ) : 1;\n        $per_page = isset( $data['per_page'] ) ? intval( $data['per_page'] ) : $this->default_per_page;\n        $offset = ( $page - 1 ) * $per_page;\n        \n        // 閺嬪嫬缂撻弻銉嚄閸欏倹鏆焅n        $args = array(\n            'post_type'      => 'post',\n            'post_status'    => 'publish',\n            'posts_per_page' => $per_page,\n            'offset'         => $offset,\n            'tag__in'        => array( $tag_id ),\n            'orderby'        => 'date',\n            'order'          => 'DESC',\n        );\n        \n        // 閹笛嗩攽閺屻儴顕梊n        $query = new WP_Query( $args );\n        \n        // 閺嶇厧绱￠崠鏍ㄦ瀮缁旂姵鏆熼幑?
        $posts = array();\n        foreach ( $query->posts as $post ) {\n            $posts[] = $this->format_post( $post );\n        }\n        \n        // 閺嬪嫬缂撴潻鏂挎礀閺佺増宓乗n        $result = array(\n            'code' => 0,\n            'message' => __( '閹存劕濮?, 'sut-wechat-mini' ),\n            'data' => array(\n                'list' => $posts,\n                'total' => $query->found_posts,\n                'page' => $page,\n                'per_page' => $per_page,\n                'total_pages' => ceil( $query->found_posts / $per_page )\n            )\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 閼惧嘲褰囨い鐢告桨閸掓銆僜n     *\n     * @param array $data 鐠囬攱鐪伴弫鐗堝祦\n     * @param array $matches 鐠侯垳鏁遍崠褰掑帳缂佹挻鐏塡n     * @return array 妞ょ敻娼伴崚妤勩€僜n     */\n    public function api_get_pages( $data, $matches ) {\n        // 閼惧嘲褰囬崚鍡涖€夐崣鍌涙殶\n        $page = isset( $data['page'] ) ? intval( $data['page'] ) : 1;\n        $per_page = isset( $data['per_page'] ) ? intval( $data['per_page'] ) : $this->default_per_page;\n        $offset = ( $page - 1 ) * $per_page;\n        \n        // 閺嬪嫬缂撻弻銉嚄閸欏倹鏆焅n        $args = array(\n            'post_type'      => 'page',\n            'post_status'    => 'publish',\n            'posts_per_page' => $per_page,\n            'offset'         => $offset,\n            'orderby'        => 'menu_order',\n            'order'          => 'ASC',\n        );\n        \n        // 閹笛嗩攽閺屻儴顕梊n        $query = new WP_Query( $args );\n        \n        // 閺嶇厧绱￠崠鏍€夐棃銏℃殶閹?
        $pages = array();\n        foreach ( $query->posts as $page ) {\n            $pages[] = $this->format_page( $page );\n        }\n        \n        // 閺嬪嫬缂撴潻鏂挎礀閺佺増宓乗n        $result = array(\n            'code' => 0,\n            'message' => __( '閹存劕濮?, 'sut-wechat-mini' ),\n            'data' => array(\n                'list' => $pages,\n                'total' => $query->found_posts,\n                'page' => $page,\n                'per_page' => $per_page,\n                'total_pages' => ceil( $query->found_posts / $per_page )\n            )\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 閼惧嘲褰囬崡鏇氶嚋妞ょ敻娼癨n     *\n     * @param array $data 鐠囬攱鐪伴弫鐗堝祦\n     * @param array $matches 鐠侯垳鏁遍崠褰掑帳缂佹挻鐏塡n     * @return array 妞ょ敻娼扮拠锔藉剰\n     */\n    public function api_get_page( $data, $matches ) {\n        $page_id = $matches[1];\n        \n        // 閼惧嘲褰囨い鐢告桨\n        $page = get_post( $page_id );\n        \n        if ( ! $page || 'page' !== $page->post_type || 'publish' !== $page->post_status ) {\n            return array(\n                'code' => 104,\n                'message' => __( '妞ょ敻娼版稉宥呯摠閸︺劍鍨ㄩ張顏勫絺鐢?, 'sut-wechat-mini' ),\n                'data' => array()\n            );\n        }\n        \n        // 閺嶇厧绱￠崠鏍€夐棃銏℃殶閹?
        $formatted_page = $this->format_page( $page, true );\n        \n        // 閺嬪嫬缂撴潻鏂挎礀閺佺増宓乗n        $result = array(\n            'code' => 0,\n            'message' => __( '閹存劕濮?, 'sut-wechat-mini' ),\n            'data' => $formatted_page\n        );\n        \n        return $result;\n    }\n    \n    /**\n     * 閺嶇厧绱￠崠鏍ㄦ瀮缁旂姵鏆熼幑?
     *\n     * @param WP_Post $post 閺傚洨鐝风€电钖刓n     * @param bool $is_detail 閺勵垰鎯佹稉楦款嚊閹懘銆塡n     * @return array 閺嶇厧绱￠崠鏍ф倵閻ㄥ嫭鏋冪粩鐘虫殶閹?
     */\n    private function format_post( $post, $is_detail = false ) {\n        // 閼惧嘲褰囬悧纭呭閸ュ墽澧朶n        $thumbnail_id = get_post_thumbnail_id( $post->ID );\n        $thumbnail_url = $thumbnail_id ? wp_get_attachment_url( $thumbnail_id ) : '';\n        \n        // 閼惧嘲褰囬崚鍡欒\n        $categories = wp_get_post_categories( $post->ID );\n        $formatted_categories = array();\n        foreach ( $categories as $category_id ) {\n            $category = get_category( $category_id );\n            if ( $category ) {\n                $formatted_categories[] = array(\n                    'id' => $category->term_id,\n                    'name' => $category->name,\n                    'slug' => $category->slug,\n                );\n            }\n        }\n        \n        // 閼惧嘲褰囬弽鍥╊劮\n        $tags = wp_get_post_tags( $post->ID );\n        $formatted_tags = array();\n        foreach ( $tags as $tag ) {\n            $formatted_tags[] = array(\n                'id' => $tag->term_id,\n                'name' => $tag->name,\n                'slug' => $tag->slug,\n            );\n        }\n        \n        // 閼惧嘲褰囨担婊嗏偓鍛繆閹?
        $author = get_user_by( 'id', $post->post_author );\n        $author_info = array(\n            'id' => $post->post_author,\n            'name' => $author ? $author->display_name : '',\n            'avatar' => $author ? get_avatar_url( $author->ID ) : '',\n        );\n        \n        // 閺嬪嫬缂撻弬鍥╃彿閺佺増宓乗n        $post_data = array(\n            'id' => $post->ID,\n            'title' => $post->post_title,\n            'slug' => $post->post_name,\n            'excerpt' => wp_strip_all_tags( $post->post_excerpt ? $post->post_excerpt : wp_trim_words( $post->post_content, 100 ) ),\n            'thumbnail' => $thumbnail_url,\n            'categories' => $formatted_categories,\n            'tags' => $formatted_tags,\n            'author' => $author_info,\n            'views' => $this->get_post_views( $post->ID ),\n            'comment_count' => $post->comment_count,\n            'date' => $post->post_date,\n            'modified' => $post->post_modified,\n        );\n        \n        // 婵″倹鐏夐弰顖濐嚊閹懘銆夐敍灞惧潑閸旂姵娲挎径姘敶鐎?
        if ( $is_detail ) {\n            $content = apply_filters( 'the_content', $post->post_content );\n            \n            // 婢跺嫮鎮奌TML閸愬懎顔愰敍宀冩祮娑撴椽鈧倸鎮庣亸蹇曗柤鎼村繑妯夌粈铏规畱閺嶇厧绱n            $content = $this->process_content_for_mini_program( $content );\n            \n            $post_data['content'] = $content;\n            $post_data['url'] = get_permalink( $post->ID );\n        }\n        \n        return $post_data;\n    }\n    \n    /**\n     * 閺嶇厧绱￠崠鏍€夐棃銏℃殶閹?
     *\n     * @param WP_Post $page 妞ょ敻娼扮€电钖刓n     * @param bool $is_detail 閺勵垰鎯佹稉楦款嚊閹懘銆塡n     * @return array 閺嶇厧绱￠崠鏍ф倵閻ㄥ嫰銆夐棃銏℃殶閹?
     */\n    private function format_page( $page, $is_detail = false ) {\n        // 閼惧嘲褰囬悧纭呭閸ュ墽澧朶n        $thumbnail_id = get_post_thumbnail_id( $page->ID );\n        $thumbnail_url = $thumbnail_id ? wp_get_attachment_url( $thumbnail_id ) : '';\n        \n        // 閺嬪嫬缂撴い鐢告桨閺佺増宓乗n        $page_data = array(\n            'id' => $page->ID,\n            'title' => $page->post_title,\n            'slug' => $page->post_name,\n            'thumbnail' => $thumbnail_url,\n            'date' => $page->post_date,\n            'modified' => $page->post_modified,\n        );\n        \n        // 婵″倹鐏夐弰顖濐嚊閹懘銆夐敍灞惧潑閸旂姴鍞寸€?
        if ( $is_detail ) {\n            $content = apply_filters( 'the_content', $page->post_content );\n            \n            // 婢跺嫮鎮奌TML閸愬懎顔愰敍宀冩祮娑撴椽鈧倸鎮庣亸蹇曗柤鎼村繑妯夌粈铏规畱閺嶇厧绱n            $content = $this->process_content_for_mini_program( $content );\n            \n            $page_data['content'] = $content;\n            $page_data['url'] = get_permalink( $page->ID );\n        }\n        \n        return $page_data;\n    }\n    \n    /**\n     * 婢跺嫮鎮婇崘鍛啇娑撳搫鐨粙瀣碍闁倸鎮庨惃鍕壐瀵?
     *\n     * @param string $content HTML閸愬懎顔怽n     * @return string 婢跺嫮鎮婇崥搴ｆ畱閸愬懎顔怽n     */\n    private function process_content_for_mini_program( $content ) {\n        // 閺囨寧宕查悧瑙勭暕鐎涙顑乗n        $content = str_replace( array( '<', '>', '&' ), array( '&lt;', '&gt;', '&amp;' ), $content );\n        \n        // 婢跺嫮鎮婇崶鍓у\n        $content = preg_replace_callback( '/<img[^>]+src=["\']([^"\']+)["\'][^>]*>/i', function( $matches ) {\n            $src = $matches[1];\n            // 绾喕绻氶崶鍓уURL閺勵垳绮风€电鐭惧?
            if ( 0 !== strpos( $src, 'http' ) ) {\n                $src = site_url() . $src;\n            }\n            return '<img src="' . $src . '" mode="aspectFit" />';\n        }, $content );\n        \n        // 婢跺嫮鎮婇柧鐐复\n        $content = preg_replace_callback( '/<a[^>]+href=["\']([^"\']+)["\'][^>]*>(.*?)<\/a>/i', function( $matches ) {\n            $href = $matches[1];\n            $text = $matches[2];\n            return '<text class="link" data-href="' . $href . '">' . $text . '</text>';\n        }, $content );\n        \n        // 婢跺嫮鎮婄憴鍡涱暥\n        $content = preg_replace_callback( '/<video[^>]+src=["\']([^"\']+)["\'][^>]*>/i', function( $matches ) {\n            $src = $matches[1];\n            // 绾喕绻氱憴鍡涱暥URL閺勵垳绮风€电鐭惧?
            if ( 0 !== strpos( $src, 'http' ) ) {\n                $src = site_url() . $src;\n            }\n            return '<video src="' . $src . '" controls></video>';\n        }, $content );\n        \n        // 婢跺嫮鎮婇棅鎶筋暥\n        $content = preg_replace_callback( '/<audio[^>]+src=["\']([^"\']+)["\'][^>]*>/i', function( $matches ) {\n            $src = $matches[1];\n            // 绾喕绻氶棅鎶筋暥URL閺勵垳绮风€电鐭惧?
            if ( 0 !== strpos( $src, 'http' ) ) {\n                $src = site_url() . $src;\n            }\n            return '<audio src="' . $src . '" controls></audio>';\n        }, $content );\n        \n        // 婢跺嫮鎮婃禒锝囩垳閸?
        $content = preg_replace( '/<pre[^>]*><code[^>]*>(.*?)<\/code><\/pre>/is', '<view class="code-block"><text>$1</text></view>', $content );\n        \n        // 婢跺嫮鎮婄悰銊︾壐\n        $content = preg_replace( '/<table[^>]*>(.*?)<\/table>/is', '<view class="table-container">$1</view>', $content );\n        \n        return $content;\n    }\n    \n    /**\n     * 鎼存梻鏁ら弬鍥╃彿閺屻儴顕楁潻鍥ㄦ姢閺夆€叉\n     *\n     * @param array $args 閺屻儴顕楅崣鍌涙殶\n     * @param array $data 鐠囬攱鐪伴弫鐗堝祦\n     * @return array 娣囶喗鏁奸崥搴ｆ畱閺屻儴顕楅崣鍌涙殶\n     */\n    private function apply_post_query_filters( $args, $data ) {\n        // 閺嶈宓侀崚鍡欒鏉╁洦鎶n        if ( isset( $data['category'] ) && ! empty( $data['category'] ) ) {\n            $args['category__in'] = array_map( 'intval', explode( ',', $data['category'] ) );\n        }\n        \n        // 閺嶈宓侀弽鍥╊劮鏉╁洦鎶n        if ( isset( $data['tag'] ) && ! empty( $data['tag'] ) ) {\n            $args['tag__in'] = array_map( 'intval', explode( ',', $data['tag'] ) );\n        }\n        \n        // 閺嶈宓佹担婊嗏偓鍛扮箖濠?
        if ( isset( $data['author'] ) && ! empty( $data['author'] ) ) {\n            $args['author'] = $data['author'];\n        }\n        \n        // 閺嶈宓侀崣鎴濈閺冦儲婀℃潻鍥ㄦ姢\n        if ( isset( $data['start_date'] ) && ! empty( $data['start_date'] ) ) {\n            $args['date_query'][0]['after'] = $data['start_date'];\n        }\n        \n        if ( isset( $data['end_date'] ) && ! empty( $data['end_date'] ) ) {\n            $args['date_query'][0]['before'] = $data['end_date'];\n        }\n        \n        // 閺嶈宓侀懛顏勭暰娑斿鐡у▓浣冪箖濠?
        if ( isset( $data['meta_key'] ) && isset( $data['meta_value'] ) ) {\n            $args['meta_key'] = $data['meta_key'];\n            $args['meta_value'] = $data['meta_value'];\n            \n            if ( isset( $data['meta_compare'] ) ) {\n                $args['meta_compare'] = $data['meta_compare'];\n            }\n        }\n        \n        // 閺嶈宓侀幒鎺戠碍閺傜懓绱℃潻鍥ㄦ姢\n        if ( isset( $data['orderby'] ) && ! empty( $data['orderby'] ) ) {\n            $args['orderby'] = $data['orderby'];\n            \n            if ( isset( $data['order'] ) && ! empty( $data['order'] ) ) {\n                $args['order'] = $data['order'];\n            }\n        }\n        \n        return $args;\n    }\n    \n    /**\n     * 閼惧嘲褰囬弬鍥╃彿濞村繗顫嶉柌?
     *\n     * @param int $post_id 閺傚洨鐝稩D\n     * @return int 濞村繗顫嶉柌?
     */\n    private function get_post_views( $post_id ) {\n        $views = get_post_meta( $post_id, 'post_views_count', true );\n        return $views ? intval( $views ) : 0;\n    }\n    \n    /**\n     * 婢х偛濮為弬鍥╃彿濞村繗顫嶉柌?
     *\n     * @param int $post_id 閺傚洨鐝稩D\n     */\n    private function increase_post_views( $post_id ) {\n        $views = $this->get_post_views( $post_id );\n        update_post_meta( $post_id, 'post_views_count', $views + 1 );\n    }\n}\n