/**\n * 鏂囦欢鍚? list.js\n * 鐗堟湰鍙? 1.0.0\n * 更新日期: 2025-11-29\n * 描述: 閸掑棝鏀㈤崚妤勩€冩い鐢告桨\n */\n\nconst distributeService = require('../../services/distributeService');\nconst store = require('../../utils/store');\n\nPage({\n  data: {\n    distributeList: [],\n    status: 'all', // all/pending/approved/rejected/deleted\n    type: 'all', // all/product/article\n    page: 1,\n    pageSize: 20,\n    total: 0,\n    loading: false,\n    hasMore: true\n  },\n\n  onLoad(options) {\n    // 閸掓繂顫愰崠鏍ㄦ殶閹?
    this.setData({\n      status: options.status || 'all',\n      type: options.type || 'all'\n    });\n    this.getDistributeList();\n  },\n\n  onShow() {\n    // 妞ょ敻娼伴弰鍓с仛閺冭泛鍩涢弬鐗堟殶閹?
    this.setData({\n      page: 1,\n      distributeList: [],\n      hasMore: true\n    });\n    this.getDistributeList();\n  },\n\n  onReachBottom() {\n    // 鐟欙箑绨抽崝鐘烘祰閺囨潙顦縗n    if (!this.data.loading && this.data.hasMore) {\n      this.setData({\n        page: this.data.page + 1\n      });\n      this.getDistributeList();\n    }\n  },\n\n  onPullDownRefresh() {\n    // 娑撳濯洪崚閿嬫煀\n    this.setData({\n      page: 1,\n      distributeList: [],\n      hasMore: true\n    });\n    this.getDistributeList(() => {\n      wx.stopPullDownRefresh();\n    });\n  },\n\n  /**\n   * 閼惧嘲褰囬崚鍡涙敘閸掓銆僜n   * @param {Function} callback - 閸ョ偠鐨熼崙鑺ユ殶\n   */\n  getDistributeList(callback) {\n    if (this.data.loading) return;\n\n    this.setData({ loading: true });\n\n    distributeService.getDistributeList({\n      status: this.data.status,\n      type: this.data.type,\n      page: this.data.page,\n      pageSize: this.data.pageSize\n    })\n      .then(res => {\n        const newList = this.data.page === 1 ? res.list : [...this.data.distributeList, ...res.list];\n        this.setData({\n          distributeList: newList,\n          total: res.total,\n          hasMore: newList.length < res.total,\n          loading: false\n        });\n        if (callback) callback();\n      })\n      .catch(err => {\n        console.error('閼惧嘲褰囬崚鍡涙敘閸掓銆冩径杈Е:', err);\n        this.setData({ loading: false });\n        wx.showToast({\n          title: '閼惧嘲褰囬崚鍡涙敘閸掓銆冩径杈Е',\n          icon: 'none'\n        });\n        if (callback) callback();\n      });\n  },\n\n  /**\n   * 閸掑洦宕查悩鑸碘偓浣虹摣闁?
   * @param {Object} e - 娴滃娆㈢€电钖刓n   */\n  onStatusChange(e) {\n    this.setData({\n      status: e.detail.value,\n      page: 1,\n      distributeList: [],\n      hasMore: true\n    });\n    this.getDistributeList();\n  },\n\n  /**\n   * 閸掑洦宕茬猾璇茬€风粵娑⑩偓?
   * @param {Object} e - 娴滃娆㈢€电钖刓n   */\n  onTypeChange(e) {\n    this.setData({\n      type: e.detail.value,\n      page: 1,\n      distributeList: [],\n      hasMore: true\n    });\n    this.getDistributeList();\n  },\n\n  /**\n   * 鐠哄疇娴嗛崚鏉垮瀻闁库偓鐠囷附鍎廫n   * @param {Object} e - 娴滃娆㈢€电钖刓n   */\n  goToDetail(e) {\n    const id = e.currentTarget.dataset.id;\n    wx.navigateTo({\n      url: `/pages/distribute/detail?id=${id}`\n    });\n  },\n\n  /**\n   * 鐎光剝鐗抽崚鍡涙敘\n   * @param {Object} e - 娴滃娆㈢€电钖刓n   */\n  approveDistribute(e) {\n    const id = e.currentTarget.dataset.id;\n    wx.showModal({\n      title: '鐎光剝鐗抽崚鍡涙敘',\n      content: '绾喖鐣剧憰浣割吀閺嶆悂鈧俺绻冪拠銉ュ瀻闁库偓閸氭绱?,\n      success: (res) => {\n        if (res.confirm) {\n          this.handleApprove(id);\n        }\n      }\n    });\n  },\n\n  /**\n   * 婢跺嫮鎮婄€光剝鐗抽柅姘崇箖\n   * @param {string} id - 閸掑棝鏀D\n   */\n  handleApprove(id) {\n    wx.showLoading({\n      title: '鐎光剝鐗虫稉?..'\n    });\n\n    distributeService.approveDistribute(id)\n      .then(() => {\n        wx.hideLoading();\n        wx.showToast({\n          title: '鐎光剝鐗抽柅姘崇箖閹存劕濮?\n        });\n        // 閸掗攱鏌婇崚妤勩€僜n        this.setData({\n          page: 1,\n          distributeList: [],\n          hasMore: true\n        });\n        this.getDistributeList();\n      })\n      .catch(err => {\n        wx.hideLoading();\n        console.error('鐎光剝鐗抽柅姘崇箖婢惰精瑙?', err);\n        wx.showToast({\n          title: '鐎光剝鐗抽柅姘崇箖婢惰精瑙?,\n          icon: 'none'\n        });\n      });\n  },\n\n  /**\n   * 妞瑰啿娲栭崚鍡涙敘\n   * @param {Object} e - 娴滃娆㈢€电钖刓n   */\n  rejectDistribute(e) {\n    const id = e.currentTarget.dataset.id;\n    wx.showModal({\n      title: '妞瑰啿娲栭崚鍡涙敘',\n      content: '绾喖鐣剧憰渚€鈹忛崶鐐额嚉閸掑棝鏀㈤崥妤嬬吹',\n      success: (res) => {\n        if (res.confirm) {\n          this.showRejectReasonInput(id);\n        }\n      }\n    });\n  },\n\n  /**\n   * 閺勫墽銇氭す鍐叉礀閸樼喎娲滄潏鎾冲弳濡?
   * @param {string} id - 閸掑棝鏀D\n   */\n  showRejectReasonInput(id) {\n    wx.showModal({\n      title: '鐠囩柉绶崗銉┾攺閸ョ偛甯崶?,\n      editable: true,\n      placeholderText: '鐠囩柉绶崗銉┾攺閸ョ偛甯崶?,\n      success: (res) => {\n        if (res.confirm && res.content.trim()) {\n          this.handleReject(id, res.content.trim());\n        }\n      }\n    });\n  },\n\n  /**\n   * 婢跺嫮鎮婃す鍐叉礀\n   * @param {string} id - 閸掑棝鏀D\n   * @param {string} reason - 妞瑰啿娲栭崢鐔锋礈\n   */\n  handleReject(id, reason) {\n    wx.showLoading({\n      title: '妞瑰啿娲栨稉?..'\n    });\n\n    distributeService.rejectDistribute(id, reason)\n      .then(() => {\n        wx.hideLoading();\n        wx.showToast({\n          title: '妞瑰啿娲栭幋鎰'\n        });\n        // 閸掗攱鏌婇崚妤勩€僜n        this.setData({\n          page: 1,\n          distributeList: [],\n          hasMore: true\n        });\n        this.getDistributeList();\n      })\n      .catch(err => {\n        wx.hideLoading();\n        console.error('妞瑰啿娲栨径杈Е:', err);\n        wx.showToast({\n          title: '妞瑰啿娲栨径杈Е',\n          icon: 'none'\n        });\n      });\n  },\n\n  /**\n   * 閸掔娀娅庨崚鍡涙敘\n   * @param {Object} e - 娴滃娆㈢€电钖刓n   */\n  deleteDistribute(e) {\n    const id = e.currentTarget.dataset.id;\n    wx.showModal({\n      title: '閸掔娀娅庨崚鍡涙敘',\n      content: '绾喖鐣剧憰浣稿灩闂勩倛顕氶崚鍡涙敘閸氭绱?,\n      success: (res) => {\n        if (res.confirm) {\n          this.showDeleteReasonInput(id);\n        }\n      }\n    });\n  },\n\n  /**\n   * 閺勫墽銇氶崚鐘绘珟閸樼喎娲滄潏鎾冲弳濡?
   * @param {string} id - 閸掑棝鏀D\n   */\n  showDeleteReasonInput(id) {\n    wx.showModal({\n      title: '鐠囩柉绶崗銉ュ灩闂勩倕甯崶?,\n      editable: true,\n      placeholderText: '鐠囩柉绶崗銉ュ灩闂勩倕甯崶?,\n      success: (res) => {\n        if (res.confirm && res.content.trim()) {\n          this.handleDelete(id, res.content.trim());\n        }\n      }\n    });\n  },\n\n  /**\n   * 婢跺嫮鎮婇崚鐘绘珟\n   * @param {string} id - 閸掑棝鏀D\n   * @param {string} reason - 閸掔娀娅庨崢鐔锋礈\n   */\n  handleDelete(id, reason) {\n    wx.showLoading({\n      title: '閸掔娀娅庢稉?..'\n    });\n\n    distributeService.deleteDistribute(id, reason)\n      .then(() => {\n        wx.hideLoading();\n        wx.showToast({\n          title: '閸掔娀娅庨幋鎰'\n        });\n        // 閸掗攱鏌婇崚妤勩€僜n        this.setData({\n          page: 1,\n          distributeList: [],\n          hasMore: true\n        });\n        this.getDistributeList();\n      })\n      .catch(err => {\n        wx.hideLoading();\n        console.error('閸掔娀娅庢径杈Е:', err);\n        wx.showToast({\n          title: '閸掔娀娅庢径杈Е',\n          icon: 'none'\n        });\n      });\n  }\n});
