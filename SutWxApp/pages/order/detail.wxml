锘?!-- detail.wxml - 鐠併垹宕熺拠锔藉剰妞ょ敻娼板Ο鈩冩緲 -->

<view class="order-detail-container">
  <!-- 妞ゅ爼鍎寸€佃壈鍩?-->
  <view class="nav-bar">
    <view class="nav-back" bindtap="navigateBack">
      <text>鏉╂柨娲?/text>
    </view>
    <view class="nav-title">鐠併垹宕熺拠锔藉剰</view>
    <view class="nav-placeholder"></view>
  </view>

  <!-- 閸旂姾娴囨稉顓犲Ц閹?-->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading">
      <text>閸旂姾娴囨稉?..</text>
    </view>
  </view>

  <!-- 闁挎瑨顕ら悩鑸碘偓?-->
  <view class="error-container" wx:if="{{error}}">
    <view class="error-message">{{errorMessage}}</view>
    <button class="btn-primary" bindtap="refreshOrder">闁插秵鏌婇崝鐘烘祰</button>
  </view>

  <!-- 鐠併垹宕熺拠锔藉剰閸愬懎顔?-->
  <view class="order-content" wx:if="{{!loading && !error && orderDetail}}">
    <!-- 鐠併垹宕熼悩鑸碘偓?-->
    <view class="order-status-section" style="background-color: {{statusColor}};">
      <view class="status-text">{{statusText}}</view>
      <view wx:if="{{countdown > 0}}" class="countdown-text">
        鐠囧嘲婀?{{formatCountdown(countdown)}} 閸愬懎鐣幋鎰暜娴?      </view>
    </view>

    <!-- 閺€鎯版彛閸︽澘娼?-->
    <view class="section address-section">
      <view class="section-header">閺€鎯版彛娣団剝浼?/view>
      <view class="address-content" wx:if="{{addressInfo}}">
        <view class="address-name-phone">
          <text class="address-name">{{addressInfo.receiver_name}}</text>
          <text class="address-phone">{{addressInfo.receiver_phone}}</text>
        </view>
        <view class="address-detail">{{addressInfo.province}}{{addressInfo.city}}{{addressInfo.district}}{{addressInfo.detail_address}}</view>
      </view>
    </view>

    <!-- 鐠併垹宕熼崯鍡楁惂 -->
    <view class="section goods-section">
      <view class="section-header">閸熷棗鎼ф穱鈩冧紖</view>
      <view class="goods-list">
        <view 
          wx:for="{{orderItems}}" 
          wx:key="index" 
          class="goods-item" 
          bindtap="goToProductDetail" 
          data-id="{{item.product_id}}"
        >
          <view class="goods-image">
            <image src="{{item.product_image}}" mode="aspectFit"></image>
          </view>
          <view class="goods-info">
            <view class="goods-name">{{item.product_name}}</view>
            <view wx:if="{{item.specs}}" class="goods-specs">{{item.specs}}</view>
            <view class="goods-price-quantity">
              <view class="goods-price">妤納{item.price}}</view>
              <view class="goods-quantity">x{{item.quantity}}</view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 鐠併垹宕熸穱鈩冧紖 -->
    <view class="section order-info-section">
      <view class="section-header">鐠併垹宕熸穱鈩冧紖</view>
      <view class="info-item">
        <view class="info-label">鐠併垹宕熺紓鏍у娇</view>
        <view class="info-value">{{orderDetail.order_no}}</view>
      </view>
      <view class="info-item">
        <view class="info-label">娑撳宕熼弮鍫曟？</view>
        <view class="info-value">{{orderDetail.formatted_created_at}}</view>
      </view>
      <view class="info-item" wx:if="{{orderDetail.payment_method}}">
        <view class="info-label">閺€顖欑帛閺傜懓绱?/view>
        <view class="info-value">{{orderDetail.payment_method === 'wechat' ? '瀵邦喕淇婇弨顖欑帛' : orderDetail.payment_method === 'alipay' ? '閺€顖欑帛鐎? : '閸忔湹绮弬鐟扮础'}}</view>
      </view>
      <view class="info-item" wx:if="{{orderDetail.payment_time}}">
        <view class="info-label">閺€顖欑帛閺冨爼妫?/view>
        <view class="info-value">{{orderDetail.payment_time}}</view>
      </view>
      <view class="info-item" wx:if="{{orderDetail.shipping_no}}">
        <view class="info-label">閻椻晜绁﹂崡鏇炲娇</view>
        <view class="info-value">{{orderDetail.shipping_no}}</view>
      </view>
      <view class="info-item" wx:if="{{orderDetail.remark}}">
        <view class="info-label">鐠併垹宕熸径鍥ㄦ暈</view>
        <view class="info-value remark">{{orderDetail.remark}}</view>
      </view>
    </view>

    <!-- 鐠愬湱鏁ら弰搴ｇ矎 -->
    <view class="section cost-section">
      <view class="section-header">鐠愬湱鏁ら弰搴ｇ矎</view>
      <view class="cost-item">
        <view class="cost-label">閸熷棗鎼ч幀濠氼杺</view>
        <view class="cost-value">妤納{orderDetail.total_amount - orderDetail.shipping_fee}}</view>
      </view>
      <view class="cost-item">
        <view class="cost-label">鏉╂劘鍨?/view>
        <view class="cost-value">妤納{orderDetail.shipping_fee}}</view>
      </view>
      <view class="cost-item" wx:if="{{orderDetail.coupon_amount > 0}}">
        <view class="cost-label">娴兼ɑ鍎崚?/view>
        <view class="cost-value">-妤納{orderDetail.coupon_amount}}</view>
      </view>
      <view class="cost-item total">
        <view class="cost-label">鐎圭偘绮柌鎴︻杺</view>
        <view class="cost-value total-price">妤納{orderDetail.total_amount}}</view>
      </view>
    </view>
  </view>

  <!-- 閹垮秳缍旈幐澶愭尦 -->
  <view class="action-bar" wx:if="{{!loading && !error && orderDetail && availableActions.length > 0}}">
    <view class="actions">
      <block wx:if="{{availableActions.indexOf('cancelOrder') !== -1}}">
        <button class="btn-secondary" bindtap="cancelOrder">閸欐牗绉风拋銏犲礋</button>
      </block>
      <block wx:if="{{availableActions.indexOf('goToPay') !== -1}}">
        <button class="btn-primary" bindtap="goToPay">閸樼粯鏁禒?/button>
      </block>
      <block wx:if="{{availableActions.indexOf('viewLogistics') !== -1}}">
        <button class="btn-secondary" bindtap="viewLogistics">閺屻儳婀呴悧鈺傜ウ</button>
      </block>
      <block wx:if="{{availableActions.indexOf('confirmReceipt') !== -1}}">
        <button class="btn-primary" bindtap="confirmReceipt">绾喛顓婚弨鎯版彛</button>
      </block>
      <block wx:if="{{availableActions.indexOf('buyAgain') !== -1}}">
        <button class="btn-secondary" bindtap="buyAgain">閸愬秵顐肩拹顓濇嫳</button>
      </block>
      <block wx:if="{{availableActions.indexOf('reviewOrder') !== -1}}">
        <button class="btn-primary" bindtap="reviewOrder">鐠囧嫪鐜拋銏犲礋</button>
      </block>
      <block wx:if="{{availableActions.indexOf('applyInvoice') !== -1}}">
        <button class="btn-secondary" bindtap="applyInvoice">閻㈠疇顕崣鎴犮偍</button>
      </block>
      <block wx:if="{{availableActions.indexOf('deleteOrder') !== -1}}">
        <button class="btn-secondary" bindtap="deleteOrder">閸掔娀娅庣拋銏犲礋</button>
      </block>
      <block wx:if="{{availableActions.indexOf('contactService') !== -1}}">
        <button class="btn-secondary" bindtap="contactService">閼辨梻閮寸€广垺婀?/button>
      </block>
    </view>
  </view>

  <!-- 閻椻晜绁︽穱鈩冧紖瀵湱鐛?-->
  <view class="logistics-popup" wx:if="{{logisticsVisible}}">
    <view class="popup-header">
      <view class="popup-title">閻椻晜绁︽穱鈩冧紖</view>
      <view class="popup-close" bindtap="closeLogistics">閸忔娊妫?/view>
    </view>
    <view class="popup-content">
      <view class="logistics-company" wx:if="{{logisticsInfo}}">
        <text>{{logisticsInfo.company_name}} {{logisticsInfo.tracking_number}}</text>
      </view>
      <view class="logistics-timeline">
        <view 
          wx:for="{{logisticsInfo && logisticsInfo.timeline ? logisticsInfo.timeline : []}}" 
          wx:key="index" 
          class="timeline-item {{index === 0 ? 'active' : ''}}"
        >
          <view class="timeline-dot"></view>
          <view class="timeline-line"></view>
          <view class="timeline-content">
            <view class="timeline-text">{{item.content}}</view>
            <view class="timeline-time">{{item.time}}</view>
          </view>
        </view>
      </view>
      <view class="empty-logistics" wx:if="{{(!logisticsInfo || !logisticsInfo.timeline || logisticsInfo.timeline.length === 0)}}">
        <text>閺嗗倹妫ら悧鈺傜ウ娣団剝浼?/text>
      </view>
    </view>
  </view>

  <!-- 闁喚鍍电仦?-->
  <view class="overlay" wx:if="{{logisticsVisible}}" bindtap="closeLogistics"></view>
</view>\n