<!-- 积分任务页面 -->
<view class="points-tasks-page">
  <!-- 顶部导航栏 -->
  <view class="top-nav">
    <view class="nav-item {{selectedType === 'all' ? 'active' : ''}}" bindtap="switchTaskType" data-type="all">
      {{t('all_tasks')}}
    </view>
    <view class="nav-item {{selectedType === 'once' ? 'active' : ''}}" bindtap="switchTaskType" data-type="once">
      {{t('newbie_tasks')}}
    </view>
    <view class="nav-item {{selectedType === 'daily' ? 'active' : ''}}" bindtap="switchTaskType" data-type="daily">
      {{t('daily_tasks')}}
    </view>
    <view class="nav-item {{selectedType === 'weekly' ? 'active' : ''}}" bindtap="switchTaskType" data-type="weekly">
      {{t('weekly_tasks')}}
    </view>
    <view class="nav-item {{selectedType === 'monthly' ? 'active' : ''}}" bindtap="switchTaskType" data-type="monthly">
      {{t('monthly_tasks')}}
    </view>
  </view>

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text>{{t('loading')}}</text>
  </view>

  <!-- 错误状态 -->
  <view wx:elif="{{error}}" class="error-container">
    <image src="/images/error-icon.png" class="error-icon" mode="aspectFit"></image>
    <text class="error-message">{{error}}</text>
    <button class="retry-button" bindtap="onRetry">{{t('retry')}}</button>
  </view>

  <!-- 任务列表 -->
  <view wx:else class="tasks-container">
    <!-- 新手任务 -->
    <view wx:if="{{taskGroups.once.length > 0 && (selectedType === 'all' || selectedType === 'once')}}" class="task-section">
      <view class="section-header">
        <text class="section-title">{{t('newbie_tasks')}}</text>
        <text class="task-count">{{taskGroups.once.length}}</text>
      </view>
      <view class="task-list">
        <view wx:for="{{taskGroups.once}}" wx:key="id" 
              class="task-item {{item.isCompleted ? 'completed' : ''}} {{item.isUnclaimed ? 'unclaimed' : ''}}"
              bindtap="handleTask" data-id="{{item.id}}">
          <view class="task-icon-container">
            <view class="task-icon {{item.category}}">
              <image src="{{item.iconUrl || '/images/task-icons/' + item.category + '.png'}}" mode="aspectFit"></image>
            </view>
          </view>
          
          <view class="task-content">
            <view class="task-title">{{item.title}}</view>
            <view class="task-desc">{{item.description || item.desc}}</view>
            <view class="task-info">
              <view wx:if="{{item.totalSteps > 0}}" class="task-progress">
                <view class="progress-bar">
                  <view class="progress-fill" style="width: {{(item.progress / item.totalSteps) * 100}}%"></view>
                </view>
                <text class="progress-text">{{item.progress}}/{{item.totalSteps}}</text>
              </view>
              <view class="task-reward">
                <image src="/images/point-icon.png" class="point-icon" mode="aspectFit"></image>
                <text class="point-text">+{{item.points}}</text>
              </view>
            </view>
          </view>
          
          <view class="task-action">
            <view wx:if="{{item.isCompleted && !item.isUnclaimed}}" class="completed-badge">
              {{t('completed')}}
            </view>
            <view wx:elif="{{item.isUnclaimed || item.status === 'completed'}}" class="claim-button">
              {{t('claim_reward')}}
            </view>
            <view wx:else class="go-button">
              {{t('go_do')}}
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 每日任务 -->
    <view wx:if="{{taskGroups.daily.length > 0 && (selectedType === 'all' || selectedType === 'daily')}}" class="task-section">
      <view class="section-header">
        <text class="section-title">{{t('daily_tasks')}}</text>
        <text class="task-count">{{taskGroups.daily.length}}</text>
      </view>
      <view class="task-list">
        <view wx:for="{{taskGroups.daily}}" wx:key="id" 
              class="task-item {{item.isCompleted ? 'completed' : ''}} {{item.isUnclaimed ? 'unclaimed' : ''}}"
              bindtap="handleTask" data-id="{{item.id}}">
          <view class="task-icon-container">
            <view class="task-icon {{item.category}}">
              <image src="{{item.iconUrl || '/images/task-icons/' + item.category + '.png'}}" mode="aspectFit"></image>
            </view>
          </view>
          
          <view class="task-content">
            <view class="task-title">{{item.title}}</view>
            <view class="task-desc">{{item.description || item.desc}}</view>
            <view class="task-info">
              <view wx:if="{{item.totalSteps > 0}}" class="task-progress">
                <view class="progress-bar">
                  <view class="progress-fill" style="width: {{(item.progress / item.totalSteps) * 100}}%"></view>
                </view>
                <text class="progress-text">{{item.progress}}/{{item.totalSteps}}</text>
              </view>
              <view class="task-reward">
                <image src="/images/point-icon.png" class="point-icon" mode="aspectFit"></image>
                <text class="point-text">+{{item.points}}</text>
              </view>
            </view>
          </view>
          
          <view class="task-action">
            <view wx:if="{{item.isCompleted && !item.isUnclaimed}}" class="completed-badge">
              {{t('completed')}}
            </view>
            <view wx:elif="{{item.isUnclaimed || item.status === 'completed'}}" class="claim-button">
              {{t('claim_reward')}}
            </view>
            <view wx:else class="go-button">
              {{t('go_do')}}
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 每周任务 -->
    <view wx:if="{{taskGroups.weekly.length > 0 && (selectedType === 'all' || selectedType === 'weekly')}}" class="task-section">
      <view class="section-header">
        <text class="section-title">{{t('weekly_tasks')}}</text>
        <text class="task-count">{{taskGroups.weekly.length}}</text>
      </view>
      <view class="task-list">
        <view wx:for="{{taskGroups.weekly}}" wx:key="id" 
              class="task-item {{item.isCompleted ? 'completed' : ''}} {{item.isUnclaimed ? 'unclaimed' : ''}}"
              bindtap="handleTask" data-id="{{item.id}}">
          <view class="task-icon-container">
            <view class="task-icon {{item.category}}">
              <image src="{{item.iconUrl || '/images/task-icons/' + item.category + '.png'}}" mode="aspectFit"></image>
            </view>
          </view>
          
          <view class="task-content">
            <view class="task-title">{{item.title}}</view>
            <view class="task-desc">{{item.description || item.desc}}</view>
            <view class="task-info">
              <view wx:if="{{item.totalSteps > 0}}" class="task-progress">
                <view class="progress-bar">
                  <view class="progress-fill" style="width: {{(item.progress / item.totalSteps) * 100}}%"></view>
                </view>
                <text class="progress-text">{{item.progress}}/{{item.totalSteps}}</text>
              </view>
              <view class="task-reward">
                <image src="/images/point-icon.png" class="point-icon" mode="aspectFit"></image>
                <text class="point-text">+{{item.points}}</text>
              </view>
            </view>
          </view>
          
          <view class="task-action">
            <view wx:if="{{item.isCompleted && !item.isUnclaimed}}" class="completed-badge">
              {{t('completed')}}
            </view>
            <view wx:elif="{{item.isUnclaimed || item.status === 'completed'}}" class="claim-button">
              {{t('claim_reward')}}
            </view>
            <view wx:else class="go-button">
              {{t('go_do')}}
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 每月任务 -->
    <view wx:if="{{taskGroups.monthly.length > 0 && (selectedType === 'all' || selectedType === 'monthly')}}" class="task-section">
      <view class="section-header">
        <text class="section-title">{{t('monthly_tasks')}}</text>
        <text class="task-count">{{taskGroups.monthly.length}}</text>
      </view>
      <view class="task-list">
        <view wx:for="{{taskGroups.monthly}}" wx:key="id" 
              class="task-item {{item.isCompleted ? 'completed' : ''}} {{item.isUnclaimed ? 'unclaimed' : ''}}"
              bindtap="handleTask" data-id="{{item.id}}">
          <view class="task-icon-container">
            <view class="task-icon {{item.category}}">
              <image src="{{item.iconUrl || '/images/task-icons/' + item.category + '.png'}}" mode="aspectFit"></image>
            </view>
          </view>
          
          <view class="task-content">
            <view class="task-title">{{item.title}}</view>
            <view class="task-desc">{{item.description || item.desc}}</view>
            <view class="task-info">
              <view wx:if="{{item.totalSteps > 0}}" class="task-progress">
                <view class="progress-bar">
                  <view class="progress-fill" style="width: {{(item.progress / item.totalSteps) * 100}}%"></view>
                </view>
                <text class="progress-text">{{item.progress}}/{{item.totalSteps}}</text>
              </view>
              <view class="task-reward">
                <image src="/images/point-icon.png" class="point-icon" mode="aspectFit"></image>
                <text class="point-text">+{{item.points}}</text>
              </view>
            </view>
          </view>
          
          <view class="task-action">
            <view wx:if="{{item.isCompleted && !item.isUnclaimed}}" class="completed-badge">
              {{t('completed')}}
            </view>
            <view wx:elif="{{item.isUnclaimed || item.status === 'completed'}}" class="claim-button">
              {{t('claim_reward')}}
            </view>
            <view wx:else class="go-button">
              {{t('go_do')}}
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 空状态 -->
    <view wx:if="{{tasks.length === 0}}" class="empty-container">
      <image src="/images/empty-tasks.png" class="empty-icon" mode="aspectFit"></image>
      <text class="empty-text">{{t('no_tasks')}}</text>
    </view>
  </view>

  <!-- 底部操作栏 -->
  <view class="bottom-actions">
    <view class="action-item" bindtap="navigateToPointsMall">
      <image src="/images/mall-icon.png" mode="aspectFit"></image>
      <text>{{t('points_mall')}}</text>
    </view>
    <view class="action-item" bindtap="navigateToPointsRules">
      <image src="/images/rules-icon.png" mode="aspectFit"></image>
      <text>{{t('points_rules')}}</text>
    </view>
    <view class="action-item" bindtap="navigateToPointsRecords">
      <image src="/images/records-icon.png" mode="aspectFit"></image>
      <text>{{t('points_records')}}</text>
    </view>
  </view>
</view>