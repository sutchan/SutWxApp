/**
 * 鏂囦欢鍚? mall.wxml
 * 鐗堟湰鍙? 1.0.0
 * 鏇存柊鏃ユ湡: 2025-11-23
 * 鎻忚堪: mall 椤甸潰缁撴瀯鏂囦欢
 */
<!-- 绉垎鍟嗗煄椤甸潰 -->
<view class="mall-container">
  <!-- 鐢ㄦ埛绉垎淇℃伅 -->
  <view class="points-header">
    <view class="points-info">
      <text class="points-value">{{userPoints}}</text>
      <text class="points-label">鎴戠殑绉垎</text>
    </view>
    <view class="points-actions">
      <view class="action-item" bindtap="goToPoints">
        <text class="iconfont icon-earn"></text>
        <text class="action-text">璧氱Н鍒?/text>
      </view>
      <view class="action-item" bindtap="goToExchangeRecords">
        <text class="iconfont icon-record"></text>
        <text class="action-text">鍏戞崲璁板綍</text>
      </view>
    </view>
  </view>
  
  <!-- 鎼滅储鏍?-->
  <view class="search-bar">
    <view class="search-input-wrapper">
      <text class="iconfont icon-search"></text>
      <input class="search-input" 
             placeholder="鎼滅储鍟嗗搧" 
             value="{{searchKeyword}}" 
             bindinput="onSearchInput" 
             bindconfirm="onSearch" />
      <text wx:if="{{searchKeyword}}" class="iconfont icon-clear" bindtap="clearSearch"></text>
    </view>
  </view>
  
  <!-- 鍟嗗搧鍒嗙被 -->
  <view class="categories">
    <scroll-view scroll-x="true" class="categories-scroll">
      <view class="categories-list">
        <view wx:for="{{categories}}" wx:key="id" 
              class="category-item {{currentCategory === item.id ? 'active' : ''}}"
              data-id="{{item.id}}" bindtap="switchCategory">
          <text class="category-name">{{item.name}}</text>
          <view wx:if="{{item.count > 0}}" class="category-count">({{item.count}})</view>
        </view>
      </view>
    </scroll-view>
    
    <!-- 鎺掑簭鎸夐挳 -->
    <view class="sort-btn" bindtap="showSortPopup">
      <text class="iconfont icon-sort"></text>
    </view>
  </view>
  
  <!-- 鍟嗗搧鍒楄〃 -->
  <view class="products-container">
    <!-- 鍔犺浇鐘舵€?-->
    <view wx:if="{{loading && productList.length === 0}}" class="loading-container">
      <view class="loading-spinner"></view>
      <text class="loading-text">姝ｅ湪鍔犺浇鍟嗗搧...</text>
    </view>
    
    <!-- 鍟嗗搧鍒楄〃 -->
    <view wx:else class="products-list">
      <view wx:for="{{productList}}" wx:key="id" class="product-item">
        <!-- 鍟嗗搧鍥剧墖 -->
        <view class="product-image" data-id="{{item.id}}" bindtap="goToProductDetail">
          <image src="{{item.image}}" mode="aspectFill"></image>
          <view wx:if="{{item.stock <= 0}}" class="out-of-stock">宸插敭缃?/view>
          <view wx:elif="{{item.isHot}}" class="hot-tag">鐑棬</view>
        </view>
        
        <!-- 鍟嗗搧淇℃伅 -->
        <view class="product-info" data-id="{{item.id}}" bindtap="goToProductDetail">
          <view class="product-title">{{item.title}}</view>
          <view class="product-desc">{{item.description}}</view>
          
          <!-- 鍟嗗搧鏍囩 -->
          <view wx:if="{{item.tags && item.tags.length > 0}}" class="product-tags">
            <view wx:for="{{item.tags}}" wx:key="*this" wx:for-item="tag" class="tag">{{tag}}</view>
          </view>
          
          <!-- 鍏戞崲閲忓拰搴撳瓨 -->
          <view class="product-stats">
            <text class="exchange-count">宸插厬鎹{item.exchangeCount || 0}}浠?/text>
            <text class="stock">搴撳瓨{{item.stock}}</text>
          </view>
        </view>
        
        <!-- 绉垎鍜屾搷浣?-->
        <view class="product-footer">
          <view class="product-points">
            <text class="points-value">{{item.points}}</text>
            <text class="points-label">绉垎</text>
          </view>
          
          <button class="exchange-btn {{item.stock <= 0 || userPoints < item.points ? 'disabled' : ''}}" 
                  data-id="{{item.id}}" 
                  bindtap="exchangeProduct"
                  disabled="{{item.stock <= 0 || userPoints < item.points}}">
            {{item.stock <= 0 ? '宸插敭缃? : (userPoints < item.points ? '绉垎涓嶈冻' : '绔嬪嵆鍏戞崲')}}
          </button>
        </view>
      </view>
      
      <!-- 鍔犺浇鏇村 -->
      <view wx:if="{{hasMore && loading}}" class="loading-more">
        <view class="loading-spinner small"></view>
        <text class="loading-text">鍔犺浇鏇村...</text>
      </view>
      
      <!-- 娌℃湁鏇村鏁版嵁 -->
      <view wx:if="{{!hasMore && productList.length > 0}}" class="no-more">
        <text>娌℃湁鏇村鍟嗗搧浜?/text>
      </view>
      
      <!-- 绌虹姸鎬?-->
      <view wx:if="{{productList.length === 0 && !loading}}" class="empty-state">
        <view class="empty-icon"></view>
        <text class="empty-text">鏆傛棤鍟嗗搧</text>
        <text class="empty-desc">褰撳墠鍒嗙被涓嬫病鏈夊晢鍝?/text>
      </view>
    </view>
  </view>
  
  <!-- 鏈€杩戝厬鎹㈣褰?-->
  <view wx:if="{{exchangeRecords.length > 0}}" class="recent-exchanges">
    <view class="section-header">
      <text class="section-title">鏈€杩戝厬鎹?/text>
      <text class="section-more" bindtap="goToExchangeRecords">鏌ョ湅鍏ㄩ儴</text>
    </view>
    
    <view class="exchange-list">
      <view wx:for="{{exchangeRecords}}" wx:key="id" class="exchange-item">
        <image class="exchange-image" src="{{item.productImage}}" mode="aspectFill"></image>
        <view class="exchange-info">
          <view class="exchange-title">{{item.productTitle}}</view>
          <view class="exchange-time">{{formatTime(item.createTime)}}</view>
        </view>
        <view class="exchange-points">-{{item.points}}</view>
      </view>
    </view>
  </view>
</view>

<!-- 鎺掑簭寮圭獥 -->
<view wx:if="{{showSortPopup}}" class="sort-popup">
  <view class="popup-mask" bindtap="hideSortPopup"></view>
  <view class="popup-content">
    <view class="popup-header">
      <text class="popup-title">鎺掑簭鏂瑰紡</text>
      <text class="popup-close" bindtap="hideSortPopup">脳</text>
    </view>
    
    <view class="sort-options">
      <view wx:for="{{sortOptions}}" wx:key="key" 
            class="sort-option {{currentSort === item.key ? 'active' : ''}}"
            data-sort="{{item.key}}" bindtap="selectSort">
        <text class="option-name">{{item.name}}</text>
        <text wx:if="{{currentSort === item.key}}" class="iconfont icon-check"></text>
      </view>
    </view>
  </view>
</view>