/**
 * 文件名 mall.wxml
 * 版本号 1.0.0
 * 更新日期: 2025-12-04
 * 描述: mall 妞ょ敻娼扮紒鎾寸€弬鍥︽
 */
<!-- 缁夘垰鍨庨崯鍡楃厔妞ょ敻娼?-->
<view class="mall-container">
  <!-- 閻劍鍩涚粔顖氬瀻娣団剝浼?-->
  <view class="points-header">
    <view class="points-info">
      <text class="points-value">{{userPoints}}</text>
      <text class="points-label">閹存垹娈戠粔顖氬瀻</text>
    </view>
    <view class="points-actions">
      <view class="action-item" bindtap="goToPoints">
        <text class="iconfont icon-earn"></text>
        <text class="action-text">鐠ф氨袧閸?/text>
      </view>
      <view class="action-item" bindtap="goToExchangeRecords">
        <text class="iconfont icon-record"></text>
        <text class="action-text">閸忔垶宕茬拋鏉跨秿</text>
      </view>
    </view>
  </view>
  
  <!-- 閹兼粎鍌ㄩ弽?-->
  <view class="search-bar">
    <view class="search-input-wrapper">
      <text class="iconfont icon-search"></text>
      <input class="search-input" 
             placeholder="閹兼粎鍌ㄩ崯鍡楁惂" 
             value="{{searchKeyword}}" 
             bindinput="onSearchInput" 
             bindconfirm="onSearch" />
      <text wx:if="{{searchKeyword}}" class="iconfont icon-clear" bindtap="clearSearch"></text>
    </view>
  </view>
  
  <!-- 閸熷棗鎼ч崚鍡欒 -->
  <view class="categories">
    <scroll-view scroll-x="true" class="categories-scroll">
      <view class="categories-list">
        <view wx:for="{{categories}}" wx:key="id" 
              class="category-item {{currentCategory === item.id ? 'active' : ''}}"
              data-id="{{item.id}}" bindtap="switchCategory">
          <text class="category-name">{{item.name}}</text>
          <view wx:if="{{item.count > 0}}" class="category-count">({{item.count}})</view>
        </view>
      </view>
    </scroll-view>
    
    <!-- 閹烘帒绨幐澶愭尦 -->
    <view class="sort-btn" bindtap="showSortPopup">
      <text class="iconfont icon-sort"></text>
    </view>
  </view>
  
  <!-- 閸熷棗鎼ч崚妤勩€?-->
  <view class="products-container">
    <!-- 加载状态->
    <view wx:if="{{loading && productList.length === 0}}" class="loading-container">
      <view class="loading-spinner"></view>
      <text class="loading-text">濮濓絽婀崝鐘烘祰閸熷棗鎼?..</text>
    </view>
    
    <!-- 閸熷棗鎼ч崚妤勩€?-->
    <view wx:else class="products-list">
      <view wx:for="{{productList}}" wx:key="id" class="product-item">
        <!-- 閸熷棗鎼ч崶鍓у -->
        <view class="product-image" data-id="{{item.id}}" bindtap="goToProductDetail">
          <image src="{{item.image}}" mode="aspectFill"></image>
          <view wx:if="{{item.stock <= 0}}" class="out-of-stock">瀹告彃鏁純?/view>
          <view wx:elif="{{item.isHot}}" class="hot-tag">閻戭參妫?/view>
        </view>
        
        <!-- 浜у搧淇℃伅 -->
        <view class="product-info" data-id="{{item.id}}" bindtap="goToProductDetail">
          <view class="product-title">{{item.title}}</view>
          <view class="product-desc">{{item.description}}</view>
          
          <!-- 閸熷棗鎼ч弽鍥╊劮 -->
          <view wx:if="{{item.tags && item.tags.length > 0}}" class="product-tags">
            <view wx:for="{{item.tags}}" wx:key="*this" wx:for-item="tag" class="tag">{{tag}}</view>
          </view>
          
          <!-- 閸忔垶宕查柌蹇撴嫲鎼存挸鐡?-->
          <view class="product-stats">
            <text class="exchange-count">瀹告彃鍘幑顣item.exchangeCount || 0}}娴?/text>
            <text class="stock">鎼存挸鐡▄{item.stock}}</text>
          </view>
        </view>
        
        <!-- 缁夘垰鍨庨崪灞炬惙娴?-->
        <view class="product-footer">
          <view class="product-points">
            <text class="points-value">{{item.points}}</text>
            <text class="points-label">缁夘垰鍨?/text>
          </view>
          
          <button class="exchange-btn {{item.stock <= 0 || userPoints < item.points ? 'disabled' : ''}}" 
                  data-id="{{item.id}}" 
                  bindtap="exchangeProduct"
                  disabled="{{item.stock <= 0 || userPoints < item.points}}">
            {{item.stock <= 0 ? '瀹告彃鏁純? : (userPoints < item.points ? '缁夘垰鍨庢稉宥堝喕' : '缁斿宓嗛崗鎴炲床')}}
          </button>
        </view>
      </view>
      
      <!-- 閸旂姾娴囬弴鏉戭樋 -->
      <view wx:if="{{hasMore && loading}}" class="loading-more">
        <view class="loading-spinner small"></view>
        <text class="loading-text">閸旂姾娴囬弴鏉戭樋...</text>
      </view>
      
      <!-- 濞屸剝婀侀弴鏉戭樋閺佺増宓?-->
      <view wx:if="{{!hasMore && productList.length > 0}}" class="no-more">
        <text>濞屸剝婀侀弴鏉戭樋閸熷棗鎼ф禍?/text>
      </view>
      
      <!-- 缁岃櫣濮搁幀?-->
      <view wx:if="{{productList.length === 0 && !loading}}" class="empty-state">
        <view class="empty-icon"></view>
        <text class="empty-text">閺嗗倹妫ら崯鍡楁惂</text>
        <text class="empty-desc">瑜版挸澧犻崚鍡欒娑撳鐥呴張澶婃櫌閸?/text>
      </view>
    </view>
  </view>
  
  <!-- 閺堚偓鏉╂垵鍘幑銏ｎ唶瑜?-->
  <view wx:if="{{exchangeRecords.length > 0}}" class="recent-exchanges">
    <view class="section-header">
      <text class="section-title">閺堚偓鏉╂垵鍘幑?/text>
      <text class="section-more" bindtap="goToExchangeRecords">閺屻儳婀呴崗銊╁劥</text>
    </view>
    
    <view class="exchange-list">
      <view wx:for="{{exchangeRecords}}" wx:key="id" class="exchange-item">
        <image class="exchange-image" src="{{item.productImage}}" mode="aspectFill"></image>
        <view class="exchange-info">
          <view class="exchange-title">{{item.productTitle}}</view>
          <view class="exchange-time">{{formatTime(item.createTime)}}</view>
        </view>
        <view class="exchange-points">-{{item.points}}</view>
      </view>
    </view>
  </view>
</view>

<!-- 閹烘帒绨鍦崶 -->
<view wx:if="{{showSortPopup}}" class="sort-popup">
  <view class="popup-mask" bindtap="hideSortPopup"></view>
  <view class="popup-content">
    <view class="popup-header">
      <text class="popup-title">閹烘帒绨弬鐟扮础</text>
      <text class="popup-close" bindtap="hideSortPopup">鑴?/text>
    </view>
    
    <view class="sort-options">
      <view wx:for="{{sortOptions}}" wx:key="key" 
            class="sort-option {{currentSort === item.key ? 'active' : ''}}"
            data-sort="{{item.key}}" bindtap="selectSort">
        <text class="option-name">{{item.name}}</text>
        <text wx:if="{{currentSort === item.key}}" class="iconfont icon-check"></text>
      </view>
    </view>
  </view>
</view>
