# 苏特微信小程序自动化构建和部署流程

## 1. 概述

本文档描述了苏特微信小程序(SutWxApp)的自动化构建和部署流程，包括构建脚本的使用方法、环境配置、版本管理以及部署策略。

## 2. 构建工具组成

项目的自动化构建系统主要由以下文件组成：

- **build/index.js**: 构建工具入口文件，提供命令行接口
- **build/build.js**: 核心构建脚本，包含构建、打包和部署逻辑
- **build/config.js**: 构建配置文件，定义不同环境的构建参数
- **version.json**: 版本信息文件（自动生成）
- **deploy-log.json**: 部署日志文件（自动生成）

## 3. 环境配置

构建系统支持三种环境配置：

| 环境 | 描述 | API基础URL | 压缩 | SourceMap | 自动上传 |
|------|------|------------|------|-----------|----------|
| dev | 开发环境 | https://dev-api.sutwxapp.com | 否 | 是 | 否 |
| test | 测试环境 | https://test-api.sutwxapp.com | 是 | 是 | 是 |
| prod | 生产环境 | https://api.sutwxapp.com | 是 | 否 | 是 |

## 4. 使用方法

### 4.1 基本命令

```bash
# 开发环境构建 (默认)
node build

# 测试环境构建
node build test

# 生产环境构建
node build prod

# 构建并部署
node build build-deploy prod

# 仅部署
node build deploy test

# 更新版本号（小版本）
node build version minor

# 运行代码检查
node build lint

# 显示帮助信息
node build help
```

### 4.2 高级选项

```bash
# 生产环境构建（跳过代码检查）
node build prod --no-lint

# 更新主版本号
node build version major

# 构建后强制上传
node build dev --upload
```

## 5. 构建流程

自动化构建流程包含以下步骤：

1. **清理工作区**：清理构建输出目录和临时文件
2. **代码检查**：运行ESLint检查代码质量（可选）
3. **版本更新**：根据配置更新版本号（语义化版本）
4. **复制源码**：将源代码复制到构建目录，排除不需要的文件
5. **复制配置**：复制必要的配置文件
6. **输出构建结果**：生成构建产物到dist目录
7. **记录版本**：更新版本信息文件

## 6. 部署流程

部署流程主要包括：

1. **构建项目**：首先执行构建流程
2. **部署到环境**：将构建产物部署到指定环境
3. **记录部署日志**：保存部署记录到deploy-log.json

> **注意**：当前版本的部署功能为模拟实现。实际部署微信小程序时，需要：
> 1. 安装微信开发者工具
> 2. 配置cliPath路径
> 3. 可能需要进行登录认证

## 7. 版本管理

项目使用**语义化版本规范(SemVer)**进行版本管理：

- **MAJOR** (主版本号): 不兼容的破坏性变更
- **MINOR** (次版本号): 向下兼容的新功能
- **PATCH** (修订号): 向下兼容的问题修复

版本信息会自动更新到：
- version.json 文件
- app.js 文件中的version字段

## 8. 构建产物

构建完成后，产物将生成在**dist目录**中，包含：

- miniprogram/: 小程序源码
- project.config.json: 微信开发者工具配置
- version.json: 版本信息

## 9. 注意事项

1. **Node.js环境**：确保安装了Node.js 16.0.0或更高版本
2. **微信开发者工具**：如需自动上传，需要正确配置cliPath路径
3. **权限问题**：确保有足够的文件系统权限
4. **版本冲突**：多团队成员同时构建时，注意版本号可能冲突
5. **环境变量**：不同环境的API地址等配置在config.js中管理

## 10. 故障排除

### 10.1 常见问题

**问题**：构建失败，提示缺少依赖
**解决**：运行 `npm install` 安装所需依赖

**问题**：版本号更新失败
**解决**：检查version.json文件权限是否正确

**问题**：部署失败
**解决**：确认微信开发者工具已正确安装并配置路径

### 10.2 日志查看

- 构建日志会输出到控制台
- 部署历史记录保存在deploy-log.json中

## 11. 持续集成/持续部署(CI/CD)建议

对于团队协作，可以将构建脚本集成到CI/CD系统中：

1. **GitLab CI**：创建.gitlab-ci.yml配置文件
2. **Jenkins**：创建Pipeline任务
3. **GitHub Actions**：配置workflow文件

基本CI/CD流程建议：

1. 代码提交到develop分支：自动构建并部署到测试环境
2. 合并请求到main/master分支：自动构建、测试并部署到生产环境
3. 定期构建：每天定时构建并运行测试

## 12. 版本历史

| 版本号 | 更新日期 | 更新内容 |
|--------|----------|----------|
| 1.0.0  | 2025-11-24 | 初始版本 |

---

*本文档将根据项目发展持续更新*