<!--
文件名: 01-运维手册.md
版本号: 1.0.0
更新日期: 2025-12-26
作者: Sut
描述: 详细的运维指南，包括部署架构、运维流程和故障处理
-->

# 运维手册

## 目录

[TOC]

## 1. 概述

### 1.1 文档目的

本文档旨在为 SutWxApp 微信小程序项目的运维人员提供详细的运维指南，包括系统架构、部署步骤、日常运维流程、监控方法和故障处理等内容，确保系统的稳定运行。

### 1.2 适用范围

- 运维人员
- 系统管理员
- 开发人员

## 2. 系统架构

### 2.1 整体架构

SutWxApp 项目采用前后端分离架构，主要包括以下组件：

1. **前端**：微信小程序
2. **后端**：Bun + TypeScript API 服务
3. **数据库**：
   - MySQL：存储用户数据、商品数据、订单数据等
   - Redis：存储热点数据、会话管理
   - MongoDB：存储日志数据、用户行为数据
4. **中间件**：
   - Nginx：反向代理、负载均衡
   - Redis：缓存服务
5. **第三方服务**：
   - 微信支付
   - 物流查询 API

### 2.2 系统架构图

```
+----------------+    +----------------+    +----------------+    +----------------+
| 微信小程序前端   |    |      Nginx      |    |    Bun API      |    |    MySQL       |
|  (微信开发者工具) |    |  反向代理/负载均衡 |    |    服务          |    |                |
|                |    |                |    |                 |    |                |
+----------------+    +----------------+    +----------------+    +----------------+
         |                     |                        |                     |
         |                     |                        |                     |
         |                     |                        |                     |
         |                     |                        |                     |
+----------------+    +----------------+    +----------------+    +----------------+
|  CDN资源        |    |      Redis      |    |    MongoDB      |    | 第三方服务      |
|                |    |  缓存/会话管理   |    |  日志/活动数据   |    | (微信支付, 物流) |
|                |    |                |    |                |    |                |
+----------------+    +----------------+    +----------------+    +----------------+
```

### 2.3 部署环境

| 环境类型 | 服务器配置 | 操作系统 | 部署方式 |
|---------|-----------|----------|----------|
| 开发环境 | 4C8G       | Ubuntu 22.04 | Docker Compose |
| 测试环境 | 8C16G      | Ubuntu 22.04 | Docker Compose |
| 生产环境 | 16C32G     | Ubuntu 22.04 | Kubernetes |

## 3. 部署步骤

### 3.1 开发环境部署

#### 3.1.1 环境准备

1. **安装 Docker 和 Docker Compose**
   ```bash
   # 安装 Docker
   curl -fsSL https://get.docker.com -o get-docker.sh
   sh get-docker.sh

   # 安装 Docker Compose
   curl -L "https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
   chmod +x /usr/local/bin/docker-compose
   ```

2. **克隆代码仓库**
   ```bash
   git clone https://github.com/sutchan/SutWxApp.git
   cd SutWxApp
   ```

#### 3.1.2 配置文件修改

1. **修改环境变量配置**
   ```bash
   cp .env.example .env
   # 编辑 .env 文件，配置数据库连接等信息
   vi .env
   ```

2. **修改 Docker Compose 配置**
   ```bash
   # 根据需要修改 docker-compose.yml 文件
   vi docker-compose.yml
   ```

#### 3.1.3 启动服务

```bash
docker-compose up -d
```

### 3.2 生产环境部署

#### 3.2.1 环境准备

1. **安装 Kubernetes**
   请参考 [Kubernetes 官方文档](https://kubernetes.io/docs/setup/) 进行安装。

2. **配置 kubectl**
   ```bash
   mkdir -p ~/.kube
   vi ~/.kube/config
   ```

#### 3.2.2 部署应用

1. **创建命名空间**
   ```bash
   kubectl create namespace sutwxapp
   ```

2. **部署配置**
   ```bash
   kubectl apply -f k8s/
   ```

3. **检查部署状态**
   ```bash
   kubectl get pods -n sutwxapp
   ```

## 4. 日常运维流程

### 4.1 日常检查

#### 4.1.1 服务状态检查

1. **检查 Pod 状态**
   ```bash
   kubectl get pods -n sutwxapp
   ```

2. **检查服务日志**
   ```bash
   kubectl logs -f <pod-name> -n sutwxapp
   ```

3. **检查资源使用**
   ```bash
   kubectl top pods -n sutwxapp
   ```

#### 4.1.2 数据库检查

1. **检查数据库连接**
   ```bash
   mysql -u root -p -e "SHOW STATUS LIKE 'Threads_connected';"
   ```

2. **检查慢查询**
   ```bash
   mysql -u root -p -e "SHOW GLOBAL STATUS LIKE 'Slow_queries';"
   ```

### 4.2 备份与恢复

#### 4.2.1 数据库备份

1. **MySQL 备份**
   ```bash
   mysqldump -u root -p sutwxapp > backup/sutwxapp_$(date +%Y%m%d).sql
   ```

2. **Redis 备份**
   ```bash
   redis-cli BGSAVE
   cp /var/lib/redis/dump.rdb backup/redis_$(date +%Y%m%d).rdb
   ```

#### 4.2.2 数据恢复

1. **MySQL 恢复**
   ```bash
   mysql -u root -p sutwxapp < backup/sutwxapp_20240101.sql
   ```

2. **Redis 恢复**
   ```bash
   cp backup/redis_20240101.rdb /var/lib/redis/dump.rdb
   redis-cli CONFIG SET appendonly no
   ```

## 5. 监控与告警

### 5.1 监控指标

#### 5.1.1 系统指标

- CPU 使用率
- 内存使用率
- 磁盘使用率
- 网络流量

#### 5.1.2 应用指标

- 请求响应时间
- 错误率
- QPS（每秒请求数）
- 活跃连接数

### 5.2 告警规则

| 指标 | 阈值 | 告警级别 |
|------|------|----------|
| CPU 使用率 | > 80% | 警告 |
| 内存使用率 | > 85% | 警告 |
| 磁盘使用率 | > 90% | 严重 |
| 错误率 | > 1% | 警告 |
| 响应时间 | > 500ms | 警告 |

### 5.3 告警通知

- 邮件通知
- 短信通知
- 钉钉/企业微信通知

## 6. 故障处理

### 6.1 常见故障

#### 6.1.1 服务不可用

**故障现象**：无法访问服务

**排查步骤**：

1. 检查 Pod 状态
   ```bash
   kubectl get pods -n sutwxapp
   ```

2. 检查 Pod 日志
   ```bash
   kubectl logs <pod-name> -n sutwxapp
   ```

3. 检查资源使用
   ```bash
   kubectl describe pod <pod-name> -n sutwxapp
   ```

**解决方案**：

- 如果 Pod 状态异常，尝试重启 Pod
- 如果资源不足，扩容 Pod

#### 6.1.2 数据库连接失败

**故障现象**：无法连接数据库

**排查步骤**：

1. 检查数据库服务状态
2. 检查数据库连接数
3. 检查网络连接

**解决方案**：

- 重启数据库服务
- 优化数据库配置
- 增加连接数限制

#### 6.1.3 性能问题

**故障现象**：响应时间过长

**排查步骤**：

1. 检查慢查询
2. 检查缓存命中率
3. 检查资源使用

**解决方案**：

- 优化 SQL 查询
- 增加缓存
- 扩容服务

### 6.2 故障升级

当遇到无法解决的故障时，需要按照以下流程升级：

1. **一线运维**：尝试基本排查和解决
2. **二线运维**：如果一线无法解决，升级到二线
3. **开发团队**：如果运维无法解决，升级到开发团队
4. **技术负责人**：重大故障升级到技术负责人

## 7. 版本更新

### 7.1 更新流程

1. **备份数据**：执行数据库备份
2. **更新服务**：更新应用到新版本
3. **验证功能**：验证功能正常
4. **监控观察**：观察系统运行状态

### 7.2 回滚流程

如果更新后出现问题，执行回滚：

```bash
kubectl rollout undo deployment/<deployment-name> -n sutwxapp
```

## 8. 安全措施

### 8.1 访问控制

- 使用强密码
- 限制 IP 访问
- 启用防火墙

### 8.2 数据安全

- 定期备份数据
- 加密敏感数据
- 审计数据访问

### 8.3 网络安全

- 使用 HTTPS
- 限制端口访问
- 启用 WAF

## 9. 相关文档

- [系统配置](./02-系统配置.md)
- [权限管理](./03-权限管理.md)
- [架构设计文档](../03-开发者指南/02-架构设计文档.md)
