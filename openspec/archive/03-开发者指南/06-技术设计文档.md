<!--
文件名 06-技术设计文档.md
版本号 1.0.0
更新日期: 2025-11-30
作者 Sut
描述: 技术实现方案和设计细节
-->

## 目录

[TOC]

## 1. 概述

### 1.1 文档目的

本文档旨在介绍SutWxApp项目的技术实现细节和设计方案，帮助开发者理解系统的技术架构和实现原理。
### 1.2 设计原则

- **模块化设计**：系统拆分为多个独立的模块，便于开发和维护
- **高内聚低耦合**：模块内部高内聚，模块之间低耦合
- **可扩展性**：支持横向扩展，满足业务增长需求
- **高性能**：系统具有良好的性能表现
- **高可用性**：确保系统能够持续稳定运行
- **安全性**：确保系统数据和用户信息的安全

## 2. 技术栈选择

### 2.1 前端技术栈

| 技术 | 版本 | 用途 | 选型理由 |
|------|------|------|----------|
| 微信小程序框架 | 最新 | 微信小程序开发 | 微信官方框架，生态成熟，易于开发和部署 |
| Vue.js | 3.x | Web管理后台开发 | 轻量级框架，易于学习和使用，生态成熟 |
| UniApp | 最新 | 跨平台开发 | 支持多平台开发，提高开发效率 |
| Axios | 0.27.x | HTTP请求库 | 功能强大，易于使用，支持拦截器等高级功能 |
| Vuex | 4.x | 状态管理 | 集中式状态管理，便于管理复杂的应用状态 |
| Vue Router | 4.x | 路由管理 | 官方路由管理器，易于使用和配置 |

### 2.2 后端技术栈

| 技术 | 版本 | 用途 | 选型理由 |
|------|------|------|----------|
| Node.js | 16.x | 后端开发语言 | 高性能，支持非阻塞IO，适合高并发场景 |
| Express | 4.x | Web框架 | 轻量级框架，易于学习和使用，生态成熟 |
| MySQL | 8.x | 关系型数据库 | 成熟稳定，适合存储结构化数据 |
| Redis | 6.x | 缓存数据库 | 高性能，适合存储热点数据和会话管理 |
| MongoDB | 5.x | 非关系型数据库 | 灵活，适合存储非结构化数据 |
| Sequelize | 6.x | ORM框架 | 支持多种数据库，易于使用和维护 |
| JWT | 8.x | 认证授权 | 无状态，易于扩展，适合分布式系统 |
| Socket.io | 4.x | 实时通信 | 支持双向通信，适合实时应用场景 |

### 2.3 开发工具

| 工具 | 用途 | 选型理由 |
|------|------|----------|
| VS Code | 代码编辑器 | 轻量级，功能强大，插件丰富 |
| WebStorm | 代码编辑器 | 专业的JavaScript IDE，功能强大 |
| Git | 版本控制 | 分布式版本控制系统，易于使用和协作 |
| GitHub | 代码托管 | 全球最大的代码托管平台，生态成熟 |
| Postman | API测试 | 功能强大，易于使用，支持团队协作 |
| Jest | 测试框架 | 易于使用，功能强大，支持快照测试等高级功能 |
| ESLint | 代码检查 | 确保代码质量和一致性 |
| Prettier | 代码格式化 | 自动格式化代码，确保代码风格一致 |

## 3. 系统架构设计

### 3.1 整体架构

系统采用前后端分离的微服务架构，分为以下几层：
- **客户端层**：包括微信小程序、Web管理后台、移动端App等
- **网络层**：负责请求路由、负载均衡、认证授权等
- **API层**：提供对外的API接口
- **服务层**：处理业务逻辑，协调多个数据层操作
- **数据层**：负责数据存储和管理

### 3.2 模块划分

系统划分为以下模块：

- **用户模块**：处理用户登录、注册、消息管理等
- **产品模块**：处理产品分类、信息管理、搜索等
- **订单模块**：处理订单创建、支付、查询等
- **支付模块**：处理支付请求、回调处理等
- **物流模块**：处理物流信息查询、跟踪等
- **营销模块**：处理优惠券、活动管理等
- **数据分析模块**：处理数据统计、报表生成等
- **社交模块**：处理分享、评论、点赞等社交功能
- **通知模块**：处理消息推送、订阅消息等通知功能
- **积分模块**：处理积分获取、兑换等积分功能
- **搜索模块**：处理产品搜索、文章搜索等搜索功能

### 3.3 核心流程设计

#### 3.3.1 用户登录流程

1. 用户在微信小程序中点击登录按钮
2. 微信小程序调用微信登录API，获取code
3. 微信小程序将code发送到后端API
4. 后端API调用微信服务器，获取openid和session_key
5. 后端API生成JWT token，返回给微信小程序
6. 微信小程序存储token，用于后续请求

#### 3.3.2 产品浏览流程

1. 用户在微信小程序中浏览产品
2. 微信小程序调用产品服务API，获取产品列表
3. 产品服务API调用产品服务，获取产品数据
4. 产品服务从Redis缓存中获取产品数据，如果缓存不存在，则从MySQL数据库中获取
5. 产品服务将产品数据返回给产品服务API
6. 产品服务API将产品数据返回给微信小程序
7. 微信小程序显示产品列表

#### 3.3.3 订单创建流程

1. 用户在微信小程序中选择产品，点击下单按钮
2. 微信小程序调用订单服务API，创建订单
3. 订单服务API调用订单服务，创建订单
4. 订单服务检查产品库存，扣减库存
5. 订单服务创建订单记录，保存到MySQL数据库
6. 订单服务返回订单信息给订单服务API
7. 微信小程序调用支付服务API，发起支付
8. 支付服务API调用支付服务，处理支付请求
9. 支付服务调用微信支付API，发起支付
10. 微信支付返回支付链接给支付服务
11. 支付服务返回支付链接给支付服务API
12. 支付服务API返回支付链接给微信小程序
13. 微信小程序调用微信支付，完成支付
14. 微信支付回调支付服务，通知支付结果
15. 支付服务更新支付状态，通知订单服务
16. 订单服务更新订单状态，保存到MySQL数据库

## 4. 数据库设计

### 4.1 数据库架构

系统使用以下数据库：

- **MySQL**：存储结构化数据，如用户信息、产品信息、订单信息等
- **Redis**：存储热点数据、会话信息、计数器等
- **MongoDB**：存储非结构化数据，如日志、评论等

### 4.2 核心数据表设计

#### 4.2.1 用户表（users）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|----------|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | 用户ID |
| username | VARCHAR(50) | NOT NULL, UNIQUE | 用户名 |
| password | VARCHAR(255) | NOT NULL | 密码（加密存储） |
| email | VARCHAR(100) | NOT NULL, UNIQUE | 邮箱 |
| phone | VARCHAR(20) | UNIQUE | 手机号 |
| avatar | VARCHAR(255) | | 头像URL |
| nickname | VARCHAR(50) | | 昵称 |
| gender | TINYINT | DEFAULT 0 | 性别：0:未知, 1:男, 2:女 |
| birthday | DATE | | 生日 |
| status | TINYINT | DEFAULT 1 | 状态：0:禁用, 1:启用 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

#### 4.2.2 产品表（products）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|----------|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | 产品ID |
| name | VARCHAR(255) | NOT NULL | 产品名称 |
| description | TEXT | | 产品描述 |
| price | DECIMAL(10,2) | NOT NULL | 产品价格 |
| original_price | DECIMAL(10,2) | NOT NULL | 产品原价 |
| stock | INT | NOT NULL DEFAULT 0 | 产品库存 |
| category_id | INT | NOT NULL | 分类ID |
| brand_id | INT | | 品牌ID |
| status | TINYINT | DEFAULT 1 | 状态：0:下架, 1:上架 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

#### 4.2.3 订单表（orders）

| 字段名 | 数据类型 | 约束 | 描述 |
|-------|----------|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | 订单ID |
| order_no | VARCHAR(20) | NOT NULL, UNIQUE | 订单号 |
| user_id | INT | NOT NULL | 用户ID |
| total_amount | DECIMAL(10,2) | NOT NULL | 订单总金额 |
| actual_amount | DECIMAL(10,2) | NOT NULL | 实际支付金额 |
| status | VARCHAR(20) | NOT NULL | 订单状态 |
| payment_method | VARCHAR(20) | NOT NULL | 支付方式 |
| payment_status | VARCHAR(20) | NOT NULL | 支付状态 |
| shipping_address_id | INT | NOT NULL | 配送地址ID |
| shipping_method | VARCHAR(20) | NOT NULL | 配送方式 |
| shipping_status | VARCHAR(20) | NOT NULL | 配送状态 |
| tracking_number | VARCHAR(50) | | 物流单号 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

## 5. 核心功能实现

### 5.1 用户认证

用户认证使用JWT（JSON Web Token）实现，流程如下：
1. 用户登录成功后，服务器生成JWT token
2. 服务器将JWT token返回给客户端
3. 客户端在后续请求中携带JWT token
4. 服务器验证JWT token的有效性
5. 如果JWT token有效，服务器处理请求；否则，返回未授权错误

JWT token包含以下信息：
- **header**：包含token类型和算法
- **payload**：包含用户ID、用户名、过期时间等
- **signature**：使用密钥签名，确保token的完整性和真实性

### 5.2 缓存策略

系统使用Redis作为缓存数据库，缓存以下数据：
- **热点数据**：如产品信息、用户信息等
- **会话信息**：如用户登录状态等
- **计数器**：如访问次数、点赞数等
- **排行榜**：如热门产品、热门文章等

缓存策略：
- **缓存过期时间**：根据数据的更新频率设置合理的过期时间
- **缓存更新策略**：数据更新时，同时更新缓存
- **缓存穿透处理**：使用布隆过滤器等方式防止缓存穿透
- **缓存雪崩处理**：设置不同的过期时间，避免缓存同时失效

### 5.3 支付集成

系统集成了微信支付和支付宝支付，流程如下：
1. 用户选择产品，创建订单
2. 用户选择支付方式，发起支付
3. 服务器生成支付链接或参数
4. 客户端调用支付SDK，完成支付
5. 支付平台回调服务器，通知支付结果
6. 服务器更新订单状态，处理后续业务逻辑

## 6. 性能优化

### 6.1 前端性能优化

- **代码分割**：将代码分割为多个小块，按需加载
- **懒加载**：图片和组件懒加载，减少初始加载时间
- **缓存**：合理使用浏览器缓存，减少网络请求
- **压缩**：压缩CSS、JavaScript和图片等资源
- **CDN**：使用CDN加速静态资源访问

### 6.2 后端性能优化

- **数据库优化**：合理设计数据库表结构，添加索引，优化查询语句
- **缓存优化**：合理使用缓存，减少数据库查询
- **异步处理**：使用异步非阻塞IO，提高系统并发处理能力
- **负载均衡**：使用负载均衡，分散系统压力
- **横向扩展**：支持横向扩展，满足业务增长需求

### 6.3 数据库性能优化

- **索引优化**：合理添加索引，提高查询效率
- **查询优化**：优化SQL语句，减少查询时间
- **分库分表**：当数据量较大时，进行分库分表
- **读写分离**：将读操作和写操作分离，提高系统性能

## 7. 安全性设计

### 7.1 认证授权

- **JWT认证**：使用JWT进行认证，确保API接口的安全性
- **基于角色的权限控制**：根据用户角色分配不同的权限
- **细粒度的权限管理**：支持细粒度的权限控制，如按按钮级的权限控制

### 7.2 数据安全

- **数据加密**：敏感数据加密存储，如密码使用bcrypt加密
- **数据备份**：定期备份数据，确保数据的安全性和可恢复性
- **数据恢复**：支持数据恢复，防止数据丢失

### 7.3 网络安全

- **HTTPS**：所有请求使用HTTPS，确保数据传输的安全性
- **防火墙**：配置防火墙，防止恶意攻击
- **入侵检测**：使用入侵检测系统，实时检测入侵行为
- **DDoS防护**：配置DDoS防护，防止DDoS攻击

### 7.4 代码安全

- **代码审查**：所有代码提交前进行代码审查，确保代码的安全性
- **漏洞扫描**：定期进行漏洞扫描，发现和修复安全漏洞
- **安全测试**：进行安全测试，确保系统的安全性

## 8. 部署架构

### 8.1 开发环境

- 本地开发环境：开发者本地机器
- 开发服务器：用于集成测试和调试

### 8.2 测试环境

- 测试服务器：用于功能测试和性能测试
- 测试数据库：独立的测试数据库
- 测试缓存：独立的测试缓存

### 8.3 生产环境

- **多台应用服务器**：使用负载均衡，分散系统压力
- **主从数据库**：确保数据安全和高可用性
- **分布式缓存**：提高系统性能
- **CDN**：加速静态资源访问
- **监控系统**：实时监控系统运行状态
- **日志系统**：集中式日志管理，便于后续查询和分析

## 9. 监控和日志

### 9.1 监控系统

- **系统监控**：监控CPU、内存、磁盘等系统资源的使用情况
- **应用监控**：监控应用的运行状态，如请求量、响应时间等
- **数据库监控**：监控数据库的运行状态，如查询时间、连接数等
- **缓存监控**：监控缓存的使用情况，如命中率、内存使用等

### 9.2 日志系统

- **应用日志**：记录应用的运行日志，如请求日志、错误日志等
- **数据库日志**：记录数据库的运行日志，如查询日志、错误日志等
- **系统日志**：记录系统的运行日志，如启动时间、关闭时间等
- **访问日志**：记录用户的访问日志，如IP地址、访问时间等

日志管理：
- **集中式日志管理**：使用ELK等工具进行集中式日志管理
- **日志分析**：对日志进行分析，发现系统问题和优化点
- **日志归档**：定期归档日志，便于后续查询和分析

## 10. 相关链接

- [架构设计文档.md](./02-架构设计文档.md)
- [API接口文档.md](./03-API接口文档.md)
- [服务层API文档.md](./05-服务层API文档.md)
