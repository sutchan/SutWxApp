<!--
文件名: 01-运维手册.md
版本号: 1.0.0
更新日期: 2025-11-30
作者: Sut
描述: 详细的运维指南，包括部署架构、运维流程和故障处理
-->

# 运维手册

## 目录

[TOC]

## 1. 概述

### 1.1 文档目的

本文档旨在为SutWxApp微信小程序项目的运维人员提供详细的运维指南，包括系统架构、部署步骤、日常运维流程、监控方法和故障处理等内容，确保系统的稳定运行。

### 1.2 适用范围

- 运维人员
- 系统管理员
- 开发人员

## 2. 系统架构

### 2.1 整体架构

SutWxApp项目采用前后端分离架构，主要包括以下组件：

1. **前端**：微信小程序
2. **后端**：Node.js + Express API服务
3. **数据库**：
   - MySQL：存储用户数据、商品数据、订单数据等
   - Redis：缓存热点数据、会话管理
   - MongoDB：存储日志数据、用户行为数据
4. **中间件**：
   - Nginx：反向代理、负载均衡
   - Redis：缓存服务
5. **第三方服务**：
   - 微信支付
   - 物流查询API

### 2.2 系统拓扑图

```
+----------------+    +----------------+    +----------------+    +----------------+
|  微信小程序客户端  |    |      Nginx      |    |   Node.js API   |    |    MySQL       |
|                |    |  反向代理/负载均衡 |    |    服务集群     |    |                |
+----------------+    +----------------+    +----------------+    +----------------+
         |                     |                        |                     |
         |                     |                        |                     |
         |                     |                        |                     |
         |                     |                        |                     |
+----------------+    +----------------+    +----------------+    +----------------+
|  CDN静态资源    |    |      Redis      |    |    MongoDB      |    |   第三方服务    |
|                |    |   缓存/会话管理   |    |   日志/行为数据   |    |  (微信支付等)   |
+----------------+    +----------------+    +----------------+    +----------------+
```

### 2.3 部署环境

| 环境类型 | 服务器配置 | 操作系统 | 部署方式 |
|---------|-----------|---------|---------|
| 开发环境 | 4核8G | Ubuntu 22.04 | Docker Compose |
| 测试环境 | 8核16G | Ubuntu 22.04 | Docker Compose |
| 生产环境 | 16核32G | Ubuntu 22.04 | Kubernetes |

## 3. 部署步骤

### 3.1 开发环境部署

#### 3.1.1 环境准备

1. **安装Docker和Docker Compose**
   ```bash
   # 安装Docker
   curl -fsSL https://get.docker.com -o get-docker.sh
   sh get-docker.sh
   
   # 安装Docker Compose
   curl -L "https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
   chmod +x /usr/local/bin/docker-compose
   ```

2. **克隆代码仓库**
   ```bash
   git clone https://github.com/sutchan/SutWxApp.git
   cd SutWxApp
   ```

#### 3.1.2 配置文件修改

1. **修改环境变量配置**
   ```bash
   cp .env.example .env
   # 编辑.env文件，配置数据库连接、Redis连接等信息
   vi .env
   ```

2. **修改Docker Compose配置**
   ```bash
   # 根据需要修改docker-compose.yml文件
   vi docker-compose.yml
   ```

#### 3.1.3 启动服务

```bash
docker-compose up -d
```

#### 3.1.4 验证部署

1. **检查服务状态**
   ```bash
docker-compose ps
   ```

2. **访问API服务**
   ```bash
   curl http://localhost:3000/api/v1/health
   ```

3. **查看日志**
   ```bash
docker-compose logs -f
   ```

### 3.2 生产环境部署

#### 3.2.1 环境准备

1. **安装Kubernetes集群**
   - 使用kubeadm安装Kubernetes集群
   - 配置网络插件（如Calico）
   - 配置存储类（如NFS、Ceph）

2. **安装Helm**
   ```bash
   curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
   ```

3. **配置CI/CD流水线**
   - 使用Jenkins或GitLab CI配置自动化部署流水线
   - 配置Docker镜像仓库（如Harbor、Docker Hub）

#### 3.2.2 部署应用

1. **创建命名空间**
   ```bash
   kubectl create namespace sutwxapp
   ```

2. **部署MySQL**
   ```bash
   helm repo add bitnami https://charts.bitnami.com/bitnami
   helm install mysql bitnami/mysql -n sutwxapp -f mysql-values.yaml
   ```

3. **部署Redis**
   ```bash
   helm install redis bitnami/redis -n sutwxapp -f redis-values.yaml
   ```

4. **部署MongoDB**
   ```bash
   helm install mongodb bitnami/mongodb -n sutwxapp -f mongodb-values.yaml
   ```

5. **部署API服务**
   ```bash
   # 构建Docker镜像
   docker build -t sutwxapp-api:v1.0.0 .
   docker push sutwxapp-api:v1.0.0
   
   # 部署到Kubernetes
   kubectl apply -f k8s/api-deployment.yaml -n sutwxapp
   kubectl apply -f k8s/api-service.yaml -n sutwxapp
   ```

6. **部署Nginx Ingress**
   ```bash
   kubectl apply -f k8s/nginx-ingress.yaml -n sutwxapp
   ```

#### 3.2.3 验证部署

1. **检查Pod状态**
   ```bash
   kubectl get pods -n sutwxapp
   ```

2. **检查服务状态**
   ```bash
   kubectl get services -n sutwxapp
   ```

3. **访问API服务**
   ```bash
   curl https://api.sutwxapp.com/api/v1/health
   ```

## 4. 日常运维

### 4.1 系统监控

#### 4.1.1 监控指标

1. **服务器指标**：
   - CPU使用率
   - 内存使用率
   - 磁盘使用率
   - 网络流量

2. **应用指标**：
   - API响应时间
   - 请求成功率
   - 并发连接数
   - 错误率

3. **数据库指标**：
   - 查询响应时间
   - 连接数
   - 缓存命中率
   - 慢查询数量

#### 4.1.2 监控工具

- **Prometheus**：收集监控指标
- **Grafana**：可视化监控数据
- **Alertmanager**：处理告警

#### 4.1.3 告警规则

| 告警类型 | 阈值 | 告警级别 | 通知方式 |
|---------|------|---------|---------|
| CPU使用率 | >80% | 警告 | 邮件、Slack |
| 内存使用率 | >85% | 警告 | 邮件、Slack |
| 磁盘使用率 | >90% | 严重 | 邮件、Slack、电话 |
| API响应时间 | >2s | 警告 | 邮件、Slack |
| 请求错误率 | >5% | 严重 | 邮件、Slack、电话 |

### 4.2 日志管理

#### 4.2.1 日志类型

1. **应用日志**：Node.js API服务日志
2. **数据库日志**：MySQL、Redis、MongoDB日志
3. **Nginx日志**：访问日志、错误日志
4. **系统日志**：服务器系统日志

#### 4.2.2 日志收集

使用ELK Stack收集和管理日志：

1. **Logstash**：收集日志数据
2. **Elasticsearch**：存储日志数据
3. **Kibana**：查询和可视化日志数据

#### 4.2.3 日志查询

- 使用Kibana查询日志
- 设置日志保留策略（如30天）
- 定期清理过期日志

### 4.3 数据备份

#### 4.3.1 备份策略

| 数据类型 | 备份频率 | 备份方式 | 保留时间 |
|---------|---------|---------|---------|
| MySQL数据 | 每日 | 全量备份 | 30天 |
| Redis数据 | 每小时 | 快照备份 | 7天 |
| MongoDB数据 | 每日 | 全量备份 | 30天 |
| 配置文件 | 每次变更 | 版本控制 | 永久 |

#### 4.3.2 备份命令

1. **MySQL备份**
   ```bash
   mysqldump -u root -p --all-databases > mysql_backup_$(date +%Y%m%d).sql
   ```

2. **Redis备份**
   ```bash
   redis-cli BGSAVE
   ```

3. **MongoDB备份**
   ```bash
   mongodump --out mongodb_backup_$(date +%Y%m%d)
   ```

#### 4.3.3 恢复命令

1. **MySQL恢复**
   ```bash
   mysql -u root -p < mysql_backup_20251130.sql
   ```

2. **Redis恢复**
   ```bash
   cp dump.rdb /var/lib/redis/
   systemctl restart redis
   ```

3. **MongoDB恢复**
   ```bash
   mongorestore --dir mongodb_backup_20251130
   ```

### 4.4 安全管理

#### 4.4.1 安全策略

1. **定期更新系统和软件**
   ```bash
   apt update && apt upgrade -y
   ```

2. **配置防火墙**
   ```bash
   ufw allow 22/tcp
   ufw allow 80/tcp
   ufw allow 443/tcp
   ufw enable
   ```

3. **使用HTTPS**
   - 配置SSL证书
   - 强制HTTPS访问

4. **定期进行安全扫描**
   ```bash
   # 使用nmap进行端口扫描
   nmap -sV -p- 192.168.1.100
   
   # 使用OpenVAS进行漏洞扫描
   openvas-start
   ```

## 5. 故障处理

### 5.1 常见故障

#### 5.1.1 API服务不可用

**症状**：
- API请求返回500错误
- 监控告警显示API服务不可用

**处理步骤**：
1. 检查API服务日志
   ```bash
   docker-compose logs api
   # 或
   kubectl logs -f deployment/api -n sutwxapp
   ```

2. 检查数据库连接
   ```bash
   mysql -u root -p -h localhost
   redis-cli ping
   mongo
   ```

3. 检查服务器资源
   ```bash
   top
   df -h
   ```

4. 重启API服务
   ```bash
   docker-compose restart api
   # 或
   kubectl rollout restart deployment/api -n sutwxapp
   ```

#### 5.1.2 数据库连接失败

**症状**：
- API服务日志显示数据库连接失败
- 应用无法访问数据库

**处理步骤**：
1. 检查数据库服务状态
   ```bash
   systemctl status mysql
   systemctl status redis
   systemctl status mongod
   ```

2. 检查数据库连接配置
   ```bash
   # 检查.env文件中的数据库连接配置
   cat .env
   ```

3. 检查数据库权限
   ```bash
   mysql -u root -p -e "SHOW GRANTS FOR 'sutwxapp'@'%';"
   ```

4. 重启数据库服务
   ```bash
   systemctl restart mysql
   ```

#### 5.1.3 高CPU使用率

**症状**：
- 监控告警显示CPU使用率过高
- 系统响应缓慢

**处理步骤**：
1. 查看CPU使用率最高的进程
   ```bash
   top
   ```

2. 分析进程占用CPU的原因
   ```bash
   # 使用strace分析进程
   strace -p <pid>
   
   # 使用perf分析性能
   perf top -p <pid>
   ```

3. 优化应用代码或增加服务器资源

### 5.2 故障记录

每次故障处理后，应记录故障信息：

| 字段 | 描述 |
|------|------|
| 故障时间 | 故障发生的时间 |
| 故障类型 | 故障的类型 |
| 故障描述 | 故障的详细描述 |
| 影响范围 | 故障影响的范围 |
| 处理步骤 | 故障处理的详细步骤 |
| 根本原因 | 故障的根本原因 |
| 预防措施 | 防止类似故障发生的措施 |
| 处理人员 | 处理故障的人员 |

## 6. 系统升级

### 6.1 升级流程

1. **准备工作**：
   - 备份数据
   - 测试升级脚本
   - 制定回滚计划

2. **升级步骤**：
   - 停止旧版本服务
   - 部署新版本服务
   - 执行数据库迁移
   - 启动新版本服务
   - 验证升级结果

3. **回滚计划**：
   - 如果升级失败，停止新版本服务
   - 恢复旧版本服务
   - 恢复数据备份

### 6.2 版本发布

1. **版本号规范**：使用语义化版本规范（MAJOR.MINOR.PATCH）
2. **发布说明**：编写详细的发布说明，包括新功能、bug修复、升级注意事项
3. **发布流程**：
   - 代码审查
   - 自动化测试
   - 构建镜像
   - 部署到测试环境
   - 测试验证
   - 部署到生产环境

## 7. 灾难恢复

### 7.1 灾难恢复计划

1. **灾难类型**：
   - 服务器故障
   - 数据库故障
   - 网络故障
   - 自然灾害

2. **恢复目标**：
   - RTO（恢复时间目标）：4小时
   - RPO（恢复点目标）：1小时

3. **恢复流程**：
   - 评估灾难影响
   - 启动灾难恢复计划
   - 恢复基础设施
   - 恢复数据
   - 验证系统功能
   - 恢复服务

### 7.2 容灾方案

1. **数据容灾**：
   - 异地备份
   - 数据库主从复制
   - 数据同步

2. **服务容灾**：
   - 多可用区部署
   - 负载均衡
   - 自动故障转移

## 8. 附录

### 8.1 常用命令

1. **Docker命令**：
   ```bash
   # 查看容器状态
   docker ps
   
   # 查看容器日志
   docker logs -f <container_id>
   
   # 进入容器
   docker exec -it <container_id> bash
   ```

2. **Kubernetes命令**：
   ```bash
   # 查看Pod状态
   kubectl get pods
   
   # 查看服务状态
   kubectl get services
   
   # 查看日志
   kubectl logs -f <pod_name>
   ```

3. **数据库命令**：
   ```bash
   # 查看MySQL进程
   mysqladmin -u root -p processlist
   
   # 查看Redis信息
   redis-cli info
   
   # 查看MongoDB状态
   mongo --eval "db.stats()"
   ```

### 8.2 配置文件

- **.env**：环境变量配置
- **docker-compose.yml**：Docker Compose配置
- **k8s/**：Kubernetes配置文件

### 8.3 联系方式

| 角色 | 姓名 | 邮箱 | 电话 |
|------|------|------|------|
| 运维负责人 | Sut | sut@example.com | 13800138000 |
| 开发负责人 | Dev | dev@example.com | 13800138001 |
| 系统管理员 | Admin | admin@example.com | 13800138002 |

## 9. 版本历史

| 版本号 | 更新日期 | 更新内容 | 作者 |
|--------|----------|----------|------|
| 1.0.0  | 2025-11-30 | 初始版本 | Sut |