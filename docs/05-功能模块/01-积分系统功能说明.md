# 积分系统功能说明

## 1. 概述
积分系统用于提升用户活跃度与留存，为电商、会员、活动等业务提供统一的激励与兑换机制。本文档介绍积分的获取、消耗、规则、接口约定及前端交互。

## 2. 业务术语
- 积分余额：当前可用积分，支持正整数。
- 冻结积分：待结算或风控冻结中的积分，不可用。
- 积分流水：积分变动的记录，包含获取、消耗、过期、调整等类型。
- 获取来源：签到、购物、评价、任务、活动、运营手动发放等。

## 3. 积分获取
- 每日签到：固定或阶梯奖励，可配置上限与补签规则。
- 购物行为：按订单实付金额或商品策略给予积分，支持分类/品牌/单品倍率。
- 内容互动：评价、点赞、分享、关注等行为奖励，需限频与反作弊。
- 任务中心：完成任务发放积分，支持一次性、每日、每周、每月任务。
- 活动奖励：运营活动发放，如节日、会员日、拉新等。

## 4. 积分消耗
- 积分商城：兑换商品/券码/会员权益。
- 订单抵扣：按比例抵扣订单金额，支持上限与黑白名单商品策略。
- 抵扣服务费：用于邮费、包装费等配置项（如启用）。

## 5. 规则说明
- 有效期：支持固定有效期（发放后N天过期）或按自然月/年过期。
- 上限与下限：用户积分余额与单次获取/消耗可设置阈值与上限。
- 过期处理：到期自动生成过期流水并扣减余额；可配置提醒与预警。
- 冻结/解冻：购物积分在订单完成后解冻；退款退货触发积分回退与冻结。
- 手动调整：管理员可增减积分并填写原因，写入流水并触发通知。
- 反作弊：限频、设备指纹、黑名单、异常行为告警。

## 6. 数据模型（建议）
- 用户积分账户：
  - userId：用户唯一ID
  - pointsBalance：当前可用积分
  - pointsFrozen：冻结积分
  - totalEarned：累计获取积分
  - totalSpent：累计消耗积分
  - updatedAt：最近更新时间
- 积分流水：
  - logId：流水ID
  - userId：用户ID
  - type：earn/spend/expire/adjust/freeze/unfreeze
  - amount：积分变动值（正负）
  - source：order/sign/task/activity/manual
  - orderId：关联订单（可选）
  - memo：备注或原因
  - createdAt：创建时间
  - status：pending/success/failed

## 7. 事件与流程
- 购物发放：下单→支付→订单完成→按规则发放积分（可冻结后解冻）。
- 退款处理：售后完成→按比例回收积分或再次冻结→更新流水与余额。
- 签到任务：每日校验与限频→发放积分→写入流水。
- 兑换抵扣：下单使用积分→预冻结/扣减→订单取消/失败时回退。

## 8. 接口约定（参考）
详见 `docs/03-开发者指南/03-API接口文档.md`，建议接口：
- GET `/points/balance`：查询用户积分余额与冻结情况。
- GET `/points/logs`：分页查询积分流水，支持类型/时间过滤。
- POST `/points/earn`：增加积分（任务/活动/人工）。
- POST `/points/spend`：消耗积分（兑换/抵扣）。
- POST `/points/adjust`：管理员调整积分。

请求示例（spend）：
```json
{
  "userId": "u123",
  "amount": 200,
  "source": "order",
  "orderId": "o20251122001"
}
```
响应示例：
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "balance": 800,
    "logId": "pl_778899"
  }
}
```

## 9. 前端页面与交互
- 我的积分：展示余额、冻结、到期提醒与获取途径。
- 积分明细：按类型筛选、分页加载、支持跳转关联订单。
- 兑换中心：兑换商品/券，展示规则、库存与可用性。
- 下单抵扣：实时计算抵扣上限、校验规则与失败回退提示。

## 10. 权限与风控
- 管理端操作需管理员角色与审计记录。
- 用户侧限频与风控策略统一接入（灰度/黑名单/设备指纹）。

## 11. 异常与容错
- 接口失败回退：写失败流水并保持账户一致性；提供重试机制。
- 并发扣减：使用事务或分布式锁，保证幂等与一致性。
- 时间边界：过期批处理需幂等、可重入，记录处理进度。

## 12. 测试要点
- 购物积分结算与退款回收的边界用例。
- 大额抵扣与上限校验、并发下单扣减一致性。
- 过期批处理与提醒通知正确性。
- 任务/活动限频与反作弊规则验证。

## 13. 版本计划
- v1：基础获取/消耗/流水查询与订单抵扣。
- v2：积分商城与会员权益联动、任务中心完善。
- v3：风控强化与设备指纹、跨端积分一致性治理。
