<!--
文件名: 01-积分系统功能说明.md
版本号: 1.0.1
更新日期: 2025-11-24
描述: 01-积分系统功能说明 文档文件
-->
# 积分系统功能说明

## 1. 概述
积分系统用于提高用户活跃度与留存，为电商、会员、活动等业务提供统一的激励与兑换机制。本文档介绍积分的获取、消耗、规则、接口定义及前端交互。
## 2. 业务术语
- 积分余额：当前可用积分，支持正整数。
- 冻结积分：待结算或风险管控中的积分，不可用。
- 积分流水：积分变动的记录，包括获取、消耗、过期、调整等类型。
- 获取来源：签到、购物、评价、任务、活动、运营手动发放等。
## 3. 积分获取
- 每日签到：固定或随机奖励，可配置上限与叠加规则。
- 购物行为：按订单实际支付额或商品阶梯给予积分，支持分类/品牌/单品倍率。
- 内容互动：评价、点赞、分享、关注等行为奖励，限频与反作弊。
- 任务中心：完成任务发放积分，支持一次/每日/每周/每月任务。
- 活动奖励：运营活动发放，如节日、会员日、拉新等。
## 4. 积分消耗
- 积分商城：兑换商品、券码/会员福利。
- 订单抵扣：按比例抵扣订单金额，支持上限与黑名单商品排除。
- 抵扣服务费：用于付费、包装费等附加项（如需）。
## 5. 规则说明
- 有效期：支持指定有效期（发放日+N天过期）或自然年+1年过期。
- 上限与下限：用户积分余额与单次获取/消耗可设置阈值与上限。
- 过期处理：到期自动生成过期流水并扣减余额；可配置提醒与预警。
- 结算/解冻：购物积分在订单完成后释放；退款积分退还与扣减。
- 手动调整：管理员可增减积分并填写原因，写入流水并触发通知。
- 反作弊：限频、设备指纹、黑名单、异常行为预警。
## 6. 数据模型（建议）
- 用户积分账户：
  - userId：用户唯一ID
  - pointsBalance：当前可用积分
  - pointsFrozen：冻结积分
  - totalEarned：累计获取积分
  - totalSpent：累计消耗积分
  - updatedAt：最近更新时间
- 积分流水：
  - logId：流水ID
  - userId：用户ID
  - type：earn/spend/expire/adjust/freeze/unfreeze
  - amount：积分变动金额（正负）
  - source：order/sign/task/activity/manual
  - orderId：关联订单（可选）
  - memo：备注或原因
  - createdAt：创建时间
  - status：pending/success/failed

## 7. 事件与流程
- 购物发放：下单→支付→订单完成→按规则发放积分（可冻结后释放）。
- 退款处理：退款完成→按比例回收积分或再次冻结→更新流水与余额。
- 签到任务：每日校验与限频→发放积分→写入流水。
- 兑换抵扣：下单使用积分→预冻结→扣减→订单取消时返回。
## 8. 接口定义（参考）

积分系统的完整API接口请参考 `docs/03-开发者指南/03-API接口文档.md` 中的"4.6 积分模块"部分，该文档提供了完整的接口说明，包括：

- 获取用户积分：`GET /points/balance`
- 获取积分任务列表：`GET /points/tasks`
- 完成积分任务：`POST /points/task/complete`
- 获取积分明细：`GET /points/history`
- 积分兑换商品：`POST /points/exchange`
- 获取积分商城商品列表：`GET /points/goods`
- 签到获取积分：`POST /points/signin`
- 获取签到状态：`GET /points/signin/status`

前端服务层的接口调用请参考 `docs/03-开发者指南/05-服务层API文档.md` 中的"3. 积分服务 (PointsService)"部分。
## 9. 前端页面与交互
- 我的积分：显示余额、冻结、到期提醒与获取方式。
- 积分明细：按类型筛选、分页加载、支持跳转关联订单。
- 兑换中心：兑换商品/券，展示规则、库存与可用性。
- 下单抵扣：实时计算抵扣上限、校验规则与错误提示。
## 10. 权限与风险
- 管理端操作需管理员角色与操作记录。
- 用户限额与风控规则统一接入（黑名单、设备指纹等）。
## 11. 异常与容错
- 接口错误处理：写错误流水并保持数据一致性；提供重试机制。
- 并发扣减：使用事务或分布式锁，保证幂等与一致性。
- 时间边界：过期处理需幂等、可重入，确保处理进度。
## 12. 测试要点
- 购物积分计算与退款返回的边界用例。
- 大额抵扣与上限校验、并发下单扣减一致性。
- 过期自动处理与提醒通知正确性。
- 任务/活动限频与反作弊规则验证。
## 13. 版本规划
- v1：基础积分获取/消耗、规则/接口与交互。
- v2：积分商城、会员等级关联、活动联动。
- v3：积分过期提醒、风控体系完善。
