<!--
文件名: 03-权限管理.md
版本号: 1.0.0
更新日期: 2025-11-24
作者: Sut
描述: 权限管理指南，说明系统的用户角色定义、权限分配和访问控制机制
-->
# 权限管理指南

**版本号：1.0.0**
*最后更新时间：2025-11-24*

## 1. 概述

本文档详细说明SutWxApp微信小程序项目的权限管理体系，包括权限模型设计、角色定义、权限配置、权限验证机制以及安全最佳实践，为系统管理员提供完整的权限管理参考。

### 1.1 权限管理目标

- 保护系统和用户数据的安全性
- 确保用户只能访问其被授权的功能和数据
- 实现权限的精细化管理和控制
- 提供灵活的权限配置和管理机制
- 记录和审计权限相关的操作

### 1.2 适用范围

本文档适用于SutWxApp微信小程序项目的用户权限管理、后台管理系统权限控制以及API访问权限管理。

## 2. 权限体系设计

### 2.1 权限模型

SutWxApp采用RBAC（Role-Based Access Control，基于角色的访问控制）模型进行权限管理，同时结合ACL（Access Control List，访问控制列表）实现更细粒度的权限控制。

#### 2.1.1 RBAC模型核心概念

- **用户（User）**：系统中的实际用户，可以是小程序用户或管理员
- **角色（Role）**：权限的集合，代表用户在系统中的职责或身份
- **权限（Permission）**：对系统资源的操作许可
- **资源（Resource）**：系统中可被访问和操作的对象
- **操作（Operation）**：对资源的具体动作，如查看、创建、编辑、删除等

#### 2.1.2 权限模型示意图

```
用户 --- 分配 --> 角色 --- 包含 --> 权限 --- 控制 --> 资源
                          |
                          v
                        操作
```

### 2.2 权限分类

#### 2.2.1 功能权限

控制用户对系统功能模块的访问权限，如用户管理、商品管理、订单管理等。

#### 2.2.2 数据权限

控制用户对特定数据资源的访问范围，如只能查看自己创建的订单，或只能管理特定分类的商品等。

#### 2.2.3 操作权限

控制用户对资源的具体操作权限，如查询、创建、修改、删除等。

## 3. 用户角色设计

### 3.1 小程序用户角色

#### 3.1.1 普通用户（User）

- **描述**：注册并登录小程序的普通用户
- **权限范围**：
  - 浏览商品和分类
  - 添加商品到购物车
  - 创建和管理自己的订单
  - 管理个人信息和收货地址
  - 查看个人消费记录

#### 3.1.2 会员用户（Member）

- **描述**：具有会员资格的用户
- **权限范围**：
  - 包含普通用户的所有权限
  - 享受会员折扣
  - 参与会员专享活动
  - 积累和使用积分

#### 3.1.3 VIP用户（VIP）

- **描述**：高级会员用户
- **权限范围**：
  - 包含会员用户的所有权限
  - 享受VIP专属折扣和服务
  - 优先购买限量商品
  - 专属客服支持

### 3.2 后台管理角色

#### 3.2.1 系统管理员（Admin）

- **描述**：系统最高权限管理者
- **权限范围**：
  - 管理所有系统功能和数据
  - 创建和管理其他管理员账号
  - 设置系统参数和配置
  - 查看系统日志和审计记录
  - 管理所有用户和角色权限

#### 3.2.2 运营管理员（OperationAdmin）

- **描述**：负责系统运营的管理员
- **权限范围**：
  - 管理商品信息和分类
  - 管理订单和退款
  - 发布活动和促销信息
  - 查看运营数据报表
  - 管理营销工具

#### 3.2.3 内容管理员（ContentAdmin）

- **描述**：负责内容管理的管理员
- **权限范围**：
  - 管理文章和资讯
  - 管理广告和Banner
  - 审核用户生成内容
  - 管理帮助中心和FAQ

#### 3.2.4 客服管理员（ServiceAdmin）

- **描述**：负责客户服务的管理员
- **权限范围**：
  - 处理用户咨询和投诉
  - 查看和处理订单问题
  - 管理售后退换货
  - 维护常见问题解答

#### 3.2.5 数据分析师（DataAnalyst）

- **描述**：负责数据统计和分析的角色
- **权限范围**：
  - 查看系统各项数据报表
  - 导出分析数据
  - 设置自定义报表
  - 查看用户行为数据
  - 无数据修改权限

## 4. 权限配置管理

### 4.1 权限配置结构

权限配置采用层级结构，使用冒号分隔权限的不同维度：

```
[模块]:[资源]:[操作]
```

#### 4.1.1 权限编码示例

- `user:profile:view` - 查看用户个人资料
- `product:category:create` - 创建商品分类
- `order:list:export` - 导出订单列表
- `system:setting:edit` - 编辑系统设置

### 4.2 后台管理系统权限配置

#### 4.2.1 管理员权限管理界面

1. **角色管理**
   - 创建新角色
   - 编辑角色信息
   - 分配权限给角色
   - 删除角色（非系统预设角色）

2. **用户管理**
   - 创建管理员用户
   - 编辑用户信息
   - 分配角色给用户
   - 重置用户密码
   - 启用/禁用用户账号

3. **权限管理**
   - 查看所有权限列表
   - 创建新权限项
   - 编辑权限描述
   - 启用/禁用特定权限

#### 4.2.2 权限配置示例

```javascript
// 角色权限配置示例
const rolePermissions = {
  // 系统管理员角色
  'Admin': [
    'system:*',          // 系统管理所有权限
    'user:*',            // 用户管理所有权限
    'product:*',         // 商品管理所有权限
    'order:*',           // 订单管理所有权限
    'content:*',         // 内容管理所有权限
    'marketing:*',       // 营销管理所有权限
    'report:*'           // 报表所有权限
  ],
  
  // 运营管理员角色
  'OperationAdmin': [
    'product:list:view',
    'product:detail:view',
    'product:basic:create',
    'product:basic:edit',
    'product:category:view',
    'product:category:edit',
    'order:list:view',
    'order:detail:view',
    'order:status:edit',
    'marketing:activity:create',
    'marketing:activity:edit',
    'report:operation:view'
  ]
  
  // 其他角色权限配置...
}
```

### 4.3 小程序端权限配置

#### 4.3.1 用户组配置

在后台管理系统中配置不同用户组及其对应的权限和权益。

#### 4.3.2 权限检查机制

小程序端实现权限检查逻辑，控制用户对特定功能和内容的访问：

```javascript
// 小程序端权限检查示例
function checkPermission(userId, permissionCode) {
  return new Promise((resolve, reject) => {
    wx.request({
      url: `${API_BASE_URL}/api/auth/check-permission`,
      method: 'POST',
      data: {
        userId,
        permissionCode
      },
      success: (res) => {
        resolve(res.data.hasPermission);
      },
      fail: (err) => {
        reject(err);
      }
    });
  });
}
```

## 5. 微信授权管理

### 5.1 小程序授权类型

#### 5.1.1 基本授权

- **用户信息授权**：获取用户公开信息，如昵称、头像等
- **手机号授权**：获取用户手机号（需用户确认）
- **位置授权**：获取用户地理位置信息

#### 5.1.2 高级授权

- **相册授权**：访问用户相册
- **相机授权**：使用用户相机
- **通知授权**：发送订阅消息给用户

### 5.2 授权请求流程

#### 5.2.1 授权请求代码示例

```javascript
// 请求用户信息授权
wx.getUserProfile({
  desc: '用于完善会员资料',
  success: (res) => {
    // 处理用户信息
    const userInfo = res.userInfo;
    // 更新用户数据
    updateUserProfile(userInfo);
  },
  fail: (err) => {
    console.error('授权失败:', err);
    // 显示友好提示
    wx.showToast({
      title: '获取用户信息失败',
      icon: 'none'
    });
  }
});

// 请求位置授权
wx.getLocation({
  type: 'gcj02',
  success: (res) => {
    // 处理位置信息
    const { latitude, longitude } = res;
    // 使用位置信息
    useLocation(latitude, longitude);
  },
  fail: (err) => {
    console.error('位置授权失败:', err);
    // 引导用户开启权限
    wx.showModal({
      title: '提示',
      content: '需要您的位置权限才能使用此功能',
      success: (res) => {
        if (res.confirm) {
          // 打开设置页面
          wx.openSetting();
        }
      }
    });
  }
});
```

### 5.3 授权管理最佳实践

1. **请求授权时机**：仅在必要时请求授权，避免过度授权
2. **授权说明**：提供清晰的授权目的说明
3. **授权失败处理**：优雅处理授权失败情况，提供明确引导
4. **权限状态检查**：定期检查权限状态，根据状态调整功能
5. **隐私保护**：严格遵守隐私政策，合理使用获取的信息

## 6. API访问权限控制

### 6.1 API权限认证机制

#### 6.1.1 Token认证

- 使用JWT（JSON Web Token）进行身份验证
- Token包含用户信息和权限信息
- 设置合理的Token过期时间
- 实现Token刷新机制

#### 6.1.2 API请求签名

- 对API请求参数进行签名验证
- 防止请求被篡改
- 结合时间戳防止重放攻击

### 6.2 API权限中间件

在服务端实现权限检查中间件：

```javascript
// API权限中间件示例
function permissionMiddleware(requiredPermission) {
  return async (req, res, next) => {
    try {
      // 验证Token
      const token = req.headers.authorization?.split(' ')[1];
      if (!token) {
        return res.status(401).json({ error: '未授权访问' });
      }
      
      // 解析Token获取用户信息
      const decoded = jwt.verify(token, SECRET_KEY);
      req.user = decoded;
      
      // 检查权限
      const hasPermission = await checkUserPermission(
        req.user.userId,
        requiredPermission
      );
      
      if (!hasPermission) {
        return res.status(403).json({ error: '权限不足' });
      }
      
      next();
    } catch (error) {
      if (error.name === 'TokenExpiredError') {
        return res.status(401).json({ error: 'Token已过期' });
      }
      return res.status(401).json({ error: '无效的Token' });
    }
  };
}
```

### 6.3 API请求限流

实现API请求限流，防止恶意请求：

```javascript
// API限流中间件示例
function rateLimitMiddleware(options = {}) {
  const { 
    maxRequests = 100, 
    windowMs = 15 * 60 * 1000, 
    message = '请求过于频繁，请稍后再试'
  } = options;
  
  // 使用内存存储请求计数（生产环境建议使用Redis等）
  const requestCounts = new Map();
  
  return (req, res, next) => {
    const ip = req.ip;
    const currentTime = Date.now();
    
    if (!requestCounts.has(ip)) {
      requestCounts.set(ip, []);
    }
    
    const timestamps = requestCounts.get(ip);
    
    // 移除过期的时间戳
    while (timestamps.length > 0 && currentTime - timestamps[0] > windowMs) {
      timestamps.shift();
    }
    
    // 检查是否超过限制
    if (timestamps.length >= maxRequests) {
      return res.status(429).json({ error: message });
    }
    
    // 记录本次请求时间
    timestamps.push(currentTime);
    requestCounts.set(ip, timestamps);
    
    next();
  };
}
```

## 7. 数据安全与访问控制

### 7.1 数据访问权限控制

#### 7.1.1 行级权限

控制用户只能访问特定的数据行：

```javascript
// 行级权限过滤示例
function applyRowLevelPermission(userId, role, query) {
  // 系统管理员可以访问所有数据
  if (role === 'Admin') {
    return query;
  }
  
  // 运营管理员可以访问所有订单，但可能有其他限制
  if (role === 'OperationAdmin') {
    // 可以在这里添加额外的过滤条件
    return query;
  }
  
  // 普通用户只能访问自己的数据
  return query.where('userId', userId);
}
```

#### 7.1.2 字段级权限

控制用户只能访问数据的特定字段：

```javascript
// 字段级权限过滤示例
function applyFieldLevelPermission(role, data, allowedFields) {
  const result = {};
  
  // 根据角色过滤字段
  allowedFields.forEach(field => {
    if (data.hasOwnProperty(field)) {
      result[field] = data[field];
    }
  });
  
  return result;
}
```

### 7.2 敏感数据处理

#### 7.2.1 数据脱敏

对敏感数据进行脱敏处理：

```javascript
// 数据脱敏示例
function maskSensitiveData(data, role) {
  // 只有特定角色可以查看完整敏感信息
  const canViewFullData = ['Admin', 'OperationAdmin'].includes(role);
  
  if (!canViewFullData) {
    // 脱敏手机号
    if (data.phone) {
      data.phone = data.phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
    }
    
    // 脱敏身份证号
    if (data.idCard) {
      data.idCard = data.idCard.replace(/(\d{6})\d{8}(\w{4})/, '$1********$2');
    }
    
    // 脱敏银行卡号
    if (data.bankCard) {
      data.bankCard = data.bankCard.replace(/(\d{4})\d+(\d{4})/, '$1 **** **** $2');
    }
  }
  
  return data;
}
```

### 7.3 数据加密存储

敏感数据加密存储策略：

1. **传输加密**：使用HTTPS协议确保数据传输安全
2. **存储加密**：对敏感字段进行加密后存储
3. **密钥管理**：使用安全的密钥管理机制
4. **定期轮换**：定期更换加密密钥

## 8. 权限审计与日志

### 8.1 权限操作日志

记录所有权限相关的操作，便于审计和问题排查：

```javascript
// 权限操作日志记录示例
function logPermissionOperation(userId, userName, operation, resource, result) {
  const logEntry = {
    timestamp: new Date(),
    userId,
    userName,
    operation,         // 操作类型：create_role, assign_permission等
    resource,          // 操作资源：role_id, permission_id等
    result,            // 操作结果：success, failed
    ipAddress: getClientIp(),
    userAgent: getClientUserAgent()
  };
  
  // 保存日志到数据库
  saveToLogDatabase(logEntry);
  
  // 重要操作可以发送通知
  if (isImportantOperation(operation)) {
    sendSecurityNotification(logEntry);
  }
}
```

### 8.2 异常访问监控

监控异常的权限访问模式：

1. **权限提升尝试**：尝试访问未授权的资源
2. **暴力破解**：频繁的权限验证失败
3. **异常时间访问**：非工作时间的敏感操作
4. **异常地点访问**：从未使用过的位置登录

### 8.3 审计报告

生成定期的权限审计报告：

- 权限变更记录
- 异常访问统计
- 权限使用情况分析
- 潜在的安全风险提示

## 9. 权限管理最佳实践

### 9.1 权限设计原则

1. **最小权限原则**：用户只能获得完成其工作所需的最小权限
2. **职责分离原则**：敏感操作需要多个角色协作完成
3. **权限继承原则**：合理使用权限继承简化管理
4. **权限定期审查**：定期审查和更新权限配置
5. **权限过期机制**：临时权限应设置自动过期时间

### 9.2 安全注意事项

1. **密码安全**：强制使用强密码，定期更换
2. **多因素认证**：对管理员账号启用多因素认证
3. **会话管理**：合理设置会话超时，防止会话劫持
4. **安全日志**：记录所有关键操作，定期检查
5. **防止越权**：在客户端和服务端都进行权限验证

### 9.3 常见问题与解决方案

#### 9.3.1 权限冲突

**问题**：用户拥有多个角色，权限出现冲突

**解决方案**：
- 明确权限优先级规则
- 采用权限合并策略（如并集或交集）
- 为特殊情况创建复合角色

#### 9.3.2 权限蔓延

**问题**：随着时间推移，用户积累了过多不必要的权限

**解决方案**：
- 实施定期权限审查机制
- 建立权限过期制度
- 实施权限自动回收

#### 9.3.3 权限验证性能

**问题**：频繁的权限验证影响系统性能

**解决方案**：
- 实现权限缓存机制
- 批量权限验证
- 优化权限数据结构

## 10. 附录

### 10.1 权限代码参考

| 模块 | 资源 | 操作 | 权限代码 | 描述 |
|------|------|------|----------|------|
| user | profile | view | user:profile:view | 查看用户资料 |
| user | profile | edit | user:profile:edit | 编辑用户资料 |
| user | address | create | user:address:create | 创建收货地址 |
| user | address | edit | user:address:edit | 编辑收货地址 |
| product | list | view | product:list:view | 查看商品列表 |
| product | detail | view | product:detail:view | 查看商品详情 |
| product | basic | create | product:basic:create | 创建商品基本信息 |
| product | basic | edit | product:basic:edit | 编辑商品基本信息 |
| order | list | view | order:list:view | 查看订单列表 |
| order | detail | view | order:detail:view | 查看订单详情 |
| order | status | edit | order:status:edit | 修改订单状态 |
| system | setting | view | system:setting:view | 查看系统设置 |
| system | setting | edit | system:setting:edit | 编辑系统设置 |

### 10.2 相关文档与参考

- [微信小程序用户信息授权](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/wx.getUserProfile.html)
- [微信小程序位置授权](https://developers.weixin.qq.com/miniprogram/dev/api/location/wx.getLocation.html)
- [RBAC模型官方文档](https://csrc.nist.gov/Projects/Role-Based-Access-Control)
- [JWT认证最佳实践](https://auth0.com/blog/a-look-at-the-latest-draft-for-jwt-bcp/)
- [API安全设计指南](https://cheatsheetseries.owasp.org/cheatsheets/API_Security_Cheat_Sheet.html)

---

**版本号：1.0.0**
*最后更新时间：2025-11-24*
