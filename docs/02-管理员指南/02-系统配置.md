<!--
文件名: 02-系统配置.md
版本号: 1.0.0
更新日期: 2025-11-24
作者: Sut
描述: 系统配置指南，详细说明小程序的各项配置参数、数据库设置和安全选项
-->
# 系统配置指南

**版本号：1.0.0**
*最后更新时间：2025-11-24*

## 1. 概述

本文档详细说明SutWxApp微信小程序项目的系统配置，包括项目配置文件结构、关键配置项、环境配置、API配置以及各种功能模块的配置说明，为系统管理员提供全面的配置参考。

### 1.1 文档目的

- 提供完整的系统配置说明
- 指导管理员正确配置系统参数
- 确保系统正常运行和性能优化
- 便于系统维护和问题排查

### 1.2 适用范围

本文档适用于SutWxApp微信小程序项目的开发环境、测试环境和生产环境的系统配置管理。

## 2. 微信小程序基础配置

### 2.1 项目配置文件结构

SutWxApp项目的主要配置文件包括：

```
SutWxApp/
├── app.json          # 全局配置文件
├── project.config.json  # 项目配置文件
├── sitemap.json      # 小程序索引配置文件
└── .env.*            # 环境变量配置文件
```

### 2.2 app.json 全局配置

`app.json`是小程序的全局配置文件，包含了小程序的页面路径、全局样式、窗口背景色、导航栏样式等配置。

#### 2.2.1 主要配置项说明

```json
{
  "pages": [
    "pages/index/index",
    "pages/category/category",
    "pages/cart/cart",
    "pages/user/user",
    "pages/product/product",
    "pages/order/order",
    "pages/checkout/checkout"
  ],
  "window": {
    "backgroundTextStyle": "light",
    "navigationBarBackgroundColor": "#fff",
    "navigationBarTitleText": "SutWxApp",
    "navigationBarTextStyle": "black"
  },
  "tabBar": {
    "color": "#999",
    "selectedColor": "#1989fa",
    "backgroundColor": "#fff",
    "list": [
      {
        "pagePath": "pages/index/index",
        "text": "首页",
        "iconPath": "images/tabbar/home.png",
        "selectedIconPath": "images/tabbar/home_active.png"
      },
      {
        "pagePath": "pages/category/category",
        "text": "分类",
        "iconPath": "images/tabbar/category.png",
        "selectedIconPath": "images/tabbar/category_active.png"
      },
      {
        "pagePath": "pages/cart/cart",
        "text": "购物车",
        "iconPath": "images/tabbar/cart.png",
        "selectedIconPath": "images/tabbar/cart_active.png"
      },
      {
        "pagePath": "pages/user/user",
        "text": "我的",
        "iconPath": "images/tabbar/user.png",
        "selectedIconPath": "images/tabbar/user_active.png"
      }
    ]
  },
  "networkTimeout": {
    "request": 10000,
    "downloadFile": 60000
  },
  "debug": false,
  "subpackages": [],
  "workers": "workers",
  "requiredPrivateInfos": ["getLocation"]
}
```

#### 2.2.2 关键配置项说明

- **pages**: 定义小程序的页面路径，第一个页面为首页
- **window**: 设置导航栏和窗口背景色等样式
- **tabBar**: 定义底部标签栏的样式和页面
- **networkTimeout**: 设置网络请求超时时间
- **debug**: 是否开启调试模式
- **subpackages**: 分包加载配置
- **workers**: Worker代码目录
- **requiredPrivateInfos**: 需要申请的私有接口权限

### 2.3 project.config.json 项目配置

`project.config.json`文件包含了小程序项目的各种配置，如项目名称、appid、编译配置等。

#### 2.3.1 主要配置项说明

```json
{
  "description": "SutWxApp项目配置",
  "packOptions": {
    "ignore": []
  },
  "setting": {
    "urlCheck": true,
    "es6": true,
    "enhance": true,
    "postcss": true,
    "preloadBackgroundData": false,
    "minified": true,
    "newFeature": true,
    "coverView": true,
    "nodeModules": false,
    "autoAudits": false,
    "showShadowRootInWxmlPanel": true,
    "uglifyFileName": true,
    "checkInvalidKey": true,
    "checkSiteMap": true,
    "uploadWithSourceMap": true,
    "compileHotReLoad": false,
    "lazyloadPlaceholderEnable": false,
    "useMultiFrameRuntime": true,
    "useApiHook": true,
    "useApiHostProcess": true,
    "showShadowRootInWxmlPanel": true,
    "babelSetting": {
      "ignore": [],
      "disablePlugins": [],
      "outputPath": ""
    }
  },
  "compileType": "miniprogram",
  "libVersion": "2.28.1",
  "appid": "wx1234567890abcdef",
  "projectname": "SutWxApp",
  "debugOptions": {
    "hidedInDevtools": []
  },
  "isGameTourist": false,
  "simulatorType": "wechat",
  "simulatorPluginLibVersion": {},
  "condition": {
    "search": {
      "list": []
    },
    "conversation": {
      "list": []
    },
    "game": {
      "list": []
    },
    "miniprogram": {
      "list": []
    }
  }
}
```

#### 2.3.2 关键配置项说明

- **description**: 项目描述
- **setting**: 编辑器设置，包含ES6转译、压缩等选项
- **compileType**: 编译类型，小程序为"miniprogram"
- **libVersion**: 基础库版本
- **appid**: 小程序的appid
- **projectname**: 项目名称
- **condition**: 编译模式条件配置

### 2.4 sitemap.json 索引配置

`sitemap.json`用于配置小程序及其页面是否允许被微信索引。

```json
{
  "rules": [
    {
      "action": "allow",
      "page": "*"
    }
  ]
}
```

#### 2.4.1 配置说明

- **rules**: 索引规则数组
- **action**: 允许或拒绝索引，值为"allow"或"disallow"
- **page**: 页面路径，"*"表示所有页面

## 3. 环境配置

### 3.1 环境变量配置

项目使用`.env`系列文件管理不同环境的配置变量，详见《环境搭建指南》中的环境变量配置部分。

### 3.2 多环境配置策略

#### 3.2.1 开发环境

```javascript
// config/dev.js
module.exports = {
  api: {
    baseUrl: 'http://dev-api.example.com',
    timeout: 10000
  },
  debug: true,
  enableMock: true,
  logLevel: 'debug'
}
```

#### 3.2.2 测试环境

```javascript
// config/test.js
module.exports = {
  api: {
    baseUrl: 'http://test-api.example.com',
    timeout: 10000
  },
  debug: false,
  enableMock: false,
  logLevel: 'info'
}
```

#### 3.2.3 生产环境

```javascript
// config/prod.js
module.exports = {
  api: {
    baseUrl: 'https://api.example.com',
    timeout: 15000
  },
  debug: false,
  enableMock: false,
  logLevel: 'error'
}
```

### 3.3 环境切换机制

项目根据NODE_ENV环境变量自动切换配置：

```javascript
// config/index.js
const env = process.env.NODE_ENV || 'development'
const config = require(`./${env}`)

module.exports = config
```

## 4. 功能模块配置

### 4.1 API配置

#### 4.1.1 接口域名配置

在微信公众平台设置中配置合法域名：

- **request合法域名**：配置后端API服务域名
- **uploadFile合法域名**：配置文件上传服务域名
- **downloadFile合法域名**：配置文件下载服务域名
- **socket合法域名**：配置WebSocket服务域名

#### 4.1.2 API请求配置

```javascript
// services/api.js
import config from '../config'

const API_CONFIG = {
  // 基础URL
  baseURL: config.api.baseUrl,
  // 请求超时时间
  timeout: config.api.timeout,
  // 请求头配置
  headers: {
    'Content-Type': 'application/json'
  },
  // 是否携带Cookie
  withCredentials: true
}

export default API_CONFIG
```

### 4.2 数据存储配置

#### 4.2.1 本地存储配置

```javascript
// utils/storage.js
const STORAGE_CONFIG = {
  // 存储前缀，用于隔离不同环境
  prefix: process.env.NODE_ENV ? `${process.env.NODE_ENV}_` : '',
  // 存储过期时间（毫秒）
  expireTime: {
    // 用户信息存储7天
    USER_INFO: 7 * 24 * 60 * 60 * 1000,
    // 购物车数据存储30天
    CART_DATA: 30 * 24 * 60 * 60 * 1000,
    // 临时数据存储24小时
    TEMP_DATA: 24 * 60 * 60 * 1000
  }
}

export default STORAGE_CONFIG
```

### 4.3 支付配置

#### 4.3.1 微信支付配置

```javascript
// config/pay.js
const PAY_CONFIG = {
  // 支付签名算法
  signType: 'MD5',
  // 退款通知URL
  refundNotifyUrl: `${config.api.baseUrl}/api/pay/refund-notify`,
  // 支付成功通知URL
  payNotifyUrl: `${config.api.baseUrl}/api/pay/notify`,
  // 证书路径（服务端配置）
  certPath: '',
  // 密钥路径（服务端配置）
  keyPath: ''
}

export default PAY_CONFIG
```

### 4.4 日志配置

#### 4.4.1 日志级别配置

```javascript
// config/log.js
const LOG_LEVELS = {
  debug: 0,
  info: 1,
  warn: 2,
  error: 3,
  fatal: 4
}

const LOG_CONFIG = {
  // 当前日志级别
  level: LOG_LEVELS[config.logLevel] || LOG_LEVELS.info,
  // 是否打印到控制台
  console: config.debug,
  // 是否上报到服务器
  report: !config.debug,
  // 上报间隔（毫秒）
  reportInterval: 30000,
  // 最大日志条数
  maxLogCount: 100
}

export default LOG_CONFIG
```

## 5. 安全配置

### 5.1 内容安全检测配置

```javascript
// config/security.js
const SECURITY_CONFIG = {
  // 内容安全检测API配置
  contentCheck: {
    // 是否启用
    enable: true,
    // 检测类型：text/image/all
    checkType: 'all',
    // 检测延迟（毫秒），用于输入完成后检测
    checkDelay: 500
  },
  // 接口请求安全配置
  apiSecurity: {
    // 是否验证请求签名
    verifySign: true,
    // 是否验证请求时间戳
    verifyTimestamp: true,
    // 时间戳有效期（秒）
    timestampExpire: 300
  }
}

export default SECURITY_CONFIG
```

### 5.2 数据脱敏配置

```javascript
// config/mask.js
const MASK_CONFIG = {
  // 手机号脱敏规则
  phone: {
    // 保留前三位和后四位
    regex: /(\d{3})\d{4}(\d{4})/g,
    replace: '$1****$2'
  },
  // 身份证号脱敏规则
  idCard: {
    // 保留前六位和后四位
    regex: /(\d{6})\d{8}(\w{4})/g,
    replace: '$1********$2'
  },
  // 银行卡号脱敏规则
  bankCard: {
    // 保留前四位和后四位
    regex: /(\d{4})\d+(\d{4})/g,
    replace: '$1 **** **** $2'
  }
}

export default MASK_CONFIG
```

## 6. 性能优化配置

### 6.1 图片资源配置

```javascript
// config/image.js
const IMAGE_CONFIG = {
  // 图片压缩质量（0-1）
  quality: 0.8,
  // 默认图片尺寸
  defaultSize: {
    thumbnail: '100x100',
    small: '200x200',
    medium: '400x400',
    large: '800x800'
  },
  // 是否启用WebP格式
  enableWebP: true,
  // 预加载图片列表
  preloadImages: [
    '/images/common/loading.png',
    '/images/common/empty.png'
  ]
}

export default IMAGE_CONFIG
```

### 6.2 分包加载配置

```javascript
// 配置分包加载，在app.json中添加
{
  "subpackages": [
    {
      "root": "pages/subpackage1",
      "pages": ["page1", "page2"]
    },
    {
      "root": "pages/subpackage2",
      "pages": ["page1", "page2"]
    }
  ]
}
```

## 7. 配置管理最佳实践

### 7.1 配置文件管理原则

1. **集中管理**：将所有配置集中到专门的config目录
2. **环境分离**：为不同环境创建独立的配置文件
3. **安全存储**：敏感配置使用环境变量或密钥管理系统
4. **版本控制**：配置文件纳入版本控制，但排除包含敏感信息的文件

### 7.2 配置修改流程

1. **评估影响**：修改配置前评估对系统的影响
2. **备份配置**：修改前备份当前配置
3. **测试验证**：在测试环境验证配置修改
4. **灰度发布**：重要配置修改采用灰度发布策略
5. **监控观察**：配置修改后密切监控系统运行状态

## 8. 常见配置问题与解决方案

### 8.1 API域名配置问题

**问题**：小程序无法调用API，提示域名不在白名单中

**解决方案**：
1. 登录微信公众平台，进入"开发"->"开发设置"
2. 在"服务器域名"中添加API域名
3. 等待配置生效（通常需要5-10分钟）
4. 在开发环境可以开启"不校验请求域名"选项进行调试

### 8.2 配置文件权限问题

**问题**：无法读取或修改配置文件

**解决方案**：
1. 检查文件权限设置
2. 确认当前用户有读写权限
3. 以管理员权限运行开发工具

### 8.3 多环境配置冲突

**问题**：不同环境的配置混淆

**解决方案**：
1. 确保NODE_ENV环境变量正确设置
2. 检查配置文件加载顺序
3. 使用环境前缀区分本地存储键名

## 9. 附录

### 9.1 配置项索引

| 配置文件 | 主要功能 | 位置 |
|---------|---------|------|
| app.json | 全局页面和样式配置 | 项目根目录 |
| project.config.json | 项目设置配置 | 项目根目录 |
| sitemap.json | 索引配置 | 项目根目录 |
| .env.* | 环境变量配置 | 项目根目录 |
| config/index.js | 配置入口 | config目录 |
| config/api.js | API配置 | config目录 |
| config/security.js | 安全配置 | config目录 |
| config/image.js | 图片资源配置 | config目录 |

### 9.2 微信配置相关链接

- [微信小程序全局配置](https://developers.weixin.qq.com/miniprogram/dev/reference/configuration/app.html)
- [微信小程序页面配置](https://developers.weixin.qq.com/miniprogram/dev/reference/configuration/page.html)
- [微信小程序项目配置](https://developers.weixin.qq.com/miniprogram/dev/devtools/projectconfig.html)
- [微信小程序网络请求配置](https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html)

---

**版本号：1.0.0**
*最后更新时间：2025-11-24*
