# 架构设计文档

<!--
文件名: 02-架构设计文档.md
版本号: 1.0.0
更新日期: 2025-11-30
作者: Sut
描述: 系统架构设计和组件关系
-->

## 目录

[TOC]

## 1. 概述

### 1.1 文档目的

本文档旨在介绍SutWxApp项目的系统架构设计和组件关系，帮助开发者理解系统的整体结构和工作原理。

### 1.2 架构原则

- 前后端分离：前端和后端完全分离，通过API进行通信
- 微服务架构：系统拆分为多个独立的微服务
- 高可用性：确保系统能够持续稳定运行
- 可扩展性：支持横向扩展，满足业务增长需求
- 安全性：确保系统数据和用户信息的安全
- 可维护性：代码结构清晰，易于维护和扩展

## 2. 系统架构图

```
┌───────────────────────────────────────────────────────────────────────┐
│                              客户端层                                  │
├─────────────────┬─────────────────┬─────────────────┬─────────────────┤
│  微信小程序     │  Web管理后台    │  移动端App      │  第三方系统     │
└─────────────────┴─────────────────┴─────────────────┴─────────────────┘
                              │
┌────────────────────────────┼──────────────────────────────────────────┐
│                              网关层                                   │
└────────────────────────────┼──────────────────────────────────────────┘
                              │
┌────────────────────────────┼──────────────────────────────────────────┐
│                              API层                                    │
├─────────────────┬─────────────────┬─────────────────┬─────────────────┤
│  用户服务API    │  商品服务API    │  订单服务API    │  支付服务API    │
└─────────────────┴─────────────────┴─────────────────┴─────────────────┘
                              │
┌────────────────────────────┼──────────────────────────────────────────┐
│                              服务层                                   │
├─────────────────┬─────────────────┬─────────────────┬─────────────────┤
│  用户服务       │  商品服务       │  订单服务       │  支付服务       │
└─────────────────┴─────────────────┴─────────────────┴─────────────────┘
                              │
┌────────────────────────────┼──────────────────────────────────────────┐
│                              数据层                                   │
├─────────────────┬─────────────────┬─────────────────┬─────────────────┤
│  MySQL数据库    │  Redis缓存      │  MongoDB        │  文件存储       │
└─────────────────┴─────────────────┴─────────────────┴─────────────────┘
```

## 3. 架构分层

### 3.1 客户端层

客户端层包括以下客户端：

- **微信小程序**：面向普通用户的主要客户端，提供商品浏览、下单、支付等功能
- **Web管理后台**：面向管理员的管理平台，提供商品管理、订单管理、用户管理等功能
- **移动端App**：面向高级用户的移动端应用，提供更丰富的功能
- **第三方系统**：与其他系统集成，实现数据共享和业务协同

### 3.2 网关层

网关层负责：

- 请求路由：将请求路由到相应的API服务
- 负载均衡：将请求均匀分配到多个服务实例
- 认证授权：验证请求的合法性和权限
- 限流熔断：防止系统过载，保护系统稳定
- 日志监控：记录请求日志，便于监控和调试

### 3.3 API层

API层提供对外的API接口，包括：

- **用户服务API**：提供用户注册、登录、信息管理等接口
- **商品服务API**：提供商品查询、分类、详情等接口
- **订单服务API**：提供订单创建、查询、支付等接口
- **支付服务API**：提供支付接口，对接微信支付等第三方支付平台

### 3.4 服务层

服务层实现业务逻辑，包括：

- **用户服务**：处理用户相关业务逻辑
- **商品服务**：处理商品相关业务逻辑
- **订单服务**：处理订单相关业务逻辑
- **支付服务**：处理支付相关业务逻辑

### 3.5 数据层

数据层负责数据存储和管理，包括：

- **MySQL数据库**：存储结构化数据，如用户信息、商品信息、订单信息等
- **Redis缓存**：存储热点数据，提高系统性能
- **MongoDB**：存储非结构化数据，如日志、评论等
- **文件存储**：存储图片、视频等文件资源

## 4. 核心组件

### 4.1 用户服务

**功能**：
- 用户注册、登录、登出
- 用户信息管理
- 权限管理
- 角色管理

**技术栈**：
- Node.js + Express
- JWT认证
- Redis缓存

### 4.2 商品服务

**功能**：
- 商品分类管理
- 商品信息管理
- 商品搜索
- 商品推荐

**技术栈**：
- Node.js + Express
- Elasticsearch（搜索）
- Redis缓存

### 4.3 订单服务

**功能**：
- 订单创建
- 订单查询
- 订单状态管理
- 订单统计

**技术栈**：
- Node.js + Express
- MySQL数据库
- Redis缓存

### 4.4 支付服务

**功能**：
- 支付接口对接
- 支付状态查询
- 退款处理
- 支付统计

**技术栈**：
- Node.js + Express
- 微信支付API
- 支付宝API

## 5. 技术栈

### 5.1 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| 微信小程序框架 | 最新 | 微信小程序开发 |
| Vue.js | 3.x | Web管理后台开发 |
| UniApp | 最新 | 跨平台移动端开发 |
| Axios | 0.27.x | HTTP请求库 |
| Vuex | 4.x | 状态管理 |
| Vue Router | 4.x | 路由管理 |

### 5.2 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Node.js | 16.x | 后端开发语言 |
| Express | 4.x | Web框架 |
| MySQL | 8.x | 关系型数据库 |
| Redis | 6.x | 缓存数据库 |
| MongoDB | 5.x | 非关系型数据库 |
| Sequelize | 6.x | ORM框架 |
| JWT | 8.x | 认证授权 |
| Socket.io | 4.x | 实时通信 |

## 6. 数据流

### 6.1 用户登录流程

1. 用户在微信小程序中点击登录按钮
2. 微信小程序调用微信登录API，获取code
3. 微信小程序将code发送到后端API
4. 后端API调用微信服务器，获取openid和session_key
5. 后端API生成JWT token，返回给微信小程序
6. 微信小程序存储token，用于后续请求

### 6.2 商品浏览流程

1. 用户在微信小程序中浏览商品
2. 微信小程序调用商品服务API，获取商品列表
3. 商品服务API调用商品服务，获取商品数据
4. 商品服务从Redis缓存中获取商品数据，如果缓存不存在，则从MySQL数据库中获取
5. 商品服务将商品数据返回给商品服务API
6. 商品服务API将商品数据返回给微信小程序
7. 微信小程序展示商品列表

### 6.3 订单创建流程

1. 用户在微信小程序中选择商品，点击下单按钮
2. 微信小程序调用订单服务API，创建订单
3. 订单服务API调用订单服务，创建订单
4. 订单服务检查商品库存，扣减库存
5. 订单服务创建订单记录，保存到MySQL数据库
6. 订单服务返回订单信息给订单服务API
7. 订单服务API返回订单信息给微信小程序
8. 微信小程序调用支付服务API，发起支付
9. 支付服务API调用支付服务，处理支付请求
10. 支付服务调用微信支付API，发起支付
11. 微信支付返回支付链接给支付服务
12. 支付服务返回支付链接给支付服务API
13. 支付服务API返回支付链接给微信小程序
14. 微信小程序调起微信支付，完成支付
15. 微信支付回调支付服务，通知支付结果
16. 支付服务更新订单状态，通知订单服务
17. 订单服务更新订单状态，保存到MySQL数据库

## 7. 部署架构

### 7.1 开发环境

- 本地开发环境：开发者本地机器
- 开发服务器：用于集成测试和联调

### 7.2 测试环境

- 测试服务器：用于功能测试和性能测试
- 测试数据库：独立的测试数据库
- 测试缓存：独立的测试缓存

### 7.3 生产环境

- 多台应用服务器：采用负载均衡
- 主从数据库：确保数据安全和高可用性
- 分布式缓存：提高系统性能
- CDN：加速静态资源访问
- 监控系统：实时监控系统运行状态

## 8. 安全架构

### 8.1 认证授权

- 使用JWT进行认证
- 基于角色的权限控制（RBAC）
- 细粒度的权限管理

### 8.2 数据安全

- 数据加密：敏感数据加密存储
- 数据备份：定期备份数据
- 数据恢复：支持数据恢复

### 8.3 网络安全

- HTTPS：所有请求使用HTTPS
- 防火墙：配置防火墙规则
- 入侵检测：实时检测入侵行为

### 8.4 代码安全

- 代码审查：所有代码提交前进行代码审查
- 漏洞扫描：定期进行漏洞扫描
- 安全测试：进行安全测试

## 9. 相关链接

- [开发环境配置.md](./01-开发环境配置.md)
- [API接口文档.md](./03-API接口文档.md)
- [技术设计文档.md](./06-技术设计文档.md)
