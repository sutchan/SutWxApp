<!--
文件名: 10-代码规范.md
版本号: 1.0.0
更新日期: 2025-11-24
作者: Sut
描述: 代码规范文档，定义小程序开发的编码标准、命名约定和最佳实践
-->
# SutWxApp 代码规范

## 1. 引言

本文档规定了 SutWxApp 微信小程序项目的代码规范，旨在确保代码的可读性、可维护性和一致性。所有参与项目开发的人员都应当严格遵守本规范。

## 2. 基础规范

### 2.1 编码格式

- **文件编码**：UTF-8 无 BOM 格式
- **换行符**：Unix LF (`\n`)
- **缩进**：使用 2 个空格进行缩进，禁止使用制表符
- **行尾**：文件末尾必须添加空行
- **行长度**：每行代码不超过 100 个字符

### 2.2 命名规范

#### 2.2.1 文件命名

- **页面文件**：使用小驼峰命名法，如 `userInfo.js`
- **组件文件**：使用小驼峰命名法，如 `lazyImage.js`
- **服务文件**：使用小驼峰命名法，如 `userService.js`
- **测试文件**：使用小驼峰命名法，后缀为 `.test.js`，如 `userInfo.test.js`
- **配置文件**：使用小驼峰命名法，如 `configService.js`

#### 2.2.2 变量命名

- **变量名**：使用小驼峰命名法，如 `userName`
- **常量**：使用全大写字母，单词间用下划线分隔，如 `MAX_RETRY_COUNT`
- **布尔值**：使用 `is` 或 `has` 前缀，如 `isVisible`、`hasPermission`

#### 2.2.3 函数命名

- **函数名**：使用小驼峰命名法，如 `getUserInfo`
- **私有函数**：使用下划线前缀，如 `_privateMethod`
- **事件处理函数**：使用 `on` 前缀，如 `onClick`、`onSubmit`

#### 2.2.4 类命名

- **类名**：使用大驼峰命名法，如 `UserManager`
- **构造函数**：与类名相同，如 `function UserManager()`

### 2.3 注释规范

#### 2.3.1 文件头部注释

所有 JavaScript 文件必须包含文件头部注释，说明文件的功能、作者、创建日期等信息：

```javascript
/**
 * 文件名: 10-代码规范.md
 * 版本号: 1.0.0
 * 更新日期: 2025-11-24
 * 作者: Sut
 * 描述: 代码规范文档，定义小程序开发的编码标准、命名约定和最佳实践
 */
```

#### 2.3.2 函数注释

所有函数必须添加函数级注释，说明函数的用途、参数、返回值等信息：

```javascript
/**
 * 获取用户积分任务列表
 * @param {Object} options - 查询参数
 * @param {string} options.type - 任务类型：all/once/daily/weekly/monthly
 * @param {string} options.status - 任务状态：all/pending/completed/unclaimed
 * @param {number} options.page - 页码，默认为1
 * @param {number} options.pageSize - 每页数量，默认为20
 * @returns {Promise<Object>} 任务列表和分页信息
 */
async function getPointsTasks(options = {}) {
  // 实现逻辑
}
```

#### 2.3.3 行内注释

对于复杂的逻辑，应添加行内注释说明：

```javascript
// 循环处理所有用户数据
for (let i = 0; i < users.length; i++) {
  // 跳过未激活用户
  if (!users[i].active) continue;
  
  // 处理用户数据...
}
```

## 3. JavaScript 规范

### 3.1 变量声明

- 使用 `const` 声明常量，`let` 声明变量，禁止使用 `var`
- 每行只声明一个变量
- 变量在使用前必须先声明

```javascript
// 正确示例
const MAX_COUNT = 100;
let currentCount = 0;

// 错误示例
var oldVar = 0;
let a = 1, b = 2; // 避免在一行声明多个变量
```

### 3.2 函数定义

- 优先使用箭头函数（对于不需要 this 上下文的情况）
- 函数参数超过3个时，使用对象参数
- 避免函数体过长，复杂函数应拆分为多个小函数

```javascript
// 箭头函数示例
const handleClick = (event) => {
  // 处理点击事件
};

// 对象参数示例
function createUser({ name, age, email, address }) {
  // 创建用户
}
```

### 3.3 控制结构

- `if`, `else if`, `else`, `for`, `while` 等控制结构的代码块必须使用花括号包围
- 花括号与控制结构在同一行，右花括号独占一行
- 单行条件语句也应该使用花括号

```javascript
// 正确示例
if (condition) {
  // 代码块
} else {
  // 代码块
}

// 错误示例
if (condition) // 没有花括号
  doSomething();
```

### 3.4 对象和数组

- 使用字面量方式创建对象和数组
- 对象属性名如果不是合法标识符，需要使用引号
- 对象方法使用简洁语法

```javascript
// 对象字面量
const user = {
  name: '张三',
  age: 25,
  'user-name': 'zhangsan', // 非合法标识符需要引号
  getUserInfo() { // 简洁语法
    return `Name: ${this.name}, Age: ${this.age}`;
  }
};

// 数组字面量
const numbers = [1, 2, 3, 4, 5];
```

### 3.5 错误处理

- 使用 try/catch 捕获异常
- 明确指定捕获的异常类型
- 提供有意义的错误信息

```javascript
try {
  // 可能抛出异常的代码
} catch (error) {
  console.error('操作失败:', error.message);
  // 错误处理逻辑
}
```

## 4. WXML 规范

### 4.1 标签规范

- 所有标签必须正确关闭
- 组件标签使用连字符命名法，如 `<view class="container">`
- 避免使用过多的嵌套层级，最多不超过 5 层

### 4.2 属性规范

- 属性值必须使用双引号
- 布尔属性不需要赋值
- 自定义属性使用 `data-` 前缀

```html
<view class="container" data-id="123">
  <button disabled>禁用按钮</button>
</view>
```

### 4.3 模板和引用

- 模板名称使用小驼峰命名
- 使用 `<import>` 导入模板
- 使用 `<include>` 包含公共页面片段

```html
<!-- 导入模板 -->
<import src="../components/common-template.wxml"/>

<!-- 使用模板 -->
<template is="userCard" data="{{...user}}"/>
```

## 5. WXSS 规范

### 5.1 样式命名

- 使用 BEM 命名法（Block-Element-Modifier）
- 避免使用 ID 选择器
- 组件样式使用组件名作为前缀

```css
/* BEM 示例 */
.user-card { /* Block */}
.user-card__title { /* Element */}
.user-card--active { /* Modifier */}

/* 组件样式前缀 */
.product-list {}
.product-list__item {}
```

### 5.2 样式规则

- 每条样式规则单独一行
- 样式规则的花括号格式与 JavaScript 相同
- 颜色值使用十六进制或 RGB/RGBA
- 尺寸使用 rpx 单位（响应式像素）

```css
.container {
  width: 100%;
  padding: 20rpx;
  background-color: #f5f5f5;
  color: rgba(0, 0, 0, 0.85);
}
```

### 5.3 注释

- 使用 `/* */` 进行注释
- 为主要样式块添加注释说明

```css
/* 头部样式 */
.header {
  display: flex;
  align-items: center;
  /* 其他样式 */
}
```

## 6. JSON 配置规范

### 6.1 配置格式

- 使用 2 个空格缩进
- 键名使用双引号
- 键值对后不加逗号

```json
{
  "navigationBarTitleText": "首页",
  "navigationBarBackgroundColor": "#ffffff",
  "usingComponents": {
    "custom-component": "../components/custom-component"
  }
}
```

### 6.2 页面配置

- 页面配置文件中的配置项应精简，只包含必要的配置
- 通用配置放在 `app.json` 中

## 7. 组件开发规范

### 7.1 组件结构

- 组件文件应放在 `components` 目录下
- 每个组件应有自己的目录
- 组件目录名使用小驼峰命名

```
components/
  userCard/
    userCard.js
    userCard.wxml
    userCard.wxss
    userCard.json
  lazyImage/
    lazyImage.js
    lazyImage.wxml
    lazyImage.wxss
    lazyImage.json
```

### 7.2 组件接口

- 组件属性使用 `properties` 定义，明确类型和默认值
- 事件使用 `triggerEvent` 触发
- 组件方法放在 `methods` 中

```javascript
Component({
  properties: {
    userInfo: {
      type: Object,
      value: {}
    },
    showActions: {
      type: Boolean,
      value: true
    }
  },
  methods: {
    onUserClick() {
      this.triggerEvent('userclick', { userInfo: this.data.userInfo });
    }
  }
});
```

## 8. 服务层规范

### 8.1 API 调用

- 所有 API 调用封装在 `services` 目录下
- 使用 Promise 处理异步请求
- 添加请求超时处理
- 统一错误处理机制

```javascript
/**
 * 用户服务
 */
const request = require('../utils/request');

/**
 * 用户登录
 * @param {Object} loginData - 登录数据
 * @returns {Promise<Object>} 登录结果
 */
export async function login(loginData) {
  try {
    const response = await request.post('/api/user/login', loginData, {
      timeout: 30000
    });
    return response.data;
  } catch (error) {
    console.error('登录失败:', error);
    throw new Error(error.message || '登录失败，请重试');
  }
}
```

### 8.2 数据处理

- 服务层负责数据的获取和转换
- 避免在组件或页面中直接处理复杂的数据转换逻辑
- 提供数据缓存机制减少重复请求

## 9. 测试规范

### 9.1 测试文件

- 测试文件放在 `tests` 目录下
- 测试文件与被测试文件同名，后缀为 `.test.js`
- 使用 Jest 或其他测试框架

### 9.2 测试用例

- 为主要功能编写单元测试
- 测试用例应包含正常情况和异常情况
- 测试代码应简洁明了

```javascript
const { calculateTotalPrice } = require('../services/cartService');

test('计算购物车总价 - 正常情况', () => {
  const cartItems = [
    { price: 10, quantity: 2 },
    { price: 20, quantity: 1 }
  ];
  expect(calculateTotalPrice(cartItems)).toBe(40);
});

test('计算购物车总价 - 空数组', () => {
  expect(calculateTotalPrice([])).toBe(0);
});
```

## 10. 性能优化规范

### 10.1 资源优化

- 图片使用合适的格式和大小
- 使用 `lazy-image` 组件实现图片懒加载
- 避免不必要的网络请求

### 10.2 代码优化

- 使用 `const` 和 `let` 避免变量提升问题
- 减少闭包的使用，避免内存泄漏
- 合理使用缓存，避免重复计算

### 10.3 渲染优化

- 使用 `wx:if` 和 `wx:show` 合理控制渲染
- 避免在循环中进行复杂的计算
- 列表使用 `wx:key` 优化渲染性能

```html
<!-- 使用 wx:key 优化列表渲染 -->
<view wx:for="{{products}}" wx:key="id">
  {{item.name}}
</view>
```

## 11. 安全规范

### 11.1 数据安全

- 不在代码中硬编码敏感信息
- API 密钥和认证信息必须通过环境变量或配置文件管理
- 对用户输入进行验证和清洗

### 11.2 网络安全

- 所有网络请求使用 HTTPS
- 设置合理的请求超时
- 实现请求重试机制
- 避免暴露不必要的错误信息给用户

## 12. 版本控制规范

### 12.1 Git 规范

- 所有代码文件自动同步版本号
- 每次构建项目时，先清理工作区缓存文件
- 每次构建默认升级最小版本号，并写入版本历史文档

### 12.2 提交规范

- 提交信息应清晰描述变更内容
- 遵循 "类型: 描述" 的格式，如 "feat: 添加用户登录功能"
- 类型包括：
  - `feat`: 新功能
  - `fix`: 修复
  - `docs`: 文档
  - `style`: 样式
  - `refactor`: 重构
  - `test`: 测试
  - `chore`: 构建过程或辅助工具变动

## 13. 多语言支持规范

### 13.1 本地化文件

- 所有用户界面字符串必须添加到 `.pot` 文件中
- 同时修改 `.pot` 和 `.po` 的字符串，确保多语言字符串一致
- 只在 PHP/JS 文件中加入字符串，排除 `.md` `.txt` 等非代码文件

## 14. 代码审查规范

### 14.1 审查流程

- 所有代码提交前必须进行代码审查
- 出现文件待审查请求时，自动全部接受审查请求
- 审查内容包括：代码规范、功能实现、性能优化、安全性等

## 15. 总结

本规范旨在提高代码质量和开发效率，确保项目的可维护性和稳定性。所有开发者都应该严格遵守本规范，并在实践中不断完善和优化。

---

*本规范将根据项目发展和技术演进定期更新*
